/**
 * @license
 * PlayCanvas Engine v1.58.0 revision 6672f604c (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { Vec2 } from '../../core/math/vec2.js';
import { Vec4 } from '../../core/math/vec4.js';
import { RenderTarget } from '../../platform/graphics/render-target.js';
import { SHADOW_PCF3, LIGHTTYPE_SPOT, LIGHTTYPE_OMNI } from '../constants.js';
import { CookieRenderer } from '../renderer/cookie-renderer.js';
import { ShadowMap } from '../renderer/shadow-map.js';

const _tempArray = [];
const _tempArray2 = [];
const _viewport = new Vec4();
const _scissor = new Vec4();
class Slot {
  constructor(rect) {
    this.size = Math.floor(rect.w * 1024);
    this.used = false;
    this.lightId = -1;
    this.rect = rect;
  }
}

class LightTextureAtlas {
  constructor(device) {
    this.device = device;
    this.version = 1;

    this.shadowAtlasResolution = 2048;
    this.shadowAtlas = null;

    this.shadowEdgePixels = 3;
    this.cookieAtlasResolution = 2048;
    this.cookieAtlas = null;
    this.cookieRenderTarget = null;

    this.slots = [];

    this.atlasSplit = [];

    this.cubeSlotsOffsets = [new Vec2(0, 0), new Vec2(0, 1), new Vec2(1, 0), new Vec2(1, 1), new Vec2(2, 0), new Vec2(2, 1)];

    this.scissorVec = new Vec4();
    this.allocateShadowAtlas(1);
    this.allocateCookieAtlas(1);
    this.allocateUniforms();
  }
  destroy() {
    this.destroyShadowAtlas();
    this.destroyCookieAtlas();
  }
  destroyShadowAtlas() {
    if (this.shadowAtlas) {
      this.shadowAtlas.destroy();
      this.shadowAtlas = null;
    }
  }
  destroyCookieAtlas() {
    if (this.cookieAtlas) {
      this.cookieAtlas.destroy();
      this.cookieAtlas = null;
    }
    if (this.cookieRenderTarget) {
      this.cookieRenderTarget.destroy();
      this.cookieRenderTarget = null;
    }
  }
  allocateShadowAtlas(resolution) {
    if (!this.shadowAtlas || this.shadowAtlas.texture.width !== resolution) {
      this.version++;
      this.destroyShadowAtlas();
      this.shadowAtlas = ShadowMap.createAtlas(this.device, resolution, SHADOW_PCF3);

      this.shadowAtlas.cached = true;

      const scissorOffset = 4 / this.shadowAtlasResolution;
      this.scissorVec.set(scissorOffset, scissorOffset, -2 * scissorOffset, -2 * scissorOffset);
    }
  }
  allocateCookieAtlas(resolution) {
    if (!this.cookieAtlas || this.cookieAtlas.width !== resolution) {
      this.version++;
      this.destroyCookieAtlas();
      this.cookieAtlas = CookieRenderer.createTexture(this.device, resolution);
      this.cookieRenderTarget = new RenderTarget({
        colorBuffer: this.cookieAtlas,
        depth: false,
        flipY: true
      });
    }
  }
  allocateUniforms() {
    this._shadowAtlasTextureId = this.device.scope.resolve('shadowAtlasTexture');
    this._shadowAtlasParamsId = this.device.scope.resolve('shadowAtlasParams');
    this._shadowAtlasParams = new Float32Array(2);
    this._cookieAtlasTextureId = this.device.scope.resolve('cookieAtlasTexture');
  }
  updateUniforms() {
    const isShadowFilterPcf = true;
    const rt = this.shadowAtlas.renderTargets[0];
    const shadowBuffer = this.device.webgl2 && isShadowFilterPcf ? rt.depthBuffer : rt.colorBuffer;
    this._shadowAtlasTextureId.setValue(shadowBuffer);

    this._shadowAtlasParams[0] = this.shadowAtlasResolution;
    this._shadowAtlasParams[1] = this.shadowEdgePixels;
    this._shadowAtlasParamsId.setValue(this._shadowAtlasParams);

    this._cookieAtlasTextureId.setValue(this.cookieAtlas);
  }
  subdivide(numLights, lightingParams) {
    let atlasSplit = lightingParams.atlasSplit;

    if (!atlasSplit) {
      const gridSize = Math.ceil(Math.sqrt(numLights));
      atlasSplit = _tempArray2;
      atlasSplit[0] = gridSize;
      atlasSplit.length = 1;
    }

    const arraysEqual = (a, b) => a.length === b.length && a.every((v, i) => v === b[i]);

    if (!arraysEqual(atlasSplit, this.atlasSplit)) {
      this.version++;
      this.slots.length = 0;

      this.atlasSplit.length = 0;
      this.atlasSplit.push(...atlasSplit);

      const splitCount = this.atlasSplit[0];
      if (splitCount > 1) {
        const invSize = 1 / splitCount;
        for (let i = 0; i < splitCount; i++) {
          for (let j = 0; j < splitCount; j++) {
            const rect = new Vec4(i * invSize, j * invSize, invSize, invSize);
            const nextLevelSplit = this.atlasSplit[1 + i * splitCount + j];

            if (nextLevelSplit > 1) {
              for (let x = 0; x < nextLevelSplit; x++) {
                for (let y = 0; y < nextLevelSplit; y++) {
                  const invSizeNext = invSize / nextLevelSplit;
                  const rectNext = new Vec4(rect.x + x * invSizeNext, rect.y + y * invSizeNext, invSizeNext, invSizeNext);
                  this.slots.push(new Slot(rectNext));
                }
              }
            } else {
              this.slots.push(new Slot(rect));
            }
          }
        }
      } else {
        this.slots.push(new Slot(new Vec4(0, 0, 1, 1)));
      }

      this.slots.sort((a, b) => {
        return b.size - a.size;
      });
    }
  }
  collectLights(spotLights, omniLights, lightingParams) {
    const cookiesEnabled = lightingParams.cookiesEnabled;
    const shadowsEnabled = lightingParams.shadowsEnabled;

    let needsShadowAtlas = false;
    let needsCookieAtlas = false;
    const lights = _tempArray;
    lights.length = 0;
    const processLights = list => {
      for (let i = 0; i < list.length; i++) {
        const light = list[i];
        if (light.visibleThisFrame) {
          const lightShadow = shadowsEnabled && light.castShadows;
          const lightCookie = cookiesEnabled && !!light.cookie;
          needsShadowAtlas || (needsShadowAtlas = lightShadow);
          needsCookieAtlas || (needsCookieAtlas = lightCookie);
          if (lightShadow || lightCookie) {
            lights.push(light);
          }
        }
      }
    };
    if (cookiesEnabled || shadowsEnabled) {
      processLights(spotLights);
      processLights(omniLights);
    }

    lights.sort((a, b) => {
      return b.maxScreenSize - a.maxScreenSize;
    });
    if (needsShadowAtlas) {
      this.allocateShadowAtlas(this.shadowAtlasResolution);
    }
    if (needsCookieAtlas) {
      this.allocateCookieAtlas(this.cookieAtlasResolution);
    }
    if (needsShadowAtlas || needsCookieAtlas) {
      this.subdivide(lights.length, lightingParams);
    }
    return lights;
  }

  setupSlot(light, rect) {
    light.atlasViewport.copy(rect);
    const faceCount = light.numShadowFaces;
    for (let face = 0; face < faceCount; face++) {
      if (light.castShadows || light._cookie) {
        _viewport.copy(rect);
        _scissor.copy(rect);

        if (light._type === LIGHTTYPE_SPOT) {
          _viewport.add(this.scissorVec);
        }

        if (light._type === LIGHTTYPE_OMNI) {
          const smallSize = _viewport.z / 3;
          const offset = this.cubeSlotsOffsets[face];
          _viewport.x += smallSize * offset.x;
          _viewport.y += smallSize * offset.y;
          _viewport.z = smallSize;
          _viewport.w = smallSize;
          _scissor.copy(_viewport);
        }
        if (light.castShadows) {
          const lightRenderData = light.getRenderData(null, face);
          lightRenderData.shadowViewport.copy(_viewport);
          lightRenderData.shadowScissor.copy(_scissor);
        }
      }
    }
  }

  assignSlot(light, slotIndex, slotReassigned) {
    light.atlasViewportAllocated = true;
    const slot = this.slots[slotIndex];
    slot.lightId = light.id;
    slot.used = true;

    if (slotReassigned) {
      light.atlasSlotUpdated = true;
      light.atlasVersion = this.version;
      light.atlasSlotIndex = slotIndex;
    }
  }

  update(spotLights, omniLights, lightingParams) {
    this.shadowAtlasResolution = lightingParams.shadowAtlasResolution;
    this.cookieAtlasResolution = lightingParams.cookieAtlasResolution;

    const lights = this.collectLights(spotLights, omniLights, lightingParams);
    if (lights.length > 0) {
      const slots = this.slots;
      for (let i = 0; i < slots.length; i++) {
        slots[i].used = false;
      }

      const assignCount = Math.min(lights.length, slots.length);

      for (let i = 0; i < assignCount; i++) {
        const light = lights[i];
        if (light.castShadows) light._shadowMap = this.shadowAtlas;

        const previousSlot = slots[light.atlasSlotIndex];
        if (light.atlasVersion === this.version && light.id === (previousSlot == null ? void 0 : previousSlot.lightId)) {
          const _previousSlot = slots[light.atlasSlotIndex];
          if (_previousSlot.size === slots[i].size && !_previousSlot.used) {
            this.assignSlot(light, light.atlasSlotIndex, false);
          }
        }
      }

      let usedCount = 0;
      for (let i = 0; i < assignCount; i++) {
        while (usedCount < slots.length && slots[usedCount].used) usedCount++;
        const light = lights[i];
        if (!light.atlasViewportAllocated) {
          this.assignSlot(light, usedCount, true);
        }

        const slot = slots[light.atlasSlotIndex];
        this.setupSlot(light, slot.rect);
      }
    }
    this.updateUniforms();
  }
}

export { LightTextureAtlas };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlnaHQtdGV4dHVyZS1hdGxhcy5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lL2xpZ2h0aW5nL2xpZ2h0LXRleHR1cmUtYXRsYXMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVjMiB9IGZyb20gJy4uLy4uL2NvcmUvbWF0aC92ZWMyLmpzJztcbmltcG9ydCB7IFZlYzQgfSBmcm9tICcuLi8uLi9jb3JlL21hdGgvdmVjNC5qcyc7XG5cbmltcG9ydCB7IFJlbmRlclRhcmdldCB9IGZyb20gJy4uLy4uL3BsYXRmb3JtL2dyYXBoaWNzL3JlbmRlci10YXJnZXQuanMnO1xuXG5pbXBvcnQgeyBMSUdIVFRZUEVfT01OSSwgTElHSFRUWVBFX1NQT1QsIFNIQURPV19QQ0YzIH0gZnJvbSAnLi4vY29uc3RhbnRzLmpzJztcbmltcG9ydCB7IENvb2tpZVJlbmRlcmVyIH0gZnJvbSAnLi4vcmVuZGVyZXIvY29va2llLXJlbmRlcmVyLmpzJztcbmltcG9ydCB7IFNoYWRvd01hcCB9IGZyb20gJy4uL3JlbmRlcmVyL3NoYWRvdy1tYXAuanMnO1xuXG5jb25zdCBfdGVtcEFycmF5ID0gW107XG5jb25zdCBfdGVtcEFycmF5MiA9IFtdO1xuY29uc3QgX3ZpZXdwb3J0ID0gbmV3IFZlYzQoKTtcbmNvbnN0IF9zY2lzc29yID0gbmV3IFZlYzQoKTtcblxuY2xhc3MgU2xvdCB7XG4gICAgY29uc3RydWN0b3IocmVjdCkge1xuICAgICAgICB0aGlzLnNpemUgPSBNYXRoLmZsb29yKHJlY3QudyAqIDEwMjQpOyAgLy8gc2l6ZSBub3JtYWxpemVkIHRvIDEwMjQgYXRsYXNcbiAgICAgICAgdGhpcy51c2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMubGlnaHRJZCA9IC0xOyAgLy8gaWQgb2YgdGhlIGxpZ2h0IHVzaW5nIHRoZSBzbG90XG4gICAgICAgIHRoaXMucmVjdCA9IHJlY3Q7XG4gICAgfVxufVxuXG4vLyBBIGNsYXNzIGhhbmRsaW5nIHJ1bnRpbWUgYWxsb2NhdGlvbiBvZiBzbG90cyBpbiBhIHRleHR1cmUuIEl0IGlzIHVzZWQgdG8gYWxsb2NhdGUgc2xvdHMgaW4gdGhlIHNoYWRvdyBhbmQgY29va2llIGF0bGFzLlxuY2xhc3MgTGlnaHRUZXh0dXJlQXRsYXMge1xuICAgIGNvbnN0cnVjdG9yKGRldmljZSkge1xuXG4gICAgICAgIHRoaXMuZGV2aWNlID0gZGV2aWNlO1xuICAgICAgICB0aGlzLnZlcnNpb24gPSAxOyAgIC8vIGluY3JlbWVudGVkIGVhY2ggdGltZSBzbG90IGNvbmZpZ3VyYXRpb24gY2hhbmdlc1xuXG4gICAgICAgIHRoaXMuc2hhZG93QXRsYXNSZXNvbHV0aW9uID0gMjA0ODtcbiAgICAgICAgdGhpcy5zaGFkb3dBdGxhcyA9IG51bGw7XG5cbiAgICAgICAgLy8gbnVtYmVyIG9mIGFkZGl0aW9uYWwgcGl4ZWxzIHRvIHJlbmRlciBwYXN0IHRoZSByZXF1aXJlZCBzaGFkb3cgY2FtZXJhIGFuZ2xlICg5MGRlZyBmb3Igb21uaSwgb3V0ZXIgZm9yIHNwb3QpIG9mIHRoZSBzaGFkb3cgY2FtZXJhIGZvciBjbHVzdGVyZWQgbGlnaHRzLlxuICAgICAgICAvLyBUaGlzIG5lZWRzIHRvIGJlIGEgcGl4ZWwgbW9yZSB0aGFuIGEgc2hhZG93IGZpbHRlciBuZWVkcyB0byBhY2Nlc3MuXG4gICAgICAgIHRoaXMuc2hhZG93RWRnZVBpeGVscyA9IDM7XG5cbiAgICAgICAgdGhpcy5jb29raWVBdGxhc1Jlc29sdXRpb24gPSAyMDQ4O1xuICAgICAgICB0aGlzLmNvb2tpZUF0bGFzID0gbnVsbDtcbiAgICAgICAgdGhpcy5jb29raWVSZW5kZXJUYXJnZXQgPSBudWxsO1xuXG4gICAgICAgIC8vIGF2YWlsYWJsZSBzbG90cyAob2YgdHlwZSBTbG90KVxuICAgICAgICB0aGlzLnNsb3RzID0gW107XG5cbiAgICAgICAgLy8gY3VycmVudCBzdWJkaXZpc2lvbiBzdHJhdGVneSAtIG1hdGNoZXMgZm9ybWF0IG9mIExpZ2h0aW5nUGFyYW1zLmF0bGFzU3BsaXRcbiAgICAgICAgdGhpcy5hdGxhc1NwbGl0ID0gW107XG5cbiAgICAgICAgLy8gb2Zmc2V0cyB0byBpbmRpdmlkdWFsIGZhY2VzIG9mIGEgY3ViZW1hcCBpbnNpZGUgM3gzIGdyaWQgaW4gYW4gYXRsYXMgc2xvdFxuICAgICAgICB0aGlzLmN1YmVTbG90c09mZnNldHMgPSBbXG4gICAgICAgICAgICBuZXcgVmVjMigwLCAwKSxcbiAgICAgICAgICAgIG5ldyBWZWMyKDAsIDEpLFxuICAgICAgICAgICAgbmV3IFZlYzIoMSwgMCksXG4gICAgICAgICAgICBuZXcgVmVjMigxLCAxKSxcbiAgICAgICAgICAgIG5ldyBWZWMyKDIsIDApLFxuICAgICAgICAgICAgbmV3IFZlYzIoMiwgMSlcbiAgICAgICAgXTtcblxuICAgICAgICAvLyBoYW5kbGVzIGdhcCBiZXR3ZWVuIHNsb3RzXG4gICAgICAgIHRoaXMuc2Npc3NvclZlYyA9IG5ldyBWZWM0KCk7XG5cbiAgICAgICAgdGhpcy5hbGxvY2F0ZVNoYWRvd0F0bGFzKDEpOyAgLy8gcGxhY2Vob2xkZXIgYXMgc2hhZGVyIHJlcXVpcmVzIGl0XG4gICAgICAgIHRoaXMuYWxsb2NhdGVDb29raWVBdGxhcygxKTsgIC8vIHBsYWNlaG9sZGVyIGFzIHNoYWRlciByZXF1aXJlcyBpdFxuICAgICAgICB0aGlzLmFsbG9jYXRlVW5pZm9ybXMoKTtcbiAgICB9XG5cbiAgICBkZXN0cm95KCkge1xuICAgICAgICB0aGlzLmRlc3Ryb3lTaGFkb3dBdGxhcygpO1xuICAgICAgICB0aGlzLmRlc3Ryb3lDb29raWVBdGxhcygpO1xuICAgIH1cblxuICAgIGRlc3Ryb3lTaGFkb3dBdGxhcygpIHtcbiAgICAgICAgaWYgKHRoaXMuc2hhZG93QXRsYXMpIHtcbiAgICAgICAgICAgIHRoaXMuc2hhZG93QXRsYXMuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy5zaGFkb3dBdGxhcyA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZXN0cm95Q29va2llQXRsYXMoKSB7XG4gICAgICAgIGlmICh0aGlzLmNvb2tpZUF0bGFzKSB7XG4gICAgICAgICAgICB0aGlzLmNvb2tpZUF0bGFzLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIHRoaXMuY29va2llQXRsYXMgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNvb2tpZVJlbmRlclRhcmdldCkge1xuICAgICAgICAgICAgdGhpcy5jb29raWVSZW5kZXJUYXJnZXQuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy5jb29raWVSZW5kZXJUYXJnZXQgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWxsb2NhdGVTaGFkb3dBdGxhcyhyZXNvbHV0aW9uKSB7XG4gICAgICAgIGlmICghdGhpcy5zaGFkb3dBdGxhcyB8fCB0aGlzLnNoYWRvd0F0bGFzLnRleHR1cmUud2lkdGggIT09IHJlc29sdXRpb24pIHtcblxuICAgICAgICAgICAgLy8gY29udGVudCBvZiBhdGxhcyBpcyBsb3N0LCBmb3JjZSByZS1yZW5kZXIgb2Ygc3RhdGljIHNoYWRvd3NcbiAgICAgICAgICAgIHRoaXMudmVyc2lvbisrO1xuXG4gICAgICAgICAgICB0aGlzLmRlc3Ryb3lTaGFkb3dBdGxhcygpO1xuICAgICAgICAgICAgdGhpcy5zaGFkb3dBdGxhcyA9IFNoYWRvd01hcC5jcmVhdGVBdGxhcyh0aGlzLmRldmljZSwgcmVzb2x1dGlvbiwgU0hBRE9XX1BDRjMpO1xuXG4gICAgICAgICAgICAvLyBhdm9pZCBpdCBiZWluZyBkZXN0cm95ZWQgYnkgbGlnaHRzXG4gICAgICAgICAgICB0aGlzLnNoYWRvd0F0bGFzLmNhY2hlZCA9IHRydWU7XG5cbiAgICAgICAgICAgIC8vIGxlYXZlIGdhcCBiZXR3ZWVuIGluZGl2aWR1YWwgdGlsZXMgdG8gYXZvaWQgc2hhZG93IC8gY29va2llIHNhbXBsaW5nIG90aGVyIHRpbGVzIChlbm91Z2ggZm9yIFBDRjUpXG4gICAgICAgICAgICAvLyBub3RlIHRoYXQgdGhpcyBvbmx5IGZhZGVzIC8gcmVtb3ZlcyBzaGFkb3dzIG9uIHRoZSBlZGdlcywgd2hpY2ggaXMgc3RpbGwgbm90IGNvcnJlY3QgLSBhIHNoYWRlciBjbGlwcGluZyBpcyBuZWVkZWQ/XG4gICAgICAgICAgICBjb25zdCBzY2lzc29yT2Zmc2V0ID0gNCAvIHRoaXMuc2hhZG93QXRsYXNSZXNvbHV0aW9uO1xuICAgICAgICAgICAgdGhpcy5zY2lzc29yVmVjLnNldChzY2lzc29yT2Zmc2V0LCBzY2lzc29yT2Zmc2V0LCAtMiAqIHNjaXNzb3JPZmZzZXQsIC0yICogc2Npc3Nvck9mZnNldCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhbGxvY2F0ZUNvb2tpZUF0bGFzKHJlc29sdXRpb24pIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvb2tpZUF0bGFzIHx8IHRoaXMuY29va2llQXRsYXMud2lkdGggIT09IHJlc29sdXRpb24pIHtcblxuICAgICAgICAgICAgLy8gY29udGVudCBvZiBhdGxhcyBpcyBsb3N0LCBmb3JjZSByZS1yZW5kZXIgb2Ygc3RhdGljIGNvb2tpZXNcbiAgICAgICAgICAgIHRoaXMudmVyc2lvbisrO1xuXG4gICAgICAgICAgICB0aGlzLmRlc3Ryb3lDb29raWVBdGxhcygpO1xuICAgICAgICAgICAgdGhpcy5jb29raWVBdGxhcyA9IENvb2tpZVJlbmRlcmVyLmNyZWF0ZVRleHR1cmUodGhpcy5kZXZpY2UsIHJlc29sdXRpb24pO1xuXG4gICAgICAgICAgICB0aGlzLmNvb2tpZVJlbmRlclRhcmdldCA9IG5ldyBSZW5kZXJUYXJnZXQoe1xuICAgICAgICAgICAgICAgIGNvbG9yQnVmZmVyOiB0aGlzLmNvb2tpZUF0bGFzLFxuICAgICAgICAgICAgICAgIGRlcHRoOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBmbGlwWTogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhbGxvY2F0ZVVuaWZvcm1zKCkge1xuICAgICAgICB0aGlzLl9zaGFkb3dBdGxhc1RleHR1cmVJZCA9IHRoaXMuZGV2aWNlLnNjb3BlLnJlc29sdmUoJ3NoYWRvd0F0bGFzVGV4dHVyZScpO1xuICAgICAgICB0aGlzLl9zaGFkb3dBdGxhc1BhcmFtc0lkID0gdGhpcy5kZXZpY2Uuc2NvcGUucmVzb2x2ZSgnc2hhZG93QXRsYXNQYXJhbXMnKTtcbiAgICAgICAgdGhpcy5fc2hhZG93QXRsYXNQYXJhbXMgPSBuZXcgRmxvYXQzMkFycmF5KDIpO1xuXG4gICAgICAgIHRoaXMuX2Nvb2tpZUF0bGFzVGV4dHVyZUlkID0gdGhpcy5kZXZpY2Uuc2NvcGUucmVzb2x2ZSgnY29va2llQXRsYXNUZXh0dXJlJyk7XG4gICAgfVxuXG4gICAgdXBkYXRlVW5pZm9ybXMoKSB7XG5cbiAgICAgICAgLy8gc2hhZG93IGF0bGFzIHRleHR1cmVcbiAgICAgICAgY29uc3QgaXNTaGFkb3dGaWx0ZXJQY2YgPSB0cnVlO1xuICAgICAgICBjb25zdCBydCA9IHRoaXMuc2hhZG93QXRsYXMucmVuZGVyVGFyZ2V0c1swXTtcbiAgICAgICAgY29uc3Qgc2hhZG93QnVmZmVyID0gKHRoaXMuZGV2aWNlLndlYmdsMiAmJiBpc1NoYWRvd0ZpbHRlclBjZikgPyBydC5kZXB0aEJ1ZmZlciA6IHJ0LmNvbG9yQnVmZmVyO1xuICAgICAgICB0aGlzLl9zaGFkb3dBdGxhc1RleHR1cmVJZC5zZXRWYWx1ZShzaGFkb3dCdWZmZXIpO1xuXG4gICAgICAgIC8vIHNoYWRvdyBhdGxhcyBwYXJhbXNcbiAgICAgICAgdGhpcy5fc2hhZG93QXRsYXNQYXJhbXNbMF0gPSB0aGlzLnNoYWRvd0F0bGFzUmVzb2x1dGlvbjtcbiAgICAgICAgdGhpcy5fc2hhZG93QXRsYXNQYXJhbXNbMV0gPSB0aGlzLnNoYWRvd0VkZ2VQaXhlbHM7XG4gICAgICAgIHRoaXMuX3NoYWRvd0F0bGFzUGFyYW1zSWQuc2V0VmFsdWUodGhpcy5fc2hhZG93QXRsYXNQYXJhbXMpO1xuXG4gICAgICAgIC8vIGNvb2tpZSBhdGxhcyB0ZXh0dXJlc1xuICAgICAgICB0aGlzLl9jb29raWVBdGxhc1RleHR1cmVJZC5zZXRWYWx1ZSh0aGlzLmNvb2tpZUF0bGFzKTtcbiAgICB9XG5cbiAgICBzdWJkaXZpZGUobnVtTGlnaHRzLCBsaWdodGluZ1BhcmFtcykge1xuXG4gICAgICAgIGxldCBhdGxhc1NwbGl0ID0gbGlnaHRpbmdQYXJhbXMuYXRsYXNTcGxpdDtcblxuICAgICAgICAvLyBpZiBubyB1c2VyIHNwZWNpZmllZCBzdWJkaXZpc2lvblxuICAgICAgICBpZiAoIWF0bGFzU3BsaXQpIHtcblxuICAgICAgICAgICAgLy8gc3BsaXQgdG8gZXF1YWwgbnVtYmVyIG9mIHNxdWFyZXNcbiAgICAgICAgICAgIGNvbnN0IGdyaWRTaXplID0gTWF0aC5jZWlsKE1hdGguc3FydChudW1MaWdodHMpKTtcbiAgICAgICAgICAgIGF0bGFzU3BsaXQgPSBfdGVtcEFycmF5MjtcbiAgICAgICAgICAgIGF0bGFzU3BsaXRbMF0gPSBncmlkU2l6ZTtcbiAgICAgICAgICAgIGF0bGFzU3BsaXQubGVuZ3RoID0gMTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNvbXBhcmUgdHdvIGFycmF5c1xuICAgICAgICBjb25zdCBhcnJheXNFcXVhbCA9IChhLCBiKSA9PiBhLmxlbmd0aCA9PT0gYi5sZW5ndGggJiYgYS5ldmVyeSgodiwgaSkgPT4gdiA9PT0gYltpXSk7XG5cbiAgICAgICAgLy8gaWYgdGhlIHNwbGl0IGhhcyBjaGFuZ2VkLCByZWdlbmVyYXRlIHNsb3RzXG4gICAgICAgIGlmICghYXJyYXlzRXF1YWwoYXRsYXNTcGxpdCwgdGhpcy5hdGxhc1NwbGl0KSkge1xuXG4gICAgICAgICAgICB0aGlzLnZlcnNpb24rKztcbiAgICAgICAgICAgIHRoaXMuc2xvdHMubGVuZ3RoID0gMDtcblxuICAgICAgICAgICAgLy8gc3RvcmUgY3VycmVudCBzZXR0aW5nc1xuICAgICAgICAgICAgdGhpcy5hdGxhc1NwbGl0Lmxlbmd0aCA9IDA7XG4gICAgICAgICAgICB0aGlzLmF0bGFzU3BsaXQucHVzaCguLi5hdGxhc1NwbGl0KTtcblxuICAgICAgICAgICAgLy8gZ2VuZXJhdGUgdG9wIGxldmVsIHNwbGl0XG4gICAgICAgICAgICBjb25zdCBzcGxpdENvdW50ID0gdGhpcy5hdGxhc1NwbGl0WzBdO1xuICAgICAgICAgICAgaWYgKHNwbGl0Q291bnQgPiAxKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW52U2l6ZSA9IDEgLyBzcGxpdENvdW50O1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3BsaXRDb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc3BsaXRDb3VudDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWN0ID0gbmV3IFZlYzQoaSAqIGludlNpemUsIGogKiBpbnZTaXplLCBpbnZTaXplLCBpbnZTaXplKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRMZXZlbFNwbGl0ID0gdGhpcy5hdGxhc1NwbGl0WzEgKyBpICogc3BsaXRDb3VudCArIGpdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBuZWVkIHRvIHNwbGl0IGFnYWluXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dExldmVsU3BsaXQgPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBuZXh0TGV2ZWxTcGxpdDsgeCsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgbmV4dExldmVsU3BsaXQ7IHkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52U2l6ZU5leHQgPSBpbnZTaXplIC8gbmV4dExldmVsU3BsaXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWN0TmV4dCA9IG5ldyBWZWM0KHJlY3QueCArIHggKiBpbnZTaXplTmV4dCwgcmVjdC55ICsgeSAqIGludlNpemVOZXh0LCBpbnZTaXplTmV4dCwgaW52U2l6ZU5leHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zbG90cy5wdXNoKG5ldyBTbG90KHJlY3ROZXh0KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2xvdHMucHVzaChuZXcgU2xvdChyZWN0KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIHNpbmdsZSBzbG90XG4gICAgICAgICAgICAgICAgdGhpcy5zbG90cy5wdXNoKG5ldyBTbG90KG5ldyBWZWM0KDAsIDAsIDEsIDEpKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIHNvcnQgc2xvdHMgZGVzY2VuZGluZ1xuICAgICAgICAgICAgdGhpcy5zbG90cy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGIuc2l6ZSAtIGEuc2l6ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29sbGVjdExpZ2h0cyhzcG90TGlnaHRzLCBvbW5pTGlnaHRzLCBsaWdodGluZ1BhcmFtcykge1xuXG4gICAgICAgIGNvbnN0IGNvb2tpZXNFbmFibGVkID0gbGlnaHRpbmdQYXJhbXMuY29va2llc0VuYWJsZWQ7XG4gICAgICAgIGNvbnN0IHNoYWRvd3NFbmFibGVkID0gbGlnaHRpbmdQYXJhbXMuc2hhZG93c0VuYWJsZWQ7XG5cbiAgICAgICAgLy8gZ2V0IGFsbCBsaWdodHMgdGhhdCBuZWVkIHNoYWRvd3Mgb3IgY29va2llcywgaWYgdGhvc2UgYXJlIGVuYWJsZWRcbiAgICAgICAgbGV0IG5lZWRzU2hhZG93QXRsYXMgPSBmYWxzZTtcbiAgICAgICAgbGV0IG5lZWRzQ29va2llQXRsYXMgPSBmYWxzZTtcbiAgICAgICAgY29uc3QgbGlnaHRzID0gX3RlbXBBcnJheTtcbiAgICAgICAgbGlnaHRzLmxlbmd0aCA9IDA7XG5cbiAgICAgICAgY29uc3QgcHJvY2Vzc0xpZ2h0cyA9IChsaXN0KSA9PiB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsaWdodCA9IGxpc3RbaV07XG4gICAgICAgICAgICAgICAgaWYgKGxpZ2h0LnZpc2libGVUaGlzRnJhbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlnaHRTaGFkb3cgPSBzaGFkb3dzRW5hYmxlZCAmJiBsaWdodC5jYXN0U2hhZG93cztcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlnaHRDb29raWUgPSBjb29raWVzRW5hYmxlZCAmJiAhIWxpZ2h0LmNvb2tpZTtcblxuICAgICAgICAgICAgICAgICAgICBuZWVkc1NoYWRvd0F0bGFzIHx8PSBsaWdodFNoYWRvdztcbiAgICAgICAgICAgICAgICAgICAgbmVlZHNDb29raWVBdGxhcyB8fD0gbGlnaHRDb29raWU7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGxpZ2h0U2hhZG93IHx8IGxpZ2h0Q29va2llKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaWdodHMucHVzaChsaWdodCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGNvb2tpZXNFbmFibGVkIHx8IHNoYWRvd3NFbmFibGVkKSB7XG4gICAgICAgICAgICBwcm9jZXNzTGlnaHRzKHNwb3RMaWdodHMpO1xuICAgICAgICAgICAgcHJvY2Vzc0xpZ2h0cyhvbW5pTGlnaHRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHNvcnQgbGlnaHRzIGJ5IG1heFNjcmVlblNpemUgLSB0byBoYXZlIHRoZW0gb3JkZXJlZCBieSBhdGxhcyBzbG90IHNpemVcbiAgICAgICAgbGlnaHRzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBiLm1heFNjcmVlblNpemUgLSBhLm1heFNjcmVlblNpemU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChuZWVkc1NoYWRvd0F0bGFzKSB7XG4gICAgICAgICAgICB0aGlzLmFsbG9jYXRlU2hhZG93QXRsYXModGhpcy5zaGFkb3dBdGxhc1Jlc29sdXRpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5lZWRzQ29va2llQXRsYXMpIHtcbiAgICAgICAgICAgIHRoaXMuYWxsb2NhdGVDb29raWVBdGxhcyh0aGlzLmNvb2tpZUF0bGFzUmVzb2x1dGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobmVlZHNTaGFkb3dBdGxhcyB8fCBuZWVkc0Nvb2tpZUF0bGFzKSB7XG4gICAgICAgICAgICB0aGlzLnN1YmRpdmlkZShsaWdodHMubGVuZ3RoLCBsaWdodGluZ1BhcmFtcyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbGlnaHRzO1xuICAgIH1cblxuICAgIC8vIGNvbmZpZ3VyZSBsaWdodCB0byB1c2UgYXNzaWduZWQgc2xvdFxuICAgIHNldHVwU2xvdChsaWdodCwgcmVjdCkge1xuXG4gICAgICAgIGxpZ2h0LmF0bGFzVmlld3BvcnQuY29weShyZWN0KTtcblxuICAgICAgICBjb25zdCBmYWNlQ291bnQgPSBsaWdodC5udW1TaGFkb3dGYWNlcztcbiAgICAgICAgZm9yIChsZXQgZmFjZSA9IDA7IGZhY2UgPCBmYWNlQ291bnQ7IGZhY2UrKykge1xuXG4gICAgICAgICAgICAvLyBzZXR1cCBzbG90IGZvciBzaGFkb3cgYW5kIGNvb2tpZVxuICAgICAgICAgICAgaWYgKGxpZ2h0LmNhc3RTaGFkb3dzIHx8IGxpZ2h0Ll9jb29raWUpIHtcblxuICAgICAgICAgICAgICAgIF92aWV3cG9ydC5jb3B5KHJlY3QpO1xuICAgICAgICAgICAgICAgIF9zY2lzc29yLmNvcHkocmVjdCk7XG5cbiAgICAgICAgICAgICAgICAvLyBmb3Igc3BvdCBsaWdodHMgaW4gdGhlIGF0bGFzLCBtYWtlIHZpZXdwb3J0IHNsaWdodGx5IHNtYWxsZXIgdG8gYXZvaWQgc2FtcGxpbmcgcGFzdCB0aGUgZWRnZXNcbiAgICAgICAgICAgICAgICBpZiAobGlnaHQuX3R5cGUgPT09IExJR0hUVFlQRV9TUE9UKSB7XG4gICAgICAgICAgICAgICAgICAgIF92aWV3cG9ydC5hZGQodGhpcy5zY2lzc29yVmVjKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBmb3IgY3ViZSBtYXAsIGFsbG9jYXRlIHBhcnQgb2YgdGhlIHNsb3RcbiAgICAgICAgICAgICAgICBpZiAobGlnaHQuX3R5cGUgPT09IExJR0hUVFlQRV9PTU5JKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc21hbGxTaXplID0gX3ZpZXdwb3J0LnogLyAzO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSB0aGlzLmN1YmVTbG90c09mZnNldHNbZmFjZV07XG4gICAgICAgICAgICAgICAgICAgIF92aWV3cG9ydC54ICs9IHNtYWxsU2l6ZSAqIG9mZnNldC54O1xuICAgICAgICAgICAgICAgICAgICBfdmlld3BvcnQueSArPSBzbWFsbFNpemUgKiBvZmZzZXQueTtcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXdwb3J0LnogPSBzbWFsbFNpemU7XG4gICAgICAgICAgICAgICAgICAgIF92aWV3cG9ydC53ID0gc21hbGxTaXplO1xuXG4gICAgICAgICAgICAgICAgICAgIF9zY2lzc29yLmNvcHkoX3ZpZXdwb3J0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAobGlnaHQuY2FzdFNoYWRvd3MpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlnaHRSZW5kZXJEYXRhID0gbGlnaHQuZ2V0UmVuZGVyRGF0YShudWxsLCBmYWNlKTtcbiAgICAgICAgICAgICAgICAgICAgbGlnaHRSZW5kZXJEYXRhLnNoYWRvd1ZpZXdwb3J0LmNvcHkoX3ZpZXdwb3J0KTtcbiAgICAgICAgICAgICAgICAgICAgbGlnaHRSZW5kZXJEYXRhLnNoYWRvd1NjaXNzb3IuY29weShfc2Npc3Nvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gYXNzaWduIGEgc2xvdCB0byB0aGUgbGlnaHRcbiAgICBhc3NpZ25TbG90KGxpZ2h0LCBzbG90SW5kZXgsIHNsb3RSZWFzc2lnbmVkKSB7XG5cbiAgICAgICAgbGlnaHQuYXRsYXNWaWV3cG9ydEFsbG9jYXRlZCA9IHRydWU7XG5cbiAgICAgICAgY29uc3Qgc2xvdCA9IHRoaXMuc2xvdHNbc2xvdEluZGV4XTtcbiAgICAgICAgc2xvdC5saWdodElkID0gbGlnaHQuaWQ7XG4gICAgICAgIHNsb3QudXNlZCA9IHRydWU7XG5cbiAgICAgICAgLy8gc2xvdCBpcyByZWFzc2lnbmVkIChjb250ZW50IG5lZWRzIHRvIGJlIHVwZGF0ZWQpXG4gICAgICAgIGlmIChzbG90UmVhc3NpZ25lZCkge1xuICAgICAgICAgICAgbGlnaHQuYXRsYXNTbG90VXBkYXRlZCA9IHRydWU7XG4gICAgICAgICAgICBsaWdodC5hdGxhc1ZlcnNpb24gPSB0aGlzLnZlcnNpb247XG4gICAgICAgICAgICBsaWdodC5hdGxhc1Nsb3RJbmRleCA9IHNsb3RJbmRleDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIHVwZGF0ZSB0ZXh0dXJlIGF0bGFzIGZvciBhIGxpc3Qgb2YgbGlnaHRzXG4gICAgdXBkYXRlKHNwb3RMaWdodHMsIG9tbmlMaWdodHMsIGxpZ2h0aW5nUGFyYW1zKSB7XG5cbiAgICAgICAgLy8gdXBkYXRlIHRleHR1cmUgcmVzb2x1dGlvbnNcbiAgICAgICAgdGhpcy5zaGFkb3dBdGxhc1Jlc29sdXRpb24gPSBsaWdodGluZ1BhcmFtcy5zaGFkb3dBdGxhc1Jlc29sdXRpb247XG4gICAgICAgIHRoaXMuY29va2llQXRsYXNSZXNvbHV0aW9uID0gbGlnaHRpbmdQYXJhbXMuY29va2llQXRsYXNSZXNvbHV0aW9uO1xuXG4gICAgICAgIC8vIGNvbGxlY3QgbGlnaHRzIHJlcXVpcmluZyBhdGxhc1xuICAgICAgICBjb25zdCBsaWdodHMgPSB0aGlzLmNvbGxlY3RMaWdodHMoc3BvdExpZ2h0cywgb21uaUxpZ2h0cywgbGlnaHRpbmdQYXJhbXMpO1xuICAgICAgICBpZiAobGlnaHRzLmxlbmd0aCA+IDApIHtcblxuICAgICAgICAgICAgLy8gbWFyayBhbGwgc2xvdHMgYXMgdW51c2VkXG4gICAgICAgICAgICBjb25zdCBzbG90cyA9IHRoaXMuc2xvdHM7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNsb3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgc2xvdHNbaV0udXNlZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBhc3NpZ24gc2xvdHMgdG8gbGlnaHRzXG4gICAgICAgICAgICAvLyBUaGUgc2xvdCB0byBsaWdodCBhc3NpZ25tZW50IGxvZ2ljOlxuICAgICAgICAgICAgLy8gLSBpbnRlcm5hbGx5IHRoZSBhdGxhcyBzbG90cyBhcmUgc29ydGVkIGluIHRoZSBkZXNjZW5kaW5nIG9yZGVyIChkb25lIHdoZW4gYXRsYXMgc3BsaXQgY2hhbmdlcylcbiAgICAgICAgICAgIC8vIC0gZXZlcnkgZnJhbWUgYWxsIHZpc2libGUgbGlnaHRzIGFyZSBzb3J0ZWQgYnkgdGhlaXIgc2NyZWVuIHNwYWNlIHNpemUgKHRoaXMgaGFuZGxlcyBhbGwgY2FtZXJhcyB3aGVyZSBsaWdodHNcbiAgICAgICAgICAgIC8vICAgYXJlIHZpc2libGUgdXNpbmcgbWF4IHZhbHVlKVxuICAgICAgICAgICAgLy8gLSBhbGwgbGlnaHRzIGluIHRoaXMgb3JkZXIgZ2V0IGEgc2xvdCBzaXplIGZyb20gdGhlIHNsb3QgbGlzdCBpbiB0aGUgc2FtZSBvcmRlci4gQ2FyZSBpcyB0YWtlbiB0byBub3QgcmVhc3NpZ25cbiAgICAgICAgICAgIC8vICAgc2xvdCBpZiB0aGUgc2l6ZSBvZiBpdCBpcyB0aGUgc2FtZSBhbmQgb25seSBpbmRleCBjaGFuZ2VzIC0gdGhpcyBpcyBkb25lIHVzaW5nIHR3byBwYXNzIGFzc2lnbm1lbnRcbiAgICAgICAgICAgIGNvbnN0IGFzc2lnbkNvdW50ID0gTWF0aC5taW4obGlnaHRzLmxlbmd0aCwgc2xvdHMubGVuZ3RoKTtcblxuICAgICAgICAgICAgLy8gZmlyc3QgcGFzcyAtIHByZXNlcnZlIGFsbG9jYXRlZCBzbG90cyBmb3IgbGlnaHRzIHJlcXVpcmluZyBzbG90IG9mIHRoZSBzYW1lIHNpemVcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXNzaWduQ291bnQ7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gbGlnaHRzW2ldO1xuXG4gICAgICAgICAgICAgICAgaWYgKGxpZ2h0LmNhc3RTaGFkb3dzKVxuICAgICAgICAgICAgICAgICAgICBsaWdodC5fc2hhZG93TWFwID0gdGhpcy5zaGFkb3dBdGxhcztcblxuICAgICAgICAgICAgICAgIC8vIGlmIGN1cnJlbnRseSBhc3NpZ25lZCBzbG90IGlzIHRoZSBzYW1lIHNpemUgYXMgd2hhdCBpcyBuZWVkZWQsIGFuZCB3YXMgbGFzdCB1c2VkIGJ5IHRoaXMgbGlnaHQsIHJldXNlIGl0XG4gICAgICAgICAgICAgICAgY29uc3QgcHJldmlvdXNTbG90ID0gc2xvdHNbbGlnaHQuYXRsYXNTbG90SW5kZXhdO1xuICAgICAgICAgICAgICAgIGlmIChsaWdodC5hdGxhc1ZlcnNpb24gPT09IHRoaXMudmVyc2lvbiAmJiBsaWdodC5pZCA9PT0gcHJldmlvdXNTbG90Py5saWdodElkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzU2xvdCA9IHNsb3RzW2xpZ2h0LmF0bGFzU2xvdEluZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzU2xvdC5zaXplID09PSBzbG90c1tpXS5zaXplICYmICFwcmV2aW91c1Nsb3QudXNlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hc3NpZ25TbG90KGxpZ2h0LCBsaWdodC5hdGxhc1Nsb3RJbmRleCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBzZWNvbmQgcGFzcyAtIGFzc2lnbiBzbG90cyB0byB1bmhhbmRsZWQgbGlnaHRzXG4gICAgICAgICAgICBsZXQgdXNlZENvdW50ID0gMDtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXNzaWduQ291bnQ7IGkrKykge1xuXG4gICAgICAgICAgICAgICAgLy8gc2tpcCBhbHJlYWR5IHVzZWQgc2xvdHNcbiAgICAgICAgICAgICAgICB3aGlsZSAodXNlZENvdW50IDwgc2xvdHMubGVuZ3RoICYmIHNsb3RzW3VzZWRDb3VudF0udXNlZClcbiAgICAgICAgICAgICAgICAgICAgdXNlZENvdW50Kys7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBsaWdodCA9IGxpZ2h0c1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoIWxpZ2h0LmF0bGFzVmlld3BvcnRBbGxvY2F0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hc3NpZ25TbG90KGxpZ2h0LCB1c2VkQ291bnQsIHRydWUpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIHNldCB1cCBhbGwgc2xvdHNcbiAgICAgICAgICAgICAgICBjb25zdCBzbG90ID0gc2xvdHNbbGlnaHQuYXRsYXNTbG90SW5kZXhdO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBTbG90KGxpZ2h0LCBzbG90LnJlY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy51cGRhdGVVbmlmb3JtcygpO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgTGlnaHRUZXh0dXJlQXRsYXMgfTtcbiJdLCJuYW1lcyI6WyJfdGVtcEFycmF5IiwiX3RlbXBBcnJheTIiLCJfdmlld3BvcnQiLCJWZWM0IiwiX3NjaXNzb3IiLCJTbG90IiwiY29uc3RydWN0b3IiLCJyZWN0Iiwic2l6ZSIsIk1hdGgiLCJmbG9vciIsInciLCJ1c2VkIiwibGlnaHRJZCIsIkxpZ2h0VGV4dHVyZUF0bGFzIiwiZGV2aWNlIiwidmVyc2lvbiIsInNoYWRvd0F0bGFzUmVzb2x1dGlvbiIsInNoYWRvd0F0bGFzIiwic2hhZG93RWRnZVBpeGVscyIsImNvb2tpZUF0bGFzUmVzb2x1dGlvbiIsImNvb2tpZUF0bGFzIiwiY29va2llUmVuZGVyVGFyZ2V0Iiwic2xvdHMiLCJhdGxhc1NwbGl0IiwiY3ViZVNsb3RzT2Zmc2V0cyIsIlZlYzIiLCJzY2lzc29yVmVjIiwiYWxsb2NhdGVTaGFkb3dBdGxhcyIsImFsbG9jYXRlQ29va2llQXRsYXMiLCJhbGxvY2F0ZVVuaWZvcm1zIiwiZGVzdHJveSIsImRlc3Ryb3lTaGFkb3dBdGxhcyIsImRlc3Ryb3lDb29raWVBdGxhcyIsInJlc29sdXRpb24iLCJ0ZXh0dXJlIiwid2lkdGgiLCJTaGFkb3dNYXAiLCJjcmVhdGVBdGxhcyIsIlNIQURPV19QQ0YzIiwiY2FjaGVkIiwic2Npc3Nvck9mZnNldCIsInNldCIsIkNvb2tpZVJlbmRlcmVyIiwiY3JlYXRlVGV4dHVyZSIsIlJlbmRlclRhcmdldCIsImNvbG9yQnVmZmVyIiwiZGVwdGgiLCJmbGlwWSIsIl9zaGFkb3dBdGxhc1RleHR1cmVJZCIsInNjb3BlIiwicmVzb2x2ZSIsIl9zaGFkb3dBdGxhc1BhcmFtc0lkIiwiX3NoYWRvd0F0bGFzUGFyYW1zIiwiRmxvYXQzMkFycmF5IiwiX2Nvb2tpZUF0bGFzVGV4dHVyZUlkIiwidXBkYXRlVW5pZm9ybXMiLCJpc1NoYWRvd0ZpbHRlclBjZiIsInJ0IiwicmVuZGVyVGFyZ2V0cyIsInNoYWRvd0J1ZmZlciIsIndlYmdsMiIsImRlcHRoQnVmZmVyIiwic2V0VmFsdWUiLCJzdWJkaXZpZGUiLCJudW1MaWdodHMiLCJsaWdodGluZ1BhcmFtcyIsImdyaWRTaXplIiwiY2VpbCIsInNxcnQiLCJsZW5ndGgiLCJhcnJheXNFcXVhbCIsImEiLCJiIiwiZXZlcnkiLCJ2IiwiaSIsInB1c2giLCJzcGxpdENvdW50IiwiaW52U2l6ZSIsImoiLCJuZXh0TGV2ZWxTcGxpdCIsIngiLCJ5IiwiaW52U2l6ZU5leHQiLCJyZWN0TmV4dCIsInNvcnQiLCJjb2xsZWN0TGlnaHRzIiwic3BvdExpZ2h0cyIsIm9tbmlMaWdodHMiLCJjb29raWVzRW5hYmxlZCIsInNoYWRvd3NFbmFibGVkIiwibmVlZHNTaGFkb3dBdGxhcyIsIm5lZWRzQ29va2llQXRsYXMiLCJsaWdodHMiLCJwcm9jZXNzTGlnaHRzIiwibGlzdCIsImxpZ2h0IiwidmlzaWJsZVRoaXNGcmFtZSIsImxpZ2h0U2hhZG93IiwiY2FzdFNoYWRvd3MiLCJsaWdodENvb2tpZSIsImNvb2tpZSIsIm1heFNjcmVlblNpemUiLCJzZXR1cFNsb3QiLCJhdGxhc1ZpZXdwb3J0IiwiY29weSIsImZhY2VDb3VudCIsIm51bVNoYWRvd0ZhY2VzIiwiZmFjZSIsIl9jb29raWUiLCJfdHlwZSIsIkxJR0hUVFlQRV9TUE9UIiwiYWRkIiwiTElHSFRUWVBFX09NTkkiLCJzbWFsbFNpemUiLCJ6Iiwib2Zmc2V0IiwibGlnaHRSZW5kZXJEYXRhIiwiZ2V0UmVuZGVyRGF0YSIsInNoYWRvd1ZpZXdwb3J0Iiwic2hhZG93U2Npc3NvciIsImFzc2lnblNsb3QiLCJzbG90SW5kZXgiLCJzbG90UmVhc3NpZ25lZCIsImF0bGFzVmlld3BvcnRBbGxvY2F0ZWQiLCJzbG90IiwiaWQiLCJhdGxhc1Nsb3RVcGRhdGVkIiwiYXRsYXNWZXJzaW9uIiwiYXRsYXNTbG90SW5kZXgiLCJ1cGRhdGUiLCJhc3NpZ25Db3VudCIsIm1pbiIsIl9zaGFkb3dNYXAiLCJwcmV2aW91c1Nsb3QiLCJ1c2VkQ291bnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQVNBLE1BQU1BLFVBQVUsR0FBRyxFQUFFLENBQUE7QUFDckIsTUFBTUMsV0FBVyxHQUFHLEVBQUUsQ0FBQTtBQUN0QixNQUFNQyxTQUFTLEdBQUcsSUFBSUMsSUFBSSxFQUFFLENBQUE7QUFDNUIsTUFBTUMsUUFBUSxHQUFHLElBQUlELElBQUksRUFBRSxDQUFBO0FBRTNCLE1BQU1FLElBQUksQ0FBQztFQUNQQyxXQUFXLENBQUNDLElBQUksRUFBRTtBQUNkLElBQUEsSUFBSSxDQUFDQyxJQUFJLEdBQUdDLElBQUksQ0FBQ0MsS0FBSyxDQUFDSCxJQUFJLENBQUNJLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQTtJQUNyQyxJQUFJLENBQUNDLElBQUksR0FBRyxLQUFLLENBQUE7QUFDakIsSUFBQSxJQUFJLENBQUNDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNqQixJQUFJLENBQUNOLElBQUksR0FBR0EsSUFBSSxDQUFBO0FBQ3BCLEdBQUE7QUFDSixDQUFBOztBQUdBLE1BQU1PLGlCQUFpQixDQUFDO0VBQ3BCUixXQUFXLENBQUNTLE1BQU0sRUFBRTtJQUVoQixJQUFJLENBQUNBLE1BQU0sR0FBR0EsTUFBTSxDQUFBO0lBQ3BCLElBQUksQ0FBQ0MsT0FBTyxHQUFHLENBQUMsQ0FBQTs7SUFFaEIsSUFBSSxDQUFDQyxxQkFBcUIsR0FBRyxJQUFJLENBQUE7SUFDakMsSUFBSSxDQUFDQyxXQUFXLEdBQUcsSUFBSSxDQUFBOztJQUl2QixJQUFJLENBQUNDLGdCQUFnQixHQUFHLENBQUMsQ0FBQTtJQUV6QixJQUFJLENBQUNDLHFCQUFxQixHQUFHLElBQUksQ0FBQTtJQUNqQyxJQUFJLENBQUNDLFdBQVcsR0FBRyxJQUFJLENBQUE7SUFDdkIsSUFBSSxDQUFDQyxrQkFBa0IsR0FBRyxJ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

/**
 * @license
 * PlayCanvas Engine v1.58.0 revision 6672f604c (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { Quat } from '../../core/math/quat.js';
import { Vec3 } from '../../core/math/vec3.js';
import { Mat4 } from '../../core/math/mat4.js';
import { ASPECT_MANUAL, LIGHTTYPE_DIRECTIONAL, PROJECTION_ORTHOGRAPHIC, LIGHTTYPE_SPOT, PROJECTION_PERSPECTIVE, LIGHTTYPE_OMNI } from '../constants.js';
import { Camera } from '../camera.js';
import { GraphNode } from '../graph-node.js';

const _viewMat = new Mat4();
const _viewProjMat = new Mat4();
const _viewportMatrix = new Mat4();

class LightCamera {

  static create(name, lightType, face) {
    const camera = new Camera();
    camera.node = new GraphNode(name);
    camera.aspectRatio = 1;
    camera.aspectRatioMode = ASPECT_MANUAL;
    camera._scissorRectClear = true;

    switch (lightType) {
      case LIGHTTYPE_OMNI:
        camera.node.setRotation(LightCamera.pointLightRotations[face]);
        camera.fov = 90;
        camera.projection = PROJECTION_PERSPECTIVE;
        break;
      case LIGHTTYPE_SPOT:
        camera.projection = PROJECTION_PERSPECTIVE;
        break;
      case LIGHTTYPE_DIRECTIONAL:
        camera.projection = PROJECTION_ORTHOGRAPHIC;
        break;
    }
    return camera;
  }
  static evalSpotCookieMatrix(light) {
    let cookieCamera = LightCamera._spotCookieCamera;
    if (!cookieCamera) {
      cookieCamera = LightCamera.create('SpotCookieCamera', LIGHTTYPE_SPOT);
      LightCamera._spotCookieCamera = cookieCamera;
    }
    cookieCamera.fov = light._outerConeAngle * 2;
    const cookieNode = cookieCamera._node;
    cookieNode.setPosition(light._node.getPosition());
    cookieNode.setRotation(light._node.getRotation());
    cookieNode.rotateLocal(-90, 0, 0);
    _viewMat.setTRS(cookieNode.getPosition(), cookieNode.getRotation(), Vec3.ONE).invert();
    _viewProjMat.mul2(cookieCamera.projectionMatrix, _viewMat);
    const cookieMatrix = light.cookieMatrix;
    const rectViewport = light.atlasViewport;
    _viewportMatrix.setViewport(rectViewport.x, rectViewport.y, rectViewport.z, rectViewport.w);
    cookieMatrix.mul2(_viewportMatrix, _viewProjMat);
    return cookieMatrix;
  }
}
LightCamera.pointLightRotations = [new Quat().setFromEulerAngles(0, 90, 180), new Quat().setFromEulerAngles(0, -90, 180), new Quat().setFromEulerAngles(90, 0, 0), new Quat().setFromEulerAngles(-90, 0, 0), new Quat().setFromEulerAngles(0, 180, 180), new Quat().setFromEulerAngles(0, 0, 180)];
LightCamera._spotCookieCamera = null;

export { LightCamera };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlnaHQtY2FtZXJhLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmUvcmVuZGVyZXIvbGlnaHQtY2FtZXJhLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1YXQgfSBmcm9tICcuLi8uLi9jb3JlL21hdGgvcXVhdC5qcyc7XG5pbXBvcnQgeyBWZWMzIH0gZnJvbSAnLi4vLi4vY29yZS9tYXRoL3ZlYzMuanMnO1xuaW1wb3J0IHsgTWF0NCB9IGZyb20gJy4uLy4uL2NvcmUvbWF0aC9tYXQ0LmpzJztcblxuaW1wb3J0IHsgQVNQRUNUX01BTlVBTCwgTElHSFRUWVBFX0RJUkVDVElPTkFMLCBMSUdIVFRZUEVfT01OSSwgTElHSFRUWVBFX1NQT1QsIFBST0pFQ1RJT05fT1JUSE9HUkFQSElDLCBQUk9KRUNUSU9OX1BFUlNQRUNUSVZFIH0gZnJvbSAnLi4vY29uc3RhbnRzLmpzJztcbmltcG9ydCB7IENhbWVyYSB9IGZyb20gJy4uL2NhbWVyYS5qcyc7XG5pbXBvcnQgeyBHcmFwaE5vZGUgfSBmcm9tICcuLi9ncmFwaC1ub2RlLmpzJztcblxuY29uc3QgX3ZpZXdNYXQgPSBuZXcgTWF0NCgpO1xuY29uc3QgX3ZpZXdQcm9qTWF0ID0gbmV3IE1hdDQoKTtcbmNvbnN0IF92aWV3cG9ydE1hdHJpeCA9IG5ldyBNYXQ0KCk7XG5cbi8vIGhlbHBlciBzdGF0aWMgY2xhc3MgZm9yIHNoYXJlZCBmdW5jdGlvbmFsaXR5IGZvciBzaGFkb3cgYW5kIGNvb2tpZSBjYW1lcmFzIHVzZWQgYnkgdGhlIGxpZ2h0c1xuY2xhc3MgTGlnaHRDYW1lcmEge1xuICAgIC8vIGNhbWVyYSByb3RhdGlvbiBhbmdsZXMgdXNlZCB3aGVuIHJlbmRlcmluZyBjdWJlbWFwIGZhY2VzXG4gICAgc3RhdGljIHBvaW50TGlnaHRSb3RhdGlvbnMgPSBbXG4gICAgICAgIG5ldyBRdWF0KCkuc2V0RnJvbUV1bGVyQW5nbGVzKDAsIDkwLCAxODApLFxuICAgICAgICBuZXcgUXVhdCgpLnNldEZyb21FdWxlckFuZ2xlcygwLCAtOTAsIDE4MCksXG4gICAgICAgIG5ldyBRdWF0KCkuc2V0RnJvbUV1bGVyQW5nbGVzKDkwLCAwLCAwKSxcbiAgICAgICAgbmV3IFF1YXQoKS5zZXRGcm9tRXVsZXJBbmdsZXMoLTkwLCAwLCAwKSxcbiAgICAgICAgbmV3IFF1YXQoKS5zZXRGcm9tRXVsZXJBbmdsZXMoMCwgMTgwLCAxODApLFxuICAgICAgICBuZXcgUXVhdCgpLnNldEZyb21FdWxlckFuZ2xlcygwLCAwLCAxODApXG4gICAgXTtcblxuICAgIHN0YXRpYyBjcmVhdGUobmFtZSwgbGlnaHRUeXBlLCBmYWNlKSB7XG5cbiAgICAgICAgY29uc3QgY2FtZXJhID0gbmV3IENhbWVyYSgpO1xuICAgICAgICBjYW1lcmEubm9kZSA9IG5ldyBHcmFwaE5vZGUobmFtZSk7XG4gICAgICAgIGNhbWVyYS5hc3BlY3RSYXRpbyA9IDE7XG4gICAgICAgIGNhbWVyYS5hc3BlY3RSYXRpb01vZGUgPSBBU1BFQ1RfTUFOVUFMO1xuICAgICAgICBjYW1lcmEuX3NjaXNzb3JSZWN0Q2xlYXIgPSB0cnVlO1xuXG4gICAgICAgIC8vIHNldCB1cCBjb25zdGFudCBzZXR0aW5ncyBiYXNlZCBvbiBsaWdodCB0eXBlXG4gICAgICAgIHN3aXRjaCAobGlnaHRUeXBlKSB7XG4gICAgICAgICAgICBjYXNlIExJR0hUVFlQRV9PTU5JOlxuICAgICAgICAgICAgICAgIGNhbWVyYS5ub2RlLnNldFJvdGF0aW9uKExpZ2h0Q2FtZXJhLnBvaW50TGlnaHRSb3RhdGlvbnNbZmFjZV0pO1xuICAgICAgICAgICAgICAgIGNhbWVyYS5mb3YgPSA5MDtcbiAgICAgICAgICAgICAgICBjYW1lcmEucHJvamVjdGlvbiA9IFBST0pFQ1RJT05fUEVSU1BFQ1RJVkU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgTElHSFRUWVBFX1NQT1Q6XG4gICAgICAgICAgICAgICAgY2FtZXJhLnByb2plY3Rpb24gPSBQUk9KRUNUSU9OX1BFUlNQRUNUSVZFO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIExJR0hUVFlQRV9ESVJFQ1RJT05BTDpcbiAgICAgICAgICAgICAgICBjYW1lcmEucHJvamVjdGlvbiA9IFBST0pFQ1RJT05fT1JUSE9HUkFQSElDO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNhbWVyYTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX3Nwb3RDb29raWVDYW1lcmEgPSBudWxsO1xuXG4gICAgLy8gdGVtcG9yYXJ5IGNhbWVyYSB0byBjYWxjdWxhdGUgc3BvdCBsaWdodCBjb29raWUgdmlldy1wcm9qZWN0aW9uIG1hdHJpeCB3aGVuIHNoYWRvdyBtYXRyaXggaXMgbm90IGF2YWlsYWJsZVxuICAgIC8vIHRvZG8gLSB1bmlmeSB0aGUgY29kZSB3aXRoIHRoZSBzaGFkb3cgc3BvdCBjYW1lcmFcbiAgICBzdGF0aWMgZXZhbFNwb3RDb29raWVNYXRyaXgobGlnaHQpIHtcblxuICAgICAgICBsZXQgY29va2llQ2FtZXJhID0gTGlnaHRDYW1lcmEuX3Nwb3RDb29raWVDYW1lcmE7XG4gICAgICAgIGlmICghY29va2llQ2FtZXJhKSB7XG4gICAgICAgICAgICBjb29raWVDYW1lcmEgPSBMaWdodENhbWVyYS5jcmVhdGUoJ1Nwb3RDb29raWVDYW1lcmEnLCBMSUdIVFRZUEVfU1BPVCk7XG4gICAgICAgICAgICBMaWdodENhbWVyYS5fc3BvdENvb2tpZUNhbWVyYSA9IGNvb2tpZUNhbWVyYTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvb2tpZUNhbWVyYS5mb3YgPSBsaWdodC5fb3V0ZXJDb25lQW5nbGUgKiAyO1xuXG4gICAgICAgIGNvbnN0IGNvb2tpZU5vZGUgPSBjb29raWVDYW1lcmEuX25vZGU7XG4gICAgICAgIGNvb2tpZU5vZGUuc2V0UG9zaXRpb24obGlnaHQuX25vZGUuZ2V0UG9zaXRpb24oKSk7XG4gICAgICAgIGNvb2tpZU5vZGUuc2V0Um90YXRpb24obGlnaHQuX25vZGUuZ2V0Um90YXRpb24oKSk7XG4gICAgICAgIGNvb2tpZU5vZGUucm90YXRlTG9jYWwoLTkwLCAwLCAwKTtcblxuICAgICAgICBfdmlld01hdC5zZXRUUlMoY29va2llTm9kZS5nZXRQb3NpdGlvbigpLCBjb29raWVOb2RlLmdldFJvdGF0aW9uKCksIFZlYzMuT05FKS5pbnZlcnQoKTtcbiAgICAgICAgX3ZpZXdQcm9qTWF0Lm11bDIoY29va2llQ2FtZXJhLnByb2plY3Rpb25NYXRyaXgsIF92aWV3TWF0KTtcblxuICAgICAgICBjb25zdCBjb29raWVNYXRyaXggPSBsaWdodC5jb29raWVNYXRyaXg7XG5cbiAgICAgICAgY29uc3QgcmVjdFZpZXdwb3J0ID0gbGlnaHQuYXRsYXNWaWV3cG9ydDtcbiAgICAgICAgX3ZpZXdwb3J0TWF0cml4LnNldFZpZXdwb3J0KHJlY3RWaWV3cG9ydC54LCByZWN0Vmlld3BvcnQueSwgcmVjdFZpZXdwb3J0LnosIHJlY3RWaWV3cG9ydC53KTtcbiAgICAgICAgY29va2llTWF0cml4Lm11bDIoX3ZpZXdwb3J0TWF0cml4LCBfdmlld1Byb2pNYXQpO1xuXG4gICAgICAgIHJldHVybiBjb29raWVNYXRyaXg7XG4gICAgfVxufVxuXG5leHBvcnQgeyBMaWdodENhbWVyYSB9O1xuIl0sIm5hbWVzIjpbIl92aWV3TWF0IiwiTWF0NCIsIl92aWV3UHJvak1hdCIsIl92aWV3cG9ydE1hdHJpeCIsIkxpZ2h0Q2FtZXJhIiwiY3JlYXRlIiwibmFtZSIsImxpZ2h0VHlwZSIsImZhY2UiLCJjYW1lcmEiLCJDYW1lcmEiLCJub2RlIiwiR3JhcGhOb2RlIiwiYXNwZWN0UmF0aW8iLCJhc3BlY3RSYXRpb01vZGUiLCJBU1BFQ1RfTUFOVUFMIiwiX3NjaXNzb3JSZWN0Q2xlYXIiLCJMSUdIVFRZUEVfT01OSSIsInNldFJvdGF0aW9uIiwicG9pbnRMaWdodFJvdGF0aW9ucyIsImZvdiIsInByb2plY3Rpb24iLCJQUk9KRUNUSU9OX1BFUlNQRUNUSVZFIiwiTElHSFRUWVBFX1NQT1QiLCJMSUdIVFRZUEVfRElSRUNUSU9OQUwiLCJQUk9KRUNUSU9OX09SVEhPR1JBUEhJQyIsImV2YWxTcG90Q29va2llTWF0cml4IiwibGlnaHQiLCJjb29raWVDYW1lcmEiLCJfc3BvdENvb2tpZUNhbWVyYSIsIl9vdXRlckNvbmVBbmdsZSIsImNvb2tpZU5vZGUiLCJfbm9kZSIsInNldFBvc2l0aW9uIiwiZ2V0UG9zaXRpb24iLCJnZXRSb3RhdGlvbiIsInJvdGF0ZUxvY2FsIiwic2V0VFJTIiwiVmVjMyIsIk9ORSIsImludmVydCIsIm11bDIiLCJwcm9qZWN0aW9uTWF0cml4IiwiY29va2llTWF0cml4IiwicmVjdFZpZXdwb3J0IiwiYXRsYXNWaWV3cG9ydCIsInNldFZpZXdwb3J0IiwieCIsInkiLCJ6IiwidyIsIlF1YXQiLCJzZXRGcm9tRXVsZXJBbmdsZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQVFBLE1BQU1BLFFBQVEsR0FBRyxJQUFJQyxJQUFJLEVBQUUsQ0FBQTtBQUMzQixNQUFNQyxZQUFZLEdBQUcsSUFBSUQsSUFBSSxFQUFFLENBQUE7QUFDL0IsTUFBTUUsZUFBZSxHQUFHLElBQUlGLElBQUksRUFBRSxDQUFBOztBQUdsQyxNQUFNRyxXQUFXLENBQUM7O0FBV2QsRUFBQSxPQUFPQyxNQUFNLENBQUNDLElBQUksRUFBRUMsU0FBUyxFQUFFQyxJQUFJLEVBQUU7QUFFakMsSUFBQSxNQUFNQyxNQUFNLEdBQUcsSUFBSUMsTUFBTSxFQUFFLENBQUE7QUFDM0JELElBQUFBLE1BQU0sQ0FBQ0UsSUFBSSxHQUFHLElBQUlDLFNBQVMsQ0FBQ04sSUFBSSxDQUFDLENBQUE7SUFDakNHLE1BQU0sQ0FBQ0ksV0FBVyxHQUFHLENBQUMsQ0FBQTtJQUN0QkosTUFBTSxDQUFDSyxlQUFlLEdBQUdDLGFBQWEsQ0FBQTtJQUN0Q04sTUFBTSxDQUFDTyxpQkFBaUIsR0FBRyxJQUFJLENBQUE7O0FBRy9CLElBQUEsUUFBUVQsU0FBUztBQUNiLE1BQUEs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

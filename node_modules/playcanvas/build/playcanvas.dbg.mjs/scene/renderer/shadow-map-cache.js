/**
 * @license
 * PlayCanvas Engine v1.58.0 revision 6672f604c (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { LIGHTTYPE_OMNI } from '../constants.js';
import { ShadowMap } from './shadow-map.js';

class ShadowMapCache {
  constructor() {
    this.shadowMapCache = new Map();
  }
  destroy() {
    this.clear();
    this.shadowMapCache = null;
  }

  clear() {
    this.shadowMapCache.forEach(shadowMaps => {
      shadowMaps.forEach(shadowMap => {
        shadowMap.destroy();
      });
    });
    this.shadowMapCache.clear();
  }

  getKey(light) {
    const isCubeMap = light._type === LIGHTTYPE_OMNI;
    const shadowType = light._shadowType;
    const resolution = light._shadowResolution;
    return `${isCubeMap}-${shadowType}-${resolution}`;
  }

  get(device, light) {
    const key = this.getKey(light);
    const shadowMaps = this.shadowMapCache.get(key);
    if (shadowMaps && shadowMaps.length) {
      return shadowMaps.pop();
    }

    const shadowMap = ShadowMap.create(device, light);
    shadowMap.cached = true;
    return shadowMap;
  }

  add(light, shadowMap) {
    const key = this.getKey(light);
    const shadowMaps = this.shadowMapCache.get(key);
    if (shadowMaps) {
      shadowMaps.push(shadowMap);
    } else {
      this.shadowMapCache.set(key, [shadowMap]);
    }
  }
}

export { ShadowMapCache };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZG93LW1hcC1jYWNoZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lL3JlbmRlcmVyL3NoYWRvdy1tYXAtY2FjaGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBMSUdIVFRZUEVfT01OSVxufSBmcm9tICcuLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgU2hhZG93TWFwIH0gZnJvbSAnLi9zaGFkb3ctbWFwLmpzJztcblxuLy8gSW4gdGhlIG5vcm1hbCBjYXNlIHdoZXJlIHRoZSBsaWdodCByZW5kZXJzIGEgc2hhZG93LCB0aGUgbGlnaHQgaGFzIGEgdW5pcXVlIHNoYWRvdyBtYXAuXG4vLyBTaGFkb3dNYXBDYWNoZSBpcyB1c2VkIGluIHR3byBjYXNlczpcbi8vIDEpIGJ5IExpZ2h0bWFwcGVyIC0gd2hlbiBsaWdodHMgYXJlIGJha2VkIHRvIGxpZ2h0bWFwcyBvbmUgYXQgYSB0aW1lLCBzaGFkb3cgbWFwcyBhcmUgcmUtdXNlZFxuLy8gICAgdG8gbGltaXQgYWxsb2NhdGlvbnMuIFRob3NlIGFyZSBkZWxldGVkIHdoZW4gYmFraW5nIGlzIGRvbmUuXG4vLyAyKSBieSBTaGFkb3dSZW5kZXJlciAtIHdoZW4gVlNNIGJsdXIgaXMgZG9uZSwgYSB0ZW1wb3JhcnkgYnVmZmVyIGlzIGdyYWJiZWQgZnJvbSB0aGUgY2FjaGVcbmNsYXNzIFNoYWRvd01hcENhY2hlIHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgLy8gbWFwcyBhIHNoYWRvdyBtYXAga2V5IHRvIGFuIGFycmF5IG9mIHNoYWRvdyBtYXBzIGluIHRoZSBjYWNoZVxuICAgICAgICB0aGlzLnNoYWRvd01hcENhY2hlID0gbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5zaGFkb3dNYXBDYWNoZSA9IG51bGw7XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlIGFsbCBzaGFkb3dtYXBzIGZyb20gdGhlIGNhY2hlXG4gICAgY2xlYXIoKSB7XG4gICAgICAgIHRoaXMuc2hhZG93TWFwQ2FjaGUuZm9yRWFjaCgoc2hhZG93TWFwcykgPT4ge1xuICAgICAgICAgICAgc2hhZG93TWFwcy5mb3JFYWNoKChzaGFkb3dNYXApID0+IHtcbiAgICAgICAgICAgICAgICBzaGFkb3dNYXAuZGVzdHJveSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNoYWRvd01hcENhY2hlLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgLy8gZ2VuZXJhdGVzIGEgc3RyaW5nIGtleSBmb3IgdGhlIHNoYWRvdyBtYXAgcmVxdWlyZWQgYnkgdGhlIGxpZ2h0XG4gICAgZ2V0S2V5KGxpZ2h0KSB7XG4gICAgICAgIGNvbnN0IGlzQ3ViZU1hcCA9IGxpZ2h0Ll90eXBlID09PSBMSUdIVFRZUEVfT01OSTtcbiAgICAgICAgY29uc3Qgc2hhZG93VHlwZSA9IGxpZ2h0Ll9zaGFkb3dUeXBlO1xuICAgICAgICBjb25zdCByZXNvbHV0aW9uID0gbGlnaHQuX3NoYWRvd1Jlc29sdXRpb247XG4gICAgICAgIHJldHVybiBgJHtpc0N1YmVNYXB9LSR7c2hhZG93VHlwZX0tJHtyZXNvbHV0aW9ufWA7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJucyBzaGFkb3cgbWFwIGZyb20gdGhlIGNhY2hlLCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiBub25lIGF2YWlsYWJsZVxuICAgIGdldChkZXZpY2UsIGxpZ2h0KSB7XG5cbiAgICAgICAgLy8gZ2V0IG1hdGNoaW5nIHNoYWRvdyBidWZmZXIgZnJvbSB0aGUgY2FjaGVcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5nZXRLZXkobGlnaHQpO1xuICAgICAgICBjb25zdCBzaGFkb3dNYXBzID0gdGhpcy5zaGFkb3dNYXBDYWNoZS5nZXQoa2V5KTtcbiAgICAgICAgaWYgKHNoYWRvd01hcHMgJiYgc2hhZG93TWFwcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBzaGFkb3dNYXBzLnBvcCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gY3JlYXRlIG5ldyBvbmUgaWYgbm90IGluIGNhY2hlXG4gICAgICAgIGNvbnN0IHNoYWRvd01hcCA9IFNoYWRvd01hcC5jcmVhdGUoZGV2aWNlLCBsaWdodCk7XG4gICAgICAgIHNoYWRvd01hcC5jYWNoZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm4gc2hhZG93TWFwO1xuICAgIH1cblxuICAgIC8vIHJldHVybnMgc2hhZG93IG1hcCBmb3IgdGhlIGxpZ2h0IGJhY2sgdG8gdGhlIGNhY2hlXG4gICAgYWRkKGxpZ2h0LCBzaGFkb3dNYXApIHtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5nZXRLZXkobGlnaHQpO1xuICAgICAgICBjb25zdCBzaGFkb3dNYXBzID0gdGhpcy5zaGFkb3dNYXBDYWNoZS5nZXQoa2V5KTtcbiAgICAgICAgaWYgKHNoYWRvd01hcHMpIHtcbiAgICAgICAgICAgIHNoYWRvd01hcHMucHVzaChzaGFkb3dNYXApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zaGFkb3dNYXBDYWNoZS5zZXQoa2V5LCBbc2hhZG93TWFwXSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCB7IFNoYWRvd01hcENhY2hlIH07XG4iXSwibmFtZXMiOlsiU2hhZG93TWFwQ2FjaGUiLCJjb25zdHJ1Y3RvciIsInNoYWRvd01hcENhY2hlIiwiTWFwIiwiZGVzdHJveSIsImNsZWFyIiwiZm9yRWFjaCIsInNoYWRvd01hcHMiLCJzaGFkb3dNYXAiLCJnZXRLZXkiLCJsaWdodCIsImlzQ3ViZU1hcCIsIl90eXBlIiwiTElHSFRUWVBFX09NTkkiLCJzaGFkb3dUeXBlIiwiX3NoYWRvd1R5cGUiLCJyZXNvbHV0aW9uIiwiX3NoYWRvd1Jlc29sdXRpb24iLCJnZXQiLCJkZXZpY2UiLCJrZXkiLCJsZW5ndGgiLCJwb3AiLCJTaGFkb3dNYXAiLCJjcmVhdGUiLCJjYWNoZWQiLCJhZGQiLCJwdXNoIiwic2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQVVBLE1BQU1BLGNBQWMsQ0FBQztBQUNqQkMsRUFBQUEsV0FBVyxHQUFHO0FBRVYsSUFBQSxJQUFJLENBQUNDLGNBQWMsR0FBRyxJQUFJQyxHQUFHLEVBQUUsQ0FBQTtBQUNuQyxHQUFBO0FBRUFDLEVBQUFBLE9BQU8sR0FBRztJQUNOLElBQUksQ0FBQ0MsS0FBSyxFQUFFLENBQUE7SUFDWixJQUFJLENBQUNILGNBQWMsR0FBRyxJQUFJLENBQUE7QUFDOUIsR0FBQTs7QUFHQUcsRUFBQUEsS0FBSyxHQUFHO0FBQ0osSUFBQSxJQUFJLENBQUNILGNBQWMsQ0FBQ0ksT0FBTyxDQUFFQyxVQUFVLElBQUs7QUFDeENBLE1BQUFBLFVBQVUsQ0FBQ0QsT0FBTyxDQUFFRSxTQUFTLElBQUs7UUFDOUJBLFNBQVMsQ0FBQ0osT0FBTyxFQUFFLENBQUE7QUFDdkIsT0FBQyxDQUFDLENBQUE7QUFDTixLQUFDLENBQUMsQ0FBQTtBQUNGLElBQUEsSUFBSSxDQUFDRixjQUFjLENBQUNHLEtBQUssRUFBRSxDQUFBO0FBQy9CLEdBQUE7O0VBR0FJLE1BQU0sQ0FBQ0MsS0FBSyxFQUFFO0FBQ1YsSUFBQSxNQUFNQyxTQUFTLEdBQUdELEtBQUssQ0FBQ0UsS0FBSyxLQUFLQyxjQUFjLENBQUE7QUFDaEQsSUFBQSxNQUFNQyxVQUFVLEdBQUdKLEtBQUssQ0FBQ0ssV0FBVyxDQUFBO0FBQ3BDLElBQUEsTUFBTUMsVUFBVSxHQUFHTixLQUFLLENBQUNPLGlCQUFpQixDQUFBO0FBQzFDLElBQUEsT0FBUSxHQUFFTixTQUFVLENBQUEsQ0FBQSxFQUFHRyxVQUFXLENBQUEsQ0FBQSxFQUFHRSxVQUFXLENBQUMsQ0FBQSxDQUFBO0FBQ3JELEdBQUE7O0FBR0FFLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBTSxFQUFFVCxLQUFLLEVBQUU7QUFHZixJQUFBLE1BQU1VLEdBQUcsR0FBRyxJQUFJLENBQUNYLE1BQU0sQ0FBQ0MsS0FBSyxDQUFDLENBQUE7SUFDOUIsTUFBTUgsVUFBVSxHQUFHLElBQUksQ0FBQ0wsY0FBYyxDQUFDZ0IsR0FBRyxDQUFDRSxHQUFHLENBQUMsQ0FBQTtBQUMvQyxJQUFBLElBQUliLFVBQVUsSUFBSUEsVUFBVSxDQUFDYyxNQUFNLEVBQUU7TUFDakMsT0FBT2QsVUFBVSxDQUFDZSxHQUFHLEVBQUUsQ0FBQTtBQUMzQixLQUFBOztJQUdBLE1BQU1kLFNBQVMsR0FBR2UsU0FBUyxDQUFDQyxNQUFNLENBQUNMLE1BQU0sRUFBRVQsS0FBSyxDQUFDLENBQUE7SUFDakRGLFNBQVMsQ0FBQ2lCLE1BQU0sR0FBRyxJQUFJLENBQUE7QUFDdkIsSUFBQSxPQUFPakIsU0FBUyxDQUFBO0FBQ3BCLEdBQUE7O0FBR0FrQixFQUFBQSxHQUFHLENBQUNoQixLQUFLLEVBQUVGLFNBQVMsRUFBRTtBQUNsQixJQUFBLE1BQU1ZLEdBQUcsR0FBRyxJQUFJLENBQUNYLE1BQU0sQ0FBQ0MsS0FBSyxDQUFDLENBQUE7SUFDOUIsTUFBTUgsVUFBVSxHQUFHLElBQUksQ0FBQ0wsY0FBYyxDQUFDZ0IsR0FBRyxDQUFDRSxHQUFHLENBQUMsQ0FBQTtBQUMvQyxJQUFBLElBQUliLFVBQVUsRUFBRTtBQUNaQSxNQUFBQSxVQUFVLENBQUNvQixJQUFJLENBQUNuQixTQUFTLENBQUMsQ0FBQTtBQUM5QixLQUFDLE1BQU07TUFDSCxJQUFJLENBQUNOLGNBQWMsQ0FBQzBCLEdBQUcsQ0FBQ1IsR0FBRyxFQUFFLENBQUNaLFNBQVMsQ0FBQyxDQUFDLENBQUE7QUFDN0MsS0FBQTtBQUNKLEdBQUE7QUFDSjs7OzsifQ==

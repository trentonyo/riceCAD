/**
 * @license
 * PlayCanvas Engine v1.58.0 revision 6672f604c (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { PIXELFORMAT_R8_G8_B8_A8, PIXELFORMAT_R8_G8_B8, FILTER_NEAREST, FILTER_LINEAR_MIPMAP_LINEAR, FILTER_LINEAR, ADDRESS_CLAMP_TO_EDGE, PIXELFORMAT_DEPTHSTENCIL } from '../../platform/graphics/constants.js';
import { RenderTarget } from '../../platform/graphics/render-target.js';
import { Texture } from '../../platform/graphics/texture.js';
import { DebugGraphics } from '../../platform/graphics/debug-graphics.js';
import { LAYERID_DEPTH, SHADER_DEPTH, LAYERID_WORLD } from '../../scene/constants.js';
import { Layer } from '../../scene/layer.js';

const _depthUniformNames = ['uSceneDepthMap', 'uDepthMap'];
const _colorUniformNames = ['uSceneColorMap', 'texture_grabPass'];

class SceneGrab {
  constructor(application) {
    this.application = application;

    this.device = application.graphicsDevice;

    this.layer = null;

    this.colorFormat = this.device.defaultFramebufferAlpha ? PIXELFORMAT_R8_G8_B8_A8 : PIXELFORMAT_R8_G8_B8;

    if (this.device.webgl2) {
      this.initWebGl2();
    } else {
      this.initWebGl1();
    }
  }
  setupUniform(device, depth, buffer) {
    const names = depth ? _depthUniformNames : _colorUniformNames;
    names.forEach(name => device.scope.resolve(name).setValue(buffer));
  }
  allocateTexture(device, source, name, format, isDepth, mipmaps) {
    return new Texture(device, {
      name,
      format,
      width: source ? source.colorBuffer.width : device.width,
      height: source ? source.colorBuffer.height : device.height,
      mipmaps,
      minFilter: isDepth ? FILTER_NEAREST : mipmaps ? FILTER_LINEAR_MIPMAP_LINEAR : FILTER_LINEAR,
      magFilter: isDepth ? FILTER_NEAREST : FILTER_LINEAR,
      addressU: ADDRESS_CLAMP_TO_EDGE,
      addressV: ADDRESS_CLAMP_TO_EDGE
    });
  }
  resizeCondition(target, source, device) {
    const width = (source == null ? void 0 : source.width) || device.width;
    const height = (source == null ? void 0 : source.height) || device.height;
    return !target || width !== target.width || height !== target.height;
  }
  allocateRenderTarget(renderTarget, sourceRenderTarget, device, format, isDepth, mipmaps, isDepthUniforms) {
    const names = isDepthUniforms ? _depthUniformNames : _colorUniformNames;

    const buffer = this.allocateTexture(device, sourceRenderTarget, names[0], format, isDepth, mipmaps);
    if (renderTarget) {
      renderTarget.destroyFrameBuffers();

      if (isDepth) {
        renderTarget._depthBuffer = buffer;
      } else {
        renderTarget._colorBuffer = buffer;
      }
    } else {
      renderTarget = new RenderTarget({
        name: 'renderTargetSceneGrab',
        colorBuffer: isDepth ? null : buffer,
        depthBuffer: isDepth ? buffer : null,
        depth: !isDepth,
        stencil: device.supportsStencil,
        autoResolve: false
      });
    }
    return renderTarget;
  }
  releaseRenderTarget(rt) {
    if (rt) {
      rt.destroyTextureBuffers();
      rt.destroy();
    }
  }
  initWebGl2() {
    const app = this.application;
    const self = this;

    this.layer = new Layer({
      enabled: false,
      name: "Depth",
      id: LAYERID_DEPTH,
      onDisable: function () {
        self.releaseRenderTarget(this.depthRenderTarget);
        this.depthRenderTarget = null;
        self.releaseRenderTarget(this.colorRenderTarget);
        this.colorRenderTarget = null;
      },
      onPreRenderOpaque: function (cameraPass) {

        const device = app.graphicsDevice;

        const camera = this.cameras[cameraPass];
        if (camera.renderSceneColorMap) {
          var _camera$renderTarget;
          if (self.resizeCondition(this.colorRenderTarget, (_camera$renderTarget = camera.renderTarget) == null ? void 0 : _camera$renderTarget.colorBuffer, device)) {
            self.releaseRenderTarget(this.colorRenderTarget);
            this.colorRenderTarget = self.allocateRenderTarget(this.colorRenderTarget, camera.renderTarget, device, this.colorFormat, false, true, false);
          }

          DebugGraphics.pushGpuMarker(device, 'GRAB-COLOR');
          device.copyRenderTarget(device.renderTarget, this.colorRenderTarget, true, false);

          device.activeTexture(device.maxCombinedTextures - 1);
          const colorBuffer = this.colorRenderTarget.colorBuffer;
          device.bindTexture(colorBuffer);
          device.gl.generateMipmap(colorBuffer.impl._glTarget);
          DebugGraphics.popGpuMarker(device);

          self.setupUniform(device, false, colorBuffer);
        }
        if (camera.renderSceneDepthMap) {
          var _camera$renderTarget2;
          if (self.resizeCondition(this.depthRenderTarget, (_camera$renderTarget2 = camera.renderTarget) == null ? void 0 : _camera$renderTarget2.depthBuffer, device)) {
            self.releaseRenderTarget(this.depthRenderTarget);
            this.depthRenderTarget = self.allocateRenderTarget(this.depthRenderTarget, camera.renderTarget, device, PIXELFORMAT_DEPTHSTENCIL, true, false, true);
          }

          DebugGraphics.pushGpuMarker(device, 'GRAB-DEPTH');
          device.copyRenderTarget(device.renderTarget, this.depthRenderTarget, false, true);
          DebugGraphics.popGpuMarker(device);

          self.setupUniform(device, true, this.depthRenderTarget.depthBuffer);
        }
      },
      onPostRenderOpaque: function (cameraPass) {}
    });
  }
  initWebGl1() {
    const app = this.application;
    const self = this;

    this.layer = new Layer({
      enabled: false,
      name: "Depth",
      id: LAYERID_DEPTH,
      shaderPass: SHADER_DEPTH,
      onEnable: function () {
        this.depthRenderTarget = new RenderTarget({
          name: 'depthRenderTarget-webgl1',
          depth: true,
          stencil: app.graphicsDevice.supportsStencil,
          autoResolve: false,
          graphicsDevice: app.graphicsDevice
        });

        this.renderTarget = this.depthRenderTarget;
      },
      onDisable: function () {
        this.depthRenderTarget.destroyTextureBuffers();
        this.renderTarget = null;
        self.releaseRenderTarget(this.colorRenderTarget);
        this.colorRenderTarget = null;
      },
      onPostCull: function (cameraPass) {
        const device = app.graphicsDevice;

        const camera = this.cameras[cameraPass];
        if (camera.renderSceneDepthMap) {
          var _camera$renderTarget3;
          if (self.resizeCondition(this.depthRenderTarget, (_camera$renderTarget3 = camera.renderTarget) == null ? void 0 : _camera$renderTarget3.depthBuffer, device)) {
            this.depthRenderTarget.destroyTextureBuffers();
            this.depthRenderTarget = self.allocateRenderTarget(this.depthRenderTarget, camera.renderTarget, device, PIXELFORMAT_R8_G8_B8_A8, false, false, true);
          }

          const visibleObjects = this.instances.visibleOpaque[cameraPass];
          const visibleList = visibleObjects.list;
          const layerComposition = app.scene.layers;
          const subLayerEnabled = layerComposition.subLayerEnabled;
          const isTransparent = layerComposition.subLayerList;

          const rt = app.scene.layers.getLayerById(LAYERID_WORLD).renderTarget;
          const cam = this.cameras[cameraPass];
          let visibleLength = 0;
          const layers = layerComposition.layerList;
          for (let i = 0; i < layers.length; i++) {
            const layer = layers[i];
            if (layer === this) break;
            if (layer.renderTarget !== rt || !layer.enabled || !subLayerEnabled[i]) continue;
            const layerCamId = layer.cameras.indexOf(cam);
            if (layerCamId < 0) continue;
            const transparent = isTransparent[i];
            let layerVisibleList = transparent ? layer.instances.visibleTransparent[layerCamId] : layer.instances.visibleOpaque[layerCamId];
            const layerVisibleListLength = layerVisibleList.length;
            layerVisibleList = layerVisibleList.list;
            for (let j = 0; j < layerVisibleListLength; j++) {
              const drawCall = layerVisibleList[j];
              if (drawCall.material && drawCall.material.depthWrite && !drawCall._noDepthDrawGl1) {
                visibleList[visibleLength] = drawCall;
                visibleLength++;
              }
            }
          }
          visibleObjects.length = visibleLength;
        }
      },
      onPreRenderOpaque: function (cameraPass) {
        const device = app.graphicsDevice;

        const camera = this.cameras[cameraPass];
        if (camera.renderSceneColorMap) {
          var _camera$renderTarget4;
          if (self.resizeCondition(this.colorRenderTarget, (_camera$renderTarget4 = camera.renderTarget) == null ? void 0 : _camera$renderTarget4.colorBuffer, device)) {
            self.releaseRenderTarget(this.colorRenderTarget);
            this.colorRenderTarget = self.allocateRenderTarget(this.colorRenderTarget, camera.renderTarget, device, this.colorFormat, false, false, false);
          }

          DebugGraphics.pushGpuMarker(device, 'GRAB-COLOR');

          const colorBuffer = this.colorRenderTarget._colorBuffer;
          if (!colorBuffer.impl._glTexture) {
            colorBuffer.impl.initialize(device, colorBuffer);
          }

          device.bindTexture(colorBuffer);
          const gl = device.gl;
          gl.copyTexImage2D(gl.TEXTURE_2D, 0, colorBuffer.impl._glFormat, 0, 0, colorBuffer.width, colorBuffer.height, 0);

          colorBuffer._needsUpload = false;
          colorBuffer._needsMipmapsUpload = false;
          DebugGraphics.popGpuMarker(device);

          self.setupUniform(device, false, colorBuffer);
        }
        if (camera.renderSceneDepthMap) {
          self.setupUniform(device, true, this.depthRenderTarget.colorBuffer);
        }
      },
      onDrawCall: function () {
        app.graphicsDevice.setColorWrite(true, true, true, true);
      },
      onPostRenderOpaque: function (cameraPass) {
        const camera = this.cameras[cameraPass];
        if (camera.renderSceneDepthMap) {
          const visibleObjects = this.instances.visibleOpaque[cameraPass];
          visibleObjects.length = 0;
        }
      }
    });
  }

  patch(layer) {
    layer.onEnable = this.layer.onEnable;
    layer.onDisable = this.layer.onDisable;
    layer.onPreRenderOpaque = this.layer.onPreRenderOpaque;
    layer.onPostRenderOpaque = this.layer.onPostRenderOpaque;
    layer.shaderPass = this.layer.shaderPass;
    layer.onPostCull = this.layer.onPostCull;
    layer.onDrawCall = this.layer.onDrawCall;
  }
}

export { SceneGrab };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmUtZ3JhYi5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2ZyYW1ld29yay9ncmFwaGljcy9zY2VuZS1ncmFiLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQUREUkVTU19DTEFNUF9UT19FREdFLFxuICAgIEZJTFRFUl9ORUFSRVNULCBGSUxURVJfTElORUFSLCBGSUxURVJfTElORUFSX01JUE1BUF9MSU5FQVIsXG4gICAgUElYRUxGT1JNQVRfREVQVEhTVEVOQ0lMLCBQSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgUElYRUxGT1JNQVRfUjhfRzhfQjhcbn0gZnJvbSAnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvY29uc3RhbnRzLmpzJztcblxuaW1wb3J0IHsgUmVuZGVyVGFyZ2V0IH0gZnJvbSAnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvcmVuZGVyLXRhcmdldC5qcyc7XG5pbXBvcnQgeyBUZXh0dXJlIH0gZnJvbSAnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvdGV4dHVyZS5qcyc7XG5pbXBvcnQgeyBEZWJ1Z0dyYXBoaWNzIH0gZnJvbSAnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvZGVidWctZ3JhcGhpY3MuanMnO1xuXG5pbXBvcnQge1xuICAgIExBWUVSSURfREVQVEgsIExBWUVSSURfV09STEQsXG4gICAgU0hBREVSX0RFUFRIXG59IGZyb20gJy4uLy4uL3NjZW5lL2NvbnN0YW50cy5qcyc7XG5cbmltcG9ydCB7IExheWVyIH0gZnJvbSAnLi4vLi4vc2NlbmUvbGF5ZXIuanMnO1xuXG4vKiogQHR5cGVkZWYge2ltcG9ydCgnLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvZ3JhcGhpY3MtZGV2aWNlLmpzJykuR3JhcGhpY3NEZXZpY2V9IEdyYXBoaWNzRGV2aWNlICovXG4vKiogQHR5cGVkZWYge2ltcG9ydCgnLi4vY29tcG9uZW50cy9jYW1lcmEvY29tcG9uZW50LmpzJykuQ2FtZXJhQ29tcG9uZW50fSBDYW1lcmFDb21wb25lbnQgKi9cblxuLy8gdW5pZm9ybSBuYW1lcyAoZmlyc3QgaXMgY3VycmVudCBuYW1lLCBzZWNvbmQgb25lIGlzIGRlcHJlY2F0ZWQgbmFtZSBmb3IgY29tcGF0aWJpbGl0eSlcbmNvbnN0IF9kZXB0aFVuaWZvcm1OYW1lcyA9IFsndVNjZW5lRGVwdGhNYXAnLCAndURlcHRoTWFwJ107XG5jb25zdCBfY29sb3JVbmlmb3JtTmFtZXMgPSBbJ3VTY2VuZUNvbG9yTWFwJywgJ3RleHR1cmVfZ3JhYlBhc3MnXTtcblxuLyoqXG4gKiBJbnRlcm5hbCBjbGFzcyBhYnN0cmFjdGluZyB0aGUgYWNjZXNzIHRvIHRoZSBkZXB0aCBhbmQgY29sb3IgdGV4dHVyZSBvZiB0aGUgc2NlbmUuXG4gKiBjb2xvciBmcmFtZSBidWZmZXIgaXMgY29waWVkIHRvIGEgdGV4dHVyZVxuICogRm9yIHdlYmdsIDIgZGV2aWNlcywgdGhlIGRlcHRoIGJ1ZmZlciBpcyBjb3BpZWQgdG8gYSB0ZXh0dXJlXG4gKiBmb3Igd2ViZ2wgMSBkZXZpY2VzLCB0aGUgc2NlbmUncyBkZXB0aCBpcyByZW5kZXJlZCB0byBhIHNlcGFyYXRlIFJHQkEgdGV4dHVyZVxuICpcbiAqIFRPRE86IGltcGxlbWVudCBtaXBtYXBwZWQgY29sb3IgYnVmZmVyIHN1cHBvcnQgZm9yIFdlYkdMIDEgYXMgd2VsbCwgd2hpY2ggcmVxdWlyZXNcbiAqIHRoZSB0ZXh0dXJlIHRvIGJlIGEgcG93ZXIgb2YgdHdvLCBieSBmaXJzdCBkb3duc2NhbGluZyB0aGUgY2FwdHVyZWQgZnJhbWVidWZmZXJcbiAqIHRleHR1cmUgdG8gc21hbGxlciBwb3dlciBvZiAyIHRleHR1cmUsIGFuZCB0aGVuIGdlbmVyYXRlIG1pcG1hcHMgYW5kIHVzZSBpdCBmb3IgcmVuZGVyaW5nXG4gKiBUT0RPOiBvciBldmVuIGJldHRlciwgaW1wbGVtZW50IGJsdXIgZmlsdGVyIHRvIGhhdmUgc21vb3RoZXIgbG93ZXIgbGV2ZWxzXG4gKlxuICogQGlnbm9yZVxuICovXG5jbGFzcyBTY2VuZUdyYWIge1xuICAgIGNvbnN0cnVjdG9yKGFwcGxpY2F0aW9uKSB7XG4gICAgICAgIHRoaXMuYXBwbGljYXRpb24gPSBhcHBsaWNhdGlvbjtcblxuICAgICAgICAvKiogQHR5cGUge0dyYXBoaWNzRGV2aWNlfSAqL1xuICAgICAgICB0aGlzLmRldmljZSA9IGFwcGxpY2F0aW9uLmdyYXBoaWNzRGV2aWNlO1xuXG4gICAgICAgIC8vIGNyZWF0ZSBkZXB0aCBsYXllclxuICAgICAgICB0aGlzLmxheWVyID0gbnVsbDtcblxuICAgICAgICAvLyBjb2xvciBidWZmZXIgZm9ybWF0XG4gICAgICAgIHRoaXMuY29sb3JGb3JtYXQgPSB0aGlzLmRldmljZS5kZWZhdWx0RnJhbWVidWZmZXJBbHBoYSA/IFBJWEVMRk9STUFUX1I4X0c4X0I4X0E4IDogUElYRUxGT1JNQVRfUjhfRzhfQjg7XG5cbiAgICAgICAgLy8gY3JlYXRlIGEgZGVwdGggbGF5ZXIsIHdoaWNoIGlzIGEgZGVmYXVsdCBkZXB0aCBsYXllciwgYnV0IGFsc28gYSB0ZW1wbGF0ZSB1c2VkXG4gICAgICAgIC8vIHRvIHBhdGNoIGFwcGxpY2F0aW9uIGNyZWF0ZWQgZGVwdGggbGF5ZXJzIHRvIGJlaGF2ZSBhcyBvbmVcbiAgICAgICAgaWYgKHRoaXMuZGV2aWNlLndlYmdsMikge1xuICAgICAgICAgICAgdGhpcy5pbml0V2ViR2wyKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmluaXRXZWJHbDEoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldHVwVW5pZm9ybShkZXZpY2UsIGRlcHRoLCBidWZmZXIpIHtcblxuICAgICAgICAvLyBhc3NpZ24gaXQgdG8gc2NvcGVzIHRvIGV4cG9zZSBpdCB0byBzaGFkZXJzXG4gICAgICAgIGNvbnN0IG5hbWVzID0gZGVwdGggPyBfZGVwdGhVbmlmb3JtTmFtZXMgOiBfY29sb3JVbmlmb3JtTmFtZXM7XG4gICAgICAgIG5hbWVzLmZvckVhY2gobmFtZSA9PiBkZXZpY2Uuc2NvcGUucmVzb2x2ZShuYW1lKS5zZXRWYWx1ZShidWZmZXIpKTtcbiAgICB9XG5cbiAgICBhbGxvY2F0ZVRleHR1cmUoZGV2aWNlLCBzb3VyY2UsIG5hbWUsIGZvcm1hdCwgaXNEZXB0aCwgbWlwbWFwcykge1xuXG4gICAgICAgIC8vIGFsbG9jYXRlIHRleHR1cmUgdGhhdCB3aWxsIHN0b3JlIHRoZSBkZXB0aFxuICAgICAgICByZXR1cm4gbmV3IFRleHR1cmUoZGV2aWNlLCB7XG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgZm9ybWF0LFxuICAgICAgICAgICAgd2lkdGg6IHNvdXJjZSA/IHNvdXJjZS5jb2xvckJ1ZmZlci53aWR0aCA6IGRldmljZS53aWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogc291cmNlID8gc291cmNlLmNvbG9yQnVmZmVyLmhlaWdodCA6IGRldmljZS5oZWlnaHQsXG4gICAgICAgICAgICBtaXBtYXBzLFxuICAgICAgICAgICAgbWluRmlsdGVyOiBpc0RlcHRoID8gRklMVEVSX05FQVJFU1QgOiAobWlwbWFwcyA/IEZJTFRFUl9MSU5FQVJfTUlQTUFQX0xJTkVBUiA6IEZJTFRFUl9MSU5FQVIpLFxuICAgICAgICAgICAgbWFnRmlsdGVyOiBpc0RlcHRoID8gRklMVEVSX05FQVJFU1QgOiBGSUxURVJfTElORUFSLFxuICAgICAgICAgICAgYWRkcmVzc1U6IEFERFJFU1NfQ0xBTVBfVE9fRURHRSxcbiAgICAgICAgICAgIGFkZHJlc3NWOiBBRERSRVNTX0NMQU1QX1RPX0VER0VcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmVzaXplQ29uZGl0aW9uKHRhcmdldCwgc291cmNlLCBkZXZpY2UpIHtcbiAgICAgICAgY29uc3Qgd2lkdGggPSBzb3VyY2U/LndpZHRoIHx8IGRldmljZS53aWR0aDtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gc291cmNlPy5oZWlnaHQgfHwgZGV2aWNlLmhlaWdodDtcbiAgICAgICAgcmV0dXJuICF0YXJnZXQgfHwgd2lkdGggIT09IHRhcmdldC53aWR0aCB8fCBoZWlnaHQgIT09IHRhcmdldC5oZWlnaHQ7XG4gICAgfVxuXG4gICAgYWxsb2NhdGVSZW5kZXJUYXJnZXQocmVuZGVyVGFyZ2V0LCBzb3VyY2VSZW5kZXJUYXJnZXQsIGRldmljZSwgZm9ybWF0LCBpc0RlcHRoLCBtaXBtYXBzLCBpc0RlcHRoVW5pZm9ybXMpIHtcblxuICAgICAgICAvLyB0ZXh0dXJlIC8gdW5pZm9ybSBuYW1lczogbmV3IG9uZSAoZmlyc3QpLCBhcyB3ZWxsIGFzIG9sZCBvbmUgIChzZWNvbmQpIGZvciBjb21wYXRpYmlsaXR5XG4gICAgICAgIGNvbnN0IG5hbWVzID0gaXNEZXB0aFVuaWZvcm1zID8gX2RlcHRoVW5pZm9ybU5hbWVzIDogX2NvbG9yVW5pZm9ybU5hbWVzO1xuXG4gICAgICAgIC8vIGFsbG9jYXRlIHRleHR1cmUgYnVmZmVyXG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuYWxsb2NhdGVUZXh0dXJlKGRldmljZSwgc291cmNlUmVuZGVyVGFyZ2V0LCBuYW1lc1swXSwgZm9ybWF0LCBpc0RlcHRoLCBtaXBtYXBzKTtcblxuICAgICAgICBpZiAocmVuZGVyVGFyZ2V0KSB7XG5cbiAgICAgICAgICAgIC8vIGlmIHJlYWxsb2NhdGluZyBSVCBzaXplLCByZWxlYXNlIHByZXZpb3VzIGZyYW1lYnVmZmVyXG4gICAgICAgICAgICByZW5kZXJUYXJnZXQuZGVzdHJveUZyYW1lQnVmZmVycygpO1xuXG4gICAgICAgICAgICAvLyBhc3NpZ24gbmV3IHRleHR1cmVcbiAgICAgICAgICAgIGlmIChpc0RlcHRoKSB7XG4gICAgICAgICAgICAgICAgcmVuZGVyVGFyZ2V0Ll9kZXB0aEJ1ZmZlciA9IGJ1ZmZlcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVuZGVyVGFyZ2V0Ll9jb2xvckJ1ZmZlciA9IGJ1ZmZlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgLy8gY3JlYXRlIG5ldyByZW5kZXIgdGFyZ2V0IHdpdGggdGhlIHRleHR1cmVcbiAgICAgICAgICAgIHJlbmRlclRhcmdldCA9IG5ldyBSZW5kZXJUYXJnZXQoe1xuICAgICAgICAgICAgICAgIG5hbWU6ICdyZW5kZXJUYXJnZXRTY2VuZUdyYWInLFxuICAgICAgICAgICAgICAgIGNvbG9yQnVmZmVyOiBpc0RlcHRoID8gbnVsbCA6IGJ1ZmZlcixcbiAgICAgICAgICAgICAgICBkZXB0aEJ1ZmZlcjogaXNEZXB0aCA/IGJ1ZmZlciA6IG51bGwsXG4gICAgICAgICAgICAgICAgZGVwdGg6ICFpc0RlcHRoLFxuICAgICAgICAgICAgICAgIHN0ZW5jaWw6IGRldmljZS5zdXBwb3J0c1N0ZW5jaWwsXG4gICAgICAgICAgICAgICAgYXV0b1Jlc29sdmU6IGZhbHNlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZW5kZXJUYXJnZXQ7XG4gICAgfVxuXG4gICAgcmVsZWFzZVJlbmRlclRhcmdldChydCkge1xuXG4gICAgICAgIGlmIChydCkge1xuICAgICAgICAgICAgcnQuZGVzdHJveVRleHR1cmVCdWZmZXJzKCk7XG4gICAgICAgICAgICBydC5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpbml0V2ViR2wyKCkge1xuXG4gICAgICAgIGNvbnN0IGFwcCA9IHRoaXMuYXBwbGljYXRpb247XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIC8vIFdlYkdMIDIgZGVwdGggbGF5ZXIganVzdCBjb3BpZXMgZXhpc3RpbmcgY29sb3Igb3IgZGVwdGhcbiAgICAgICAgdGhpcy5sYXllciA9IG5ldyBMYXllcih7XG4gICAgICAgICAgICBlbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgIG5hbWU6IFwiRGVwdGhcIixcbiAgICAgICAgICAgIGlkOiBMQVlFUklEX0RFUFRILFxuXG4gICAgICAgICAgICBvbkRpc2FibGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzZWxmLnJlbGVhc2VSZW5kZXJUYXJnZXQodGhpcy5kZXB0aFJlbmRlclRhcmdldCk7XG4gICAgICAgICAgICAgICAgdGhpcy5kZXB0aFJlbmRlclRhcmdldCA9IG51bGw7XG5cbiAgICAgICAgICAgICAgICBzZWxmLnJlbGVhc2VSZW5kZXJUYXJnZXQodGhpcy5jb2xvclJlbmRlclRhcmdldCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvclJlbmRlclRhcmdldCA9IG51bGw7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvblByZVJlbmRlck9wYXF1ZTogZnVuY3Rpb24gKGNhbWVyYVBhc3MpIHsgLy8gcmVzaXplIGRlcHRoIG1hcCBpZiBuZWVkZWRcblxuICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7R3JhcGhpY3NEZXZpY2V9ICovXG4gICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlID0gYXBwLmdyYXBoaWNzRGV2aWNlO1xuXG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHtDYW1lcmFDb21wb25lbnR9ICovXG4gICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gdGhpcy5jYW1lcmFzW2NhbWVyYVBhc3NdO1xuXG4gICAgICAgICAgICAgICAgaWYgKGNhbWVyYS5yZW5kZXJTY2VuZUNvbG9yTWFwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gYWxsb2NhdGUgLyByZXNpemUgZXhpc3RpbmcgUlQgYXMgbmVlZGVkXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnJlc2l6ZUNvbmRpdGlvbih0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0LCBjYW1lcmEucmVuZGVyVGFyZ2V0Py5jb2xvckJ1ZmZlciwgZGV2aWNlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWxlYXNlUmVuZGVyVGFyZ2V0KHRoaXMuY29sb3JSZW5kZXJUYXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvclJlbmRlclRhcmdldCA9IHNlbGYuYWxsb2NhdGVSZW5kZXJUYXJnZXQodGhpcy5jb2xvclJlbmRlclRhcmdldCwgY2FtZXJhLnJlbmRlclRhcmdldCwgZGV2aWNlLCB0aGlzLmNvbG9yRm9ybWF0LCBmYWxzZSwgdHJ1ZSwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY29weSBjb2xvciBmcm9tIHRoZSBjdXJyZW50IHJlbmRlciB0YXJnZXRcbiAgICAgICAgICAgICAgICAgICAgRGVidWdHcmFwaGljcy5wdXNoR3B1TWFya2VyKGRldmljZSwgJ0dSQUItQ09MT1InKTtcblxuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuY29weVJlbmRlclRhcmdldChkZXZpY2UucmVuZGVyVGFyZ2V0LCB0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0LCB0cnVlLCBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZ2VuZXJhdGUgbWlwbWFwc1xuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuYWN0aXZlVGV4dHVyZShkZXZpY2UubWF4Q29tYmluZWRUZXh0dXJlcyAtIDEpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvckJ1ZmZlciA9IHRoaXMuY29sb3JSZW5kZXJUYXJnZXQuY29sb3JCdWZmZXI7XG4gICAgICAgICAgICAgICAgICAgIGRldmljZS5iaW5kVGV4dHVyZShjb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgICAgIGRldmljZS5nbC5nZW5lcmF0ZU1pcG1hcChjb2xvckJ1ZmZlci5pbXBsLl9nbFRhcmdldCk7XG5cbiAgICAgICAgICAgICAgICAgICAgRGVidWdHcmFwaGljcy5wb3BHcHVNYXJrZXIoZGV2aWNlKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBhc3NpZ24gdW5pZnJvbVxuICAgICAgICAgICAgICAgICAgICBzZWxmLnNldHVwVW5pZm9ybShkZXZpY2UsIGZhbHNlLCBjb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNhbWVyYS5yZW5kZXJTY2VuZURlcHRoTWFwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gcmVhbGxvY2F0ZSBSVCBpZiBuZWVkZWRcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYucmVzaXplQ29uZGl0aW9uKHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQsIGNhbWVyYS5yZW5kZXJUYXJnZXQ/LmRlcHRoQnVmZmVyLCBkZXZpY2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbGVhc2VSZW5kZXJUYXJnZXQodGhpcy5kZXB0aFJlbmRlclRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0ID0gc2VsZi5hbGxvY2F0ZVJlbmRlclRhcmdldCh0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LCBjYW1lcmEucmVuZGVyVGFyZ2V0LCBkZXZpY2UsIFBJWEVMRk9STUFUX0RFUFRIU1RFTkNJTCwgdHJ1ZSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY29weSBkZXB0aFxuICAgICAgICAgICAgICAgICAgICBEZWJ1Z0dyYXBoaWNzLnB1c2hHcHVNYXJrZXIoZGV2aWNlLCAnR1JBQi1ERVBUSCcpO1xuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuY29weVJlbmRlclRhcmdldChkZXZpY2UucmVuZGVyVGFyZ2V0LCB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIERlYnVnR3JhcGhpY3MucG9wR3B1TWFya2VyKGRldmljZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gYXNzaWduIHVuaWZyb21cbiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXR1cFVuaWZvcm0oZGV2aWNlLCB0cnVlLCB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LmRlcHRoQnVmZmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvblBvc3RSZW5kZXJPcGFxdWU6IGZ1bmN0aW9uIChjYW1lcmFQYXNzKSB7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGluaXRXZWJHbDEoKSB7XG5cbiAgICAgICAgY29uc3QgYXBwID0gdGhpcy5hcHBsaWNhdGlvbjtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgLy8gV2ViR0wgMSBkZXB0aCBsYXllciByZW5kZXJzIHRoZSBzYW1lIG9iamVjdHMgYXMgaW4gV29ybGQsIGJ1dCB3aXRoIFJHQkEtZW5jb2RlZCBkZXB0aCBzaGFkZXIgdG8gZ2V0IGRlcHRoXG4gICAgICAgIHRoaXMubGF5ZXIgPSBuZXcgTGF5ZXIoe1xuICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICBuYW1lOiBcIkRlcHRoXCIsXG4gICAgICAgICAgICBpZDogTEFZRVJJRF9ERVBUSCxcbiAgICAgICAgICAgIHNoYWRlclBhc3M6IFNIQURFUl9ERVBUSCxcblxuICAgICAgICAgICAgb25FbmFibGU6IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBSVCB3aXRob3V0IHRleHR1cmVzLCB0aG9zZSB3aWxsIGJlIGNyZWF0ZWQgYXMgbmVlZGVkIGxhdGVyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXB0aFJlbmRlclRhcmdldCA9IG5ldyBSZW5kZXJUYXJnZXQoe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnZGVwdGhSZW5kZXJUYXJnZXQtd2ViZ2wxJyxcbiAgICAgICAgICAgICAgICAgICAgZGVwdGg6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHN0ZW5jaWw6IGFwcC5ncmFwaGljc0RldmljZS5zdXBwb3J0c1N0ZW5jaWwsXG4gICAgICAgICAgICAgICAgICAgIGF1dG9SZXNvbHZlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZ3JhcGhpY3NEZXZpY2U6IGFwcC5ncmFwaGljc0RldmljZVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gYXNzaWduIGl0IHNvIHRoZSByZW5kZXIgYWN0aW9ucyBrbm93cyB0byByZW5kZXIgdG8gaXRcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBhdm9pZCB0aGlzIGFzIHRoaXMgQVBJIGlzIGRlcHJlY2F0ZWRcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclRhcmdldCA9IHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQ7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBvbkRpc2FibGU6IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgIC8vIG9ubHkgcmVsZWFzZSBkZXB0aCB0ZXh0dXJlLCBidXQgbm90IHRoZSByZW5kZXIgdGFyZ2V0IGl0c2VsZlxuICAgICAgICAgICAgICAgIHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQuZGVzdHJveVRleHR1cmVCdWZmZXJzKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJUYXJnZXQgPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgc2VsZi5yZWxlYXNlUmVuZGVyVGFyZ2V0KHRoaXMuY29sb3JSZW5kZXJUYXJnZXQpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29sb3JSZW5kZXJUYXJnZXQgPSBudWxsO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgb25Qb3N0Q3VsbDogZnVuY3Rpb24gKGNhbWVyYVBhc3MpIHtcblxuICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7R3JhcGhpY3NEZXZpY2V9ICovXG4gICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlID0gYXBwLmdyYXBoaWNzRGV2aWNlO1xuXG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHtDYW1lcmFDb21wb25lbnR9ICovXG4gICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gdGhpcy5jYW1lcmFzW2NhbWVyYVBhc3NdO1xuXG4gICAgICAgICAgICAgICAgaWYgKGNhbWVyYS5yZW5kZXJTY2VuZURlcHRoTWFwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gcmVhbGxvY2F0ZSBSVCBpZiBuZWVkZWRcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYucmVzaXplQ29uZGl0aW9uKHRoaXMuZGVwdGhSZW5kZXJUYXJnZXQsIGNhbWVyYS5yZW5kZXJUYXJnZXQ/LmRlcHRoQnVmZmVyLCBkZXZpY2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlcHRoUmVuZGVyVGFyZ2V0LmRlc3Ryb3lUZXh0dXJlQnVmZmVycygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXB0aFJlbmRlclRhcmdldCA9IHNlbGYuYWxsb2NhdGVSZW5kZXJUYXJnZXQodGhpcy5kZXB0aFJlbmRlclRhcmdldCwgY2FtZXJhLnJlbmRlclRhcmdldCwgZGV2aWNlLCBQSVhFTEZPUk1BVF9SOF9HOF9COF9BOCwgZmFsc2UsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIENvbGxlY3QgYWxsIHJlbmRlcmVkIG1lc2ggaW5zdGFuY2VzIHdpdGggdGhlIHNhbWUgcmVuZGVyIHRhcmdldCBhcyBXb3JsZCBoYXMsIGRlcHRoV3JpdGUgPT0gdHJ1ZSBhbmQgcHJpb3IgdG8gdGhpcyBsYXllciB0byByZXBsaWNhdGUgYmxpdEZyYW1lYnVmZmVyIG9uIFdlYkdMMlxuICAgICAgICAgICAgICAgICAgICBjb25zdCB2aXNpYmxlT2JqZWN0cyA9IHRoaXMuaW5zdGFuY2VzLnZpc2libGVPcGFxdWVbY2FtZXJhUGFzc107XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHZpc2libGVMaXN0ID0gdmlzaWJsZU9iamVjdHMubGlzdDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGF5ZXJDb21wb3NpdGlvbiA9IGFwcC5zY2VuZS5sYXllcnM7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1YkxheWVyRW5hYmxlZCA9IGxheWVyQ29tcG9zaXRpb24uc3ViTGF5ZXJFbmFibGVkO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1RyYW5zcGFyZW50ID0gbGF5ZXJDb21wb3NpdGlvbi5zdWJMYXllckxpc3Q7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY2FuJ3QgdXNlIHNlbGYuZGVmYXVsdExheWVyV29ybGQucmVuZGVyVGFyZ2V0IGJlY2F1c2UgcHJvamVjdHMgdGhhdCB1c2UgdGhlIGVkaXRvciBvdmVycmlkZSBkZWZhdWx0IGxheWVyc1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBydCA9IGFwcC5zY2VuZS5sYXllcnMuZ2V0TGF5ZXJCeUlkKExBWUVSSURfV09STEQpLnJlbmRlclRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FtID0gdGhpcy5jYW1lcmFzW2NhbWVyYVBhc3NdO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCB2aXNpYmxlTGVuZ3RoID0gMDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGF5ZXJzID0gbGF5ZXJDb21wb3NpdGlvbi5sYXllckxpc3Q7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGF5ZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXllciA9IGxheWVyc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXllciA9PT0gdGhpcykgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobGF5ZXIucmVuZGVyVGFyZ2V0ICE9PSBydCB8fCAhbGF5ZXIuZW5hYmxlZCB8fCAhc3ViTGF5ZXJFbmFibGVkW2ldKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGF5ZXJDYW1JZCA9IGxheWVyLmNhbWVyYXMuaW5kZXhPZihjYW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxheWVyQ2FtSWQgPCAwKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhbnNwYXJlbnQgPSBpc1RyYW5zcGFyZW50W2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxheWVyVmlzaWJsZUxpc3QgPSB0cmFuc3BhcmVudCA/IGxheWVyLmluc3RhbmNlcy52aXNpYmxlVHJhbnNwYXJlbnRbbGF5ZXJDYW1JZF0gOiBsYXllci5pbnN0YW5jZXMudmlzaWJsZU9wYXF1ZVtsYXllckNhbUlkXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxheWVyVmlzaWJsZUxpc3RMZW5ndGggPSBsYXllclZpc2libGVMaXN0Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxheWVyVmlzaWJsZUxpc3QgPSBsYXllclZpc2libGVMaXN0Lmxpc3Q7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbGF5ZXJWaXNpYmxlTGlzdExlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZHJhd0NhbGwgPSBsYXllclZpc2libGVMaXN0W2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkcmF3Q2FsbC5tYXRlcmlhbCAmJiBkcmF3Q2FsbC5tYXRlcmlhbC5kZXB0aFdyaXRlICYmICFkcmF3Q2FsbC5fbm9EZXB0aERyYXdHbDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZUxpc3RbdmlzaWJsZUxlbmd0aF0gPSBkcmF3Q2FsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZUxlbmd0aCsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2aXNpYmxlT2JqZWN0cy5sZW5ndGggPSB2aXNpYmxlTGVuZ3RoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIG9uUHJlUmVuZGVyT3BhcXVlOiBmdW5jdGlvbiAoY2FtZXJhUGFzcykge1xuXG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHtHcmFwaGljc0RldmljZX0gKi9cbiAgICAgICAgICAgICAgICBjb25zdCBkZXZpY2UgPSBhcHAuZ3JhcGhpY3NEZXZpY2U7XG5cbiAgICAgICAgICAgICAgICAvKiogQHR5cGUge0NhbWVyYUNvbXBvbmVudH0gKi9cbiAgICAgICAgICAgICAgICBjb25zdCBjYW1lcmEgPSB0aGlzLmNhbWVyYXNbY2FtZXJhUGFzc107XG5cbiAgICAgICAgICAgICAgICBpZiAoY2FtZXJhLnJlbmRlclNjZW5lQ29sb3JNYXApIHtcblxuICAgICAgICAgICAgICAgICAgICAvLyByZWFsbG9jYXRlIFJUIGlmIG5lZWRlZFxuICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5yZXNpemVDb25kaXRpb24odGhpcy5jb2xvclJlbmRlclRhcmdldCwgY2FtZXJhLnJlbmRlclRhcmdldD8uY29sb3JCdWZmZXIsIGRldmljZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVsZWFzZVJlbmRlclRhcmdldCh0aGlzLmNvbG9yUmVuZGVyVGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29sb3JSZW5kZXJUYXJnZXQgPSBzZWxmLmFsbG9jYXRlUmVuZGVyVGFyZ2V0KHRoaXMuY29sb3JSZW5kZXJUYXJnZXQsIGNhbWVyYS5yZW5kZXJUYXJnZXQsIGRldmljZSwgdGhpcy5jb2xvckZvcm1hdCwgZmFsc2UsIGZhbHNlLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG91dCB0aGUgY29sb3IgYnVmZmVyXG4gICAgICAgICAgICAgICAgICAgIERlYnVnR3JhcGhpY3MucHVzaEdwdU1hcmtlcihkZXZpY2UsICdHUkFCLUNPTE9SJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSB0aGUgdGV4dHVyZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvckJ1ZmZlciA9IHRoaXMuY29sb3JSZW5kZXJUYXJnZXQuX2NvbG9yQnVmZmVyO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbG9yQnVmZmVyLmltcGwuX2dsVGV4dHVyZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JCdWZmZXIuaW1wbC5pbml0aWFsaXplKGRldmljZSwgY29sb3JCdWZmZXIpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY29weSBmcmFtZWJ1ZmZlciB0byBpdFxuICAgICAgICAgICAgICAgICAgICBkZXZpY2UuYmluZFRleHR1cmUoY29sb3JCdWZmZXIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBnbCA9IGRldmljZS5nbDtcbiAgICAgICAgICAgICAgICAgICAgZ2wuY29weVRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgY29sb3JCdWZmZXIuaW1wbC5fZ2xGb3JtYXQsIDAsIDAsIGNvbG9yQnVmZmVyLndpZHRoLCBjb2xvckJ1ZmZlci5oZWlnaHQsIDApO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIHN0b3AgdGhlIGRldmljZSBmcm9tIHVwZGF0aW5nIHRoaXMgdGV4dHVyZSBmdXJ0aGVyXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yQnVmZmVyLl9uZWVkc1VwbG9hZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBjb2xvckJ1ZmZlci5fbmVlZHNNaXBtYXBzVXBsb2FkID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICAgICAgRGVidWdHcmFwaGljcy5wb3BHcHVNYXJrZXIoZGV2aWNlKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBhc3NpZ24gdW5pZnJvbVxuICAgICAgICAgICAgICAgICAgICBzZWxmLnNldHVwVW5pZm9ybShkZXZpY2UsIGZhbHNlLCBjb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNhbWVyYS5yZW5kZXJTY2VuZURlcHRoTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGFzc2lnbiB1bmlmcm9tXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0dXBVbmlmb3JtKGRldmljZSwgdHJ1ZSwgdGhpcy5kZXB0aFJlbmRlclRhcmdldC5jb2xvckJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgb25EcmF3Q2FsbDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGFwcC5ncmFwaGljc0RldmljZS5zZXRDb2xvcldyaXRlKHRydWUsIHRydWUsIHRydWUsIHRydWUpO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgb25Qb3N0UmVuZGVyT3BhcXVlOiBmdW5jdGlvbiAoY2FtZXJhUGFzcykge1xuXG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHtDYW1lcmFDb21wb25lbnR9ICovXG4gICAgICAgICAgICAgICAgY29uc3QgY2FtZXJhID0gdGhpcy5jYW1lcmFzW2NhbWVyYVBhc3NdO1xuXG4gICAgICAgICAgICAgICAgaWYgKGNhbWVyYS5yZW5kZXJTY2VuZURlcHRoTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGp1c3QgY2xlYXIgdGhlIGxpc3Qgb2YgdmlzaWJsZSBvYmplY3RzIHRvIGF2b2lkIGtlZXBpbmcgcmVmZXJlbmNlc1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2aXNpYmxlT2JqZWN0cyA9IHRoaXMuaW5zdGFuY2VzLnZpc2libGVPcGFxdWVbY2FtZXJhUGFzc107XG4gICAgICAgICAgICAgICAgICAgIHZpc2libGVPYmplY3RzLmxlbmd0aCA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBmdW5jdGlvbiB3aGljaCBwYXRjaGVzIGEgbGF5ZXIgdG8gdXNlIGRlcHRoIGxheWVyIHNldCB1cCBpbiB0aGlzIGNsYXNzXG4gICAgcGF0Y2gobGF5ZXIpIHtcblxuICAgICAgICBsYXllci5vbkVuYWJsZSA9IHRoaXMubGF5ZXIub25FbmFibGU7XG4gICAgICAgIGxheWVyLm9uRGlzYWJsZSA9IHRoaXMubGF5ZXIub25EaXNhYmxlO1xuICAgICAgICBsYXllci5vblByZVJlbmRlck9wYXF1ZSA9IHRoaXMubGF5ZXIub25QcmVSZW5kZXJPcGFxdWU7XG4gICAgICAgIGxheWVyLm9uUG9zdFJlbmRlck9wYXF1ZSA9IHRoaXMubGF5ZXIub25Qb3N0UmVuZGVyT3BhcXVlO1xuICAgICAgICBsYXllci5zaGFkZXJQYXNzID0gdGhpcy5sYXllci5zaGFkZXJQYXNzO1xuICAgICAgICBsYXllci5vblBvc3RDdWxsID0gdGhpcy5sYXllci5vblBvc3RDdWxsO1xuICAgICAgICBsYXllci5vbkRyYXdDYWxsID0gdGhpcy5sYXllci5vbkRyYXdDYWxsO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgU2NlbmVHcmFiIH07XG4iXSwibmFtZXMiOlsiX2RlcHRoVW5pZm9ybU5hbWVzIiwiX2NvbG9yVW5pZm9ybU5hbWVzIiwiU2NlbmVHcmFiIiwiY29uc3RydWN0b3IiLCJhcHBsaWNhdGlvbiIsImRldmljZSIsImdyYXBoaWNzRGV2aWNlIiwibGF5ZXIiLCJjb2xvckZvcm1hdCIsImRlZmF1bHRGcmFtZWJ1ZmZlckFscGhhIiwiUElYRUxGT1JNQVRfUjhfRzhfQjhfQTgiLCJQSVhFTEZPUk1BVF9SOF9HOF9COCIsIndlYmdsMiIsImluaXRXZWJHbDIiLCJpbml0V2ViR2wxIiwic2V0dXBVbmlmb3JtIiwiZGVwdGgiLCJidWZmZXIiLCJuYW1lcyIsImZvckVhY2giLCJuYW1lIiwic2NvcGUiLCJyZXNvbHZlIiwic2V0VmFsdWUiLCJhbGxvY2F0ZVRleHR1cmUiLCJzb3VyY2UiLCJmb3JtYXQiLCJpc0RlcHRoIiwibWlwbWFwcyIsIlRleHR1cmUiLCJ3aWR0aCIsImNvbG9yQnVmZmVyIiwiaGVpZ2h0IiwibWluRmlsdGVyIiwiRklMVEVSX05FQVJFU1QiLCJGSUxURVJfTElORUFSX01JUE1BUF9MSU5FQVIiLCJGSUxURVJfTElORUFSIiwibWFnRmlsdGVyIiwiYWRkcmVzc1UiLCJBRERSRVNTX0NMQU1QX1RPX0VER0UiLCJhZGRyZXNzViIsInJlc2l6ZUNvbmRpdGlvbiIsInRhcmdldCIsImFsbG9jYXRlUmVuZGVyVGFyZ2V0IiwicmVuZGVyVGFyZ2V0Iiwic291cmNlUmVuZGVyVGFyZ2V0IiwiaXNEZXB0aFVuaWZvcm1zIiwiZGVzdHJveUZyYW1lQnVmZmVycyIsIl9kZXB0aEJ1ZmZlciIsIl9jb2xvckJ1ZmZlciIsIlJlbmRlclRhcmdldCIsImRlcHRoQnVmZmVyIiwic3RlbmNpbCIsInN1cHBvcnRzU3RlbmNpbCIsImF1dG9SZXNvbHZlIiwicmVsZWFzZVJlbmRlclRhcmdldCIsInJ0IiwiZGVzdHJveVRleHR1cmVCdWZmZXJzIiwiZGVzdHJveSIsImFwcCIsInNlbGYiLCJMYXllciIsImVuYWJsZWQiLCJpZCIsIkxBWUVSSURfREVQVEgiLCJvbkRpc2FibGUiLCJkZXB0aFJlbmRlclRhcmdldCIsImNvbG9yUmVuZGVyVGFyZ2V0Iiwib25QcmVSZW5kZXJPcGFxdWUiLCJjYW1lcmFQYXNzIiwiY2FtZXJhIiwiY2FtZXJhcyIsInJlbmRlclNjZW5lQ29sb3JNYXAiLCJEZWJ1Z0dyYXBoaWNzIiwicHVzaEdwdU1hcmtlciIsImNvcHlSZW5kZXJUYXJnZXQiLCJhY3RpdmVUZXh0dXJlIiwibWF4Q29tYmluZWRUZXh0dXJlcyIsImJpbmRUZXh0dXJlIiwiZ2wiLCJnZW5lcmF0ZU1pcG1hcCIsImltcGwiLCJfZ2xUYXJnZXQiLCJwb3BHcHVNYXJrZXIiLCJyZW5kZXJTY2VuZURlcHRoTWFwIiwiUElYRUxGT1JNQVRfREVQVEhTVEVOQ0lMIiwib25Qb3N0UmVuZGVyT3BhcXVlIiwic2hhZGVyUGFzcyIsIlNIQURFUl9ERVBUSCIsIm9uRW5hYmxlIiwib25Qb3N0Q3VsbCIsInZpc2libGVPYmplY3RzIiwiaW5zdGFuY2VzIiwidmlzaWJsZU9wYXF1ZSIsInZpc2libGVMaXN0IiwibGlzdCIsImxheWVyQ29tcG9zaXRpb24iLCJzY2VuZSIsImxheWVycyIsInN1YkxheWVyRW5hYmxlZCIsImlzVHJhbnNwYXJlbnQiLCJzdWJMYXllckxpc3QiLCJnZXRMYXllckJ5SWQiLCJMQVlFUklEX1dPUkxEIiwiY2FtIiwidmlzaWJsZUxlbmd0aCIsImxheWVyTGlzdCIsImkiLCJsZW5ndGgiLCJsYXllckNhbUlkIiwiaW5kZXhPZiIsInRyYW5zcGFyZW50IiwibGF5ZXJWaXNpYmxlTGlzdCIsInZpc2libGVUcmFuc3BhcmVudCIsImxheWVyVmlzaWJsZUxpc3RMZW5ndGgiLCJqIiwiZHJhd0NhbGwiLCJtYXRlcmlhbCIsImRlcHRoV3JpdGUiLCJfbm9EZXB0aERyYXdHbDEiLCJfZ2xUZXh0dXJlIiwiaW5pdGlhbGl6ZSIsImNvcHlUZXhJbWFnZTJEIiwiVEVYVFVSRV8yRCIsIl9nbEZvcm1hdCIsIl9uZWVkc1VwbG9hZCIsIl9uZWVkc01pcG1hcHNVcGxvYWQiLCJvbkRyYXdDYWxsIiwic2V0Q29sb3JXcml0ZSIsInBhdGNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFxQkEsTUFBTUEsa0JBQWtCLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsQ0FBQTtBQUMxRCxNQUFNQyxrQkFBa0IsR0FBRyxDQUFDLGdCQUFnQixFQUFFLGtCQUFrQixDQUFDLENBQUE7O0FBZWpFLE1BQU1DLFNBQVMsQ0FBQztFQUNaQyxXQUFXLENBQUNDLFdBQVcsRUFBRTtJQUNyQixJQUFJLENBQUNBLFdBQVcsR0FBR0EsV0FBVyxDQUFBOztBQUc5QixJQUFBLElBQUksQ0FBQ0MsTUFBTSxHQUFHRCxXQUFXLENBQUNFLGNBQWMsQ0FBQTs7SUFHeEMsSUFBSSxDQUFDQyxLQUFLLEdBQUcsSUFBSSxDQUFBOztJQUdq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

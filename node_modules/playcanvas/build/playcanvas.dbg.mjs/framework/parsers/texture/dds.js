/**
 * @license
 * PlayCanvas Engine v1.58.0 revision 6672f604c (DEBUG PROFILER)
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */
import { Debug } from '../../../core/debug.js';
import { Asset } from '../../asset/asset.js';
import { Texture } from '../../../platform/graphics/texture.js';
import { PIXELFORMAT_R8_G8_B8, TEXHINT_ASSET, ADDRESS_CLAMP_TO_EDGE, ADDRESS_REPEAT, PIXELFORMAT_DXT1, PIXELFORMAT_DXT5, PIXELFORMAT_RGBA16F, PIXELFORMAT_RGBA32F, PIXELFORMAT_ETC1, PIXELFORMAT_PVRTC_2BPP_RGB_1, PIXELFORMAT_PVRTC_2BPP_RGBA_1, PIXELFORMAT_PVRTC_4BPP_RGB_1, PIXELFORMAT_PVRTC_4BPP_RGBA_1, PIXELFORMAT_R8_G8_B8_A8 } from '../../../platform/graphics/constants.js';

class DdsParser {
  constructor(registry) {
    this.maxRetries = 0;
  }
  load(url, callback, asset) {
    Asset.fetchArrayBuffer(url.load, callback, asset, this.maxRetries);
  }
  open(url, data, device) {
    const header = new Uint32Array(data, 0, 128 / 4);
    const width = header[4];
    const height = header[3];
    const mips = Math.max(header[7], 1);
    const isFourCc = header[20] === 4;
    const fcc = header[21];
    const bpp = header[22];
    const isCubemap = header[28] === 65024;

    const FCC_DXT1 = 827611204;
    const FCC_DXT5 = 894720068;
    const FCC_FP16 = 113;
    const FCC_FP32 = 116;

    const FCC_ETC1 = 826496069;
    const FCC_PVRTC_2BPP_RGB_1 = 825438800;
    const FCC_PVRTC_2BPP_RGBA_1 = 825504336;
    const FCC_PVRTC_4BPP_RGB_1 = 825439312;
    const FCC_PVRTC_4BPP_RGBA_1 = 825504848;
    let compressed = false;
    let etc1 = false;
    let pvrtc2 = false;
    let pvrtc4 = false;
    let format = null;
    let componentSize = 1;
    let texture;
    if (isFourCc) {
      if (fcc === FCC_DXT1) {
        format = PIXELFORMAT_DXT1;
        compressed = true;
      } else if (fcc === FCC_DXT5) {
        format = PIXELFORMAT_DXT5;
        compressed = true;
      } else if (fcc === FCC_FP16) {
        format = PIXELFORMAT_RGBA16F;
        componentSize = 2;
      } else if (fcc === FCC_FP32) {
        format = PIXELFORMAT_RGBA32F;
        componentSize = 4;
      } else if (fcc === FCC_ETC1) {
        format = PIXELFORMAT_ETC1;
        compressed = true;
        etc1 = true;
      } else if (fcc === FCC_PVRTC_2BPP_RGB_1 || fcc === FCC_PVRTC_2BPP_RGBA_1) {
        format = fcc === FCC_PVRTC_2BPP_RGB_1 ? PIXELFORMAT_PVRTC_2BPP_RGB_1 : PIXELFORMAT_PVRTC_2BPP_RGBA_1;
        compressed = true;
        pvrtc2 = true;
      } else if (fcc === FCC_PVRTC_4BPP_RGB_1 || fcc === FCC_PVRTC_4BPP_RGBA_1) {
        format = fcc === FCC_PVRTC_4BPP_RGB_1 ? PIXELFORMAT_PVRTC_4BPP_RGB_1 : PIXELFORMAT_PVRTC_4BPP_RGBA_1;
        compressed = true;
        pvrtc4 = true;
      }
    } else {
      if (bpp === 32) {
        format = PIXELFORMAT_R8_G8_B8_A8;
      }
    }
    if (!format) {
      Debug.error('This DDS pixel format is currently unsupported. Empty texture will be created instead.');
      texture = new Texture(device, {
        width: 4,
        height: 4,
        format: PIXELFORMAT_R8_G8_B8,
        name: 'dds-legacy-empty'
      });
      return texture;
    }
    texture = new Texture(device, {
      name: url,
      profilerHint: TEXHINT_ASSET,
      addressU: isCubemap ? ADDRESS_CLAMP_TO_EDGE : ADDRESS_REPEAT,
      addressV: isCubemap ? ADDRESS_CLAMP_TO_EDGE : ADDRESS_REPEAT,
      width: width,
      height: height,
      format: format,
      cubemap: isCubemap,
      mipmaps: mips > 1
    });
    let offset = 128;
    const faces = isCubemap ? 6 : 1;
    let mipSize;
    const DXT_BLOCK_WIDTH = 4;
    const DXT_BLOCK_HEIGHT = 4;
    const blockSize = fcc === FCC_DXT1 ? 8 : 16;
    let numBlocksAcross, numBlocksDown, numBlocks;
    for (let face = 0; face < faces; face++) {
      let mipWidth = width;
      let mipHeight = height;
      for (let i = 0; i < mips; i++) {
        if (compressed) {
          if (etc1) {
            mipSize = Math.floor((mipWidth + 3) / 4) * Math.floor((mipHeight + 3) / 4) * 8;
          } else if (pvrtc2) {
            mipSize = Math.max(mipWidth, 16) * Math.max(mipHeight, 8) / 4;
          } else if (pvrtc4) {
            mipSize = Math.max(mipWidth, 8) * Math.max(mipHeight, 8) / 2;
          } else {
            numBlocksAcross = Math.floor((mipWidth + DXT_BLOCK_WIDTH - 1) / DXT_BLOCK_WIDTH);
            numBlocksDown = Math.floor((mipHeight + DXT_BLOCK_HEIGHT - 1) / DXT_BLOCK_HEIGHT);
            numBlocks = numBlocksAcross * numBlocksDown;
            mipSize = numBlocks * blockSize;
          }
        } else {
          mipSize = mipWidth * mipHeight * 4;
        }
        const mipBuff = format === PIXELFORMAT_RGBA32F ? new Float32Array(data, offset, mipSize) : format === PIXELFORMAT_RGBA16F ? new Uint16Array(data, offset, mipSize) : new Uint8Array(data, offset, mipSize);
        if (!isCubemap) {
          texture._levels[i] = mipBuff;
        } else {
          if (!texture._levels[i]) texture._levels[i] = [];
          texture._levels[i][face] = mipBuff;
        }
        offset += mipSize * componentSize;
        mipWidth = Math.max(mipWidth * 0.5, 1);
        mipHeight = Math.max(mipHeight * 0.5, 1);
      }
    }
    texture.upload();
    return texture;
  }
}

export { DdsParser };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGRzLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL3BhcnNlcnMvdGV4dHVyZS9kZHMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVidWcgfSBmcm9tICcuLi8uLi8uLi9jb3JlL2RlYnVnLmpzJztcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSAnLi4vLi4vLi4vZnJhbWV3b3JrL2Fzc2V0L2Fzc2V0LmpzJztcbmltcG9ydCB7IFRleHR1cmUgfSBmcm9tICcuLi8uLi8uLi9wbGF0Zm9ybS9ncmFwaGljcy90ZXh0dXJlLmpzJztcbmltcG9ydCB7XG4gICAgQUREUkVTU19DTEFNUF9UT19FREdFLCBBRERSRVNTX1JFUEVBVCxcbiAgICBQSVhFTEZPUk1BVF9EWFQxLCBQSVhFTEZPUk1BVF9EWFQ1LFxuICAgIFBJWEVMRk9STUFUX0VUQzEsXG4gICAgUElYRUxGT1JNQVRfUFZSVENfNEJQUF9SR0JfMSwgUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JfMSwgUElYRUxGT1JNQVRfUFZSVENfNEJQUF9SR0JBXzEsIFBJWEVMRk9STUFUX1BWUlRDXzJCUFBfUkdCQV8xLFxuICAgIFBJWEVMRk9STUFUX1I4X0c4X0I4LCBQSVhFTEZPUk1BVF9SOF9HOF9COF9BOCxcbiAgICBQSVhFTEZPUk1BVF9SR0JBMTZGLCBQSVhFTEZPUk1BVF9SR0JBMzJGLFxuICAgIFRFWEhJTlRfQVNTRVRcbn0gZnJvbSAnLi4vLi4vLi4vcGxhdGZvcm0vZ3JhcGhpY3MvY29uc3RhbnRzLmpzJztcblxuLyoqIEB0eXBlZGVmIHtpbXBvcnQoJy4uLy4uL2hhbmRsZXJzL3RleHR1cmUuanMnKS5UZXh0dXJlUGFyc2VyfSBUZXh0dXJlUGFyc2VyICovXG5cbi8qKlxuICogTGVnYWN5IHRleHR1cmUgcGFyc2VyIGZvciBkZHMgZmlsZXMuXG4gKlxuICogQGltcGxlbWVudHMge1RleHR1cmVQYXJzZXJ9XG4gKiBAaWdub3JlXG4gKi9cbmNsYXNzIERkc1BhcnNlciB7XG4gICAgY29uc3RydWN0b3IocmVnaXN0cnkpIHtcbiAgICAgICAgdGhpcy5tYXhSZXRyaWVzID0gMDtcbiAgICB9XG5cbiAgICBsb2FkKHVybCwgY2FsbGJhY2ssIGFzc2V0KSB7XG4gICAgICAgIEFzc2V0LmZldGNoQXJyYXlCdWZmZXIodXJsLmxvYWQsIGNhbGxiYWNrLCBhc3NldCwgdGhpcy5tYXhSZXRyaWVzKTtcbiAgICB9XG5cbiAgICBvcGVuKHVybCwgZGF0YSwgZGV2aWNlKSB7XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IG5ldyBVaW50MzJBcnJheShkYXRhLCAwLCAxMjggLyA0KTtcblxuICAgICAgICBjb25zdCB3aWR0aCA9IGhlYWRlcls0XTtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gaGVhZGVyWzNdO1xuICAgICAgICBjb25zdCBtaXBzID0gTWF0aC5tYXgoaGVhZGVyWzddLCAxKTtcbiAgICAgICAgY29uc3QgaXNGb3VyQ2MgPSBoZWFkZXJbMjBdID09PSA0O1xuICAgICAgICBjb25zdCBmY2MgPSBoZWFkZXJbMjFdO1xuICAgICAgICBjb25zdCBicHAgPSBoZWFkZXJbMjJdO1xuICAgICAgICBjb25zdCBpc0N1YmVtYXAgPSBoZWFkZXJbMjhdID09PSA2NTAyNDsgLy8gVE9ETzogY2hlY2sgYnkgYml0ZmxhZ1xuXG4gICAgICAgIGNvbnN0IEZDQ19EWFQxID0gODI3NjExMjA0OyAvLyBEWFQxXG4gICAgICAgIGNvbnN0IEZDQ19EWFQ1ID0gODk0NzIwMDY4OyAvLyBEWFQ1XG4gICAgICAgIGNvbnN0IEZDQ19GUDE2ID0gMTEzOyAgICAgICAvLyBSR0JBMTZmXG4gICAgICAgIGNvbnN0IEZDQ19GUDMyID0gMTE2OyAgICAgICAvLyBSR0JBMzJmXG5cbiAgICAgICAgLy8gbm9uIHN0YW5kYXJkXG4gICAgICAgIGNvbnN0IEZDQ19FVEMxID0gODI2NDk2MDY5O1xuICAgICAgICBjb25zdCBGQ0NfUFZSVENfMkJQUF9SR0JfMSA9IDgyNTQzODgwMDtcbiAgICAgICAgY29uc3QgRkNDX1BWUlRDXzJCUFBfUkdCQV8xID0gODI1NTA0MzM2O1xuICAgICAgICBjb25zdCBGQ0NfUFZSVENfNEJQUF9SR0JfMSA9IDgyNTQzOTMxMjtcbiAgICAgICAgY29uc3QgRkNDX1BWUlRDXzRCUFBfUkdCQV8xID0gODI1NTA0ODQ4O1xuXG4gICAgICAgIGxldCBjb21wcmVzc2VkID0gZmFsc2U7XG4gICAgICAgIGxldCBldGMxID0gZmFsc2U7XG4gICAgICAgIGxldCBwdnJ0YzIgPSBmYWxzZTtcbiAgICAgICAgbGV0IHB2cnRjNCA9IGZhbHNlO1xuICAgICAgICBsZXQgZm9ybWF0ID0gbnVsbDtcbiAgICAgICAgbGV0IGNvbXBvbmVudFNpemUgPSAxO1xuXG4gICAgICAgIGxldCB0ZXh0dXJlO1xuXG4gICAgICAgIGlmIChpc0ZvdXJDYykge1xuICAgICAgICAgICAgaWYgKGZjYyA9PT0gRkNDX0RYVDEpIHtcbiAgICAgICAgICAgICAgICBmb3JtYXQgPSBQSVhFTEZPUk1BVF9EWFQxO1xuICAgICAgICAgICAgICAgIGNvbXByZXNzZWQgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChmY2MgPT09IEZDQ19EWFQ1KSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gUElYRUxGT1JNQVRfRFhUNTtcbiAgICAgICAgICAgICAgICBjb21wcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmNjID09PSBGQ0NfRlAxNikge1xuICAgICAgICAgICAgICAgIGZvcm1hdCA9IFBJWEVMRk9STUFUX1JHQkExNkY7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50U2l6ZSA9IDI7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZjYyA9PT0gRkNDX0ZQMzIpIHtcbiAgICAgICAgICAgICAgICBmb3JtYXQgPSBQSVhFTEZPUk1BVF9SR0JBMzJGO1xuICAgICAgICAgICAgICAgIGNvbXBvbmVudFNpemUgPSA0O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChmY2MgPT09IEZDQ19FVEMxKSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gUElYRUxGT1JNQVRfRVRDMTtcbiAgICAgICAgICAgICAgICBjb21wcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBldGMxID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmNjID09PSBGQ0NfUFZSVENfMkJQUF9SR0JfMSB8fCBmY2MgPT09IEZDQ19QVlJUQ18yQlBQX1JHQkFfMSkge1xuICAgICAgICAgICAgICAgIGZvcm1hdCA9IGZjYyA9PT0gRkNDX1BWUlRDXzJCUFBfUkdCXzEgPyBQSVhFTEZPUk1BVF9QVlJUQ18yQlBQX1JHQl8xIDogUElYRUxGT1JNQVRfUFZSVENfMkJQUF9SR0JBXzE7XG4gICAgICAgICAgICAgICAgY29tcHJlc3NlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcHZydGMyID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmNjID09PSBGQ0NfUFZSVENfNEJQUF9SR0JfMSB8fCBmY2MgPT09IEZDQ19QVlJUQ180QlBQX1JHQkFfMSkge1xuICAgICAgICAgICAgICAgIGZvcm1hdCA9IGZjYyA9PT0gRkNDX1BWUlRDXzRCUFBfUkdCXzEgPyBQSVhFTEZPUk1BVF9QVlJUQ180QlBQX1JHQl8xIDogUElYRUxGT1JNQVRfUFZSVENfNEJQUF9SR0JBXzE7XG4gICAgICAgICAgICAgICAgY29tcHJlc3NlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcHZydGM0ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChicHAgPT09IDMyKSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gUElYRUxGT1JNQVRfUjhfRzhfQjhfQTg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWZvcm1hdCkge1xuICAgICAgICAgICAgRGVidWcuZXJyb3IoJ1RoaXMgRERTIHBpeGVsIGZvcm1hdCBpcyBjdXJyZW50bHkgdW5zdXBwb3J0ZWQuIEVtcHR5IHRleHR1cmUgd2lsbCBiZSBjcmVhdGVkIGluc3RlYWQuJyk7XG4gICAgICAgICAgICB0ZXh0dXJlID0gbmV3IFRleHR1cmUoZGV2aWNlLCB7XG4gICAgICAgICAgICAgICAgd2lkdGg6IDQsXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiA0LFxuICAgICAgICAgICAgICAgIGZvcm1hdDogUElYRUxGT1JNQVRfUjhfRzhfQjgsXG4gICAgICAgICAgICAgICAgbmFtZTogJ2Rkcy1sZWdhY3ktZW1wdHknXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0ZXh0dXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGV4dHVyZSA9IG5ldyBUZXh0dXJlKGRldmljZSwge1xuICAgICAgICAgICAgbmFtZTogdXJsLFxuICAgICAgICAgICAgLy8gI2lmIF9QUk9GSUxFUlxuICAgICAgICAgICAgcHJvZmlsZXJIaW50OiBURVhISU5UX0FTU0VULFxuICAgICAgICAgICAgLy8gI2VuZGlmXG4gICAgICAgICAgICBhZGRyZXNzVTogaXNDdWJlbWFwID8gQUREUkVTU19DTEFNUF9UT19FREdFIDogQUREUkVTU19SRVBFQVQsXG4gICAgICAgICAgICBhZGRyZXNzVjogaXNDdWJlbWFwID8gQUREUkVTU19DTEFNUF9UT19FREdFIDogQUREUkVTU19SRVBFQVQsXG4gICAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgICBoZWlnaHQ6IGhlaWdodCxcbiAgICAgICAgICAgIGZvcm1hdDogZm9ybWF0LFxuICAgICAgICAgICAgY3ViZW1hcDogaXNDdWJlbWFwLFxuICAgICAgICAgICAgbWlwbWFwczogbWlwcyA+IDFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IG9mZnNldCA9IDEyODtcbiAgICAgICAgY29uc3QgZmFjZXMgPSBpc0N1YmVtYXAgPyA2IDogMTtcbiAgICAgICAgbGV0IG1pcFNpemU7XG4gICAgICAgIGNvbnN0IERYVF9CTE9DS19XSURUSCA9IDQ7XG4gICAgICAgIGNvbnN0IERYVF9CTE9DS19IRUlHSFQgPSA0O1xuICAgICAgICBjb25zdCBibG9ja1NpemUgPSBmY2MgPT09IEZDQ19EWFQxID8gOCA6IDE2O1xuICAgICAgICBsZXQgbnVtQmxvY2tzQWNyb3NzLCBudW1CbG9ja3NEb3duLCBudW1CbG9ja3M7XG4gICAgICAgIGZvciAobGV0IGZhY2UgPSAwOyBmYWNlIDwgZmFjZXM7IGZhY2UrKykge1xuICAgICAgICAgICAgbGV0IG1pcFdpZHRoID0gd2lkdGg7XG4gICAgICAgICAgICBsZXQgbWlwSGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtaXBzOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoY29tcHJlc3NlZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXRjMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWlwU2l6ZSA9IE1hdGguZmxvb3IoKG1pcFdpZHRoICsgMykgLyA0KSAqIE1hdGguZmxvb3IoKG1pcEhlaWdodCArIDMpIC8gNCkgKiA4O1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHB2cnRjMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWlwU2l6ZSA9IE1hdGgubWF4KG1pcFdpZHRoLCAxNikgKiBNYXRoLm1heChtaXBIZWlnaHQsIDgpIC8gNDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwdnJ0YzQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pcFNpemUgPSBNYXRoLm1heChtaXBXaWR0aCwgOCkgKiBNYXRoLm1heChtaXBIZWlnaHQsIDgpIC8gMjtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bUJsb2Nrc0Fjcm9zcyA9IE1hdGguZmxvb3IoKG1pcFdpZHRoICsgRFhUX0JMT0NLX1dJRFRIIC0gMSkgLyBEWFRfQkxPQ0tfV0lEVEgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbnVtQmxvY2tzRG93biA9IE1hdGguZmxvb3IoKG1pcEhlaWdodCArIERYVF9CTE9DS19IRUlHSFQgLSAxKSAvIERYVF9CTE9DS19IRUlHSFQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbnVtQmxvY2tzID0gbnVtQmxvY2tzQWNyb3NzICogbnVtQmxvY2tzRG93bjtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pcFNpemUgPSBudW1CbG9ja3MgKiBibG9ja1NpemU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBtaXBTaXplID0gbWlwV2lkdGggKiBtaXBIZWlnaHQgKiA0O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IG1pcEJ1ZmYgPSBmb3JtYXQgPT09IFBJWEVMRk9STUFUX1JHQkEzMkYgPyBuZXcgRmxvYXQzMkFycmF5KGRhdGEsIG9mZnNldCwgbWlwU2l6ZSkgOlxuICAgICAgICAgICAgICAgICAgICAoZm9ybWF0ID09PSBQSVhFTEZPUk1BVF9SR0JBMTZGID8gbmV3IFVpbnQxNkFycmF5KGRhdGEsIG9mZnNldCwgbWlwU2l6ZSkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFVpbnQ4QXJyYXkoZGF0YSwgb2Zmc2V0LCBtaXBTaXplKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWlzQ3ViZW1hcCkge1xuICAgICAgICAgICAgICAgICAgICB0ZXh0dXJlLl9sZXZlbHNbaV0gPSBtaXBCdWZmO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGV4dHVyZS5fbGV2ZWxzW2ldKSB0ZXh0dXJlLl9sZXZlbHNbaV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGV4dHVyZS5fbGV2ZWxzW2ldW2ZhY2VdID0gbWlwQnVmZjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb2Zmc2V0ICs9IG1pcFNpemUgKiBjb21wb25lbnRTaXplO1xuICAgICAgICAgICAgICAgIG1pcFdpZHRoID0gTWF0aC5tYXgobWlwV2lkdGggKiAwLjUsIDEpO1xuICAgICAgICAgICAgICAgIG1pcEhlaWdodCA9IE1hdGgubWF4KG1pcEhlaWdodCAqIDAuNSwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0ZXh0dXJlLnVwbG9hZCgpO1xuXG4gICAgICAgIHJldHVybiB0ZXh0dXJlO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgRGRzUGFyc2VyIH07XG4iXSwibmFtZXMiOlsiRGRzUGFyc2VyIiwiY29uc3RydWN0b3IiLCJyZWdpc3RyeSIsIm1heFJldHJpZXMiLCJsb2FkIiwidXJsIiwiY2FsbGJhY2siLCJhc3NldCIsIkFzc2V0IiwiZmV0Y2hBcnJheUJ1ZmZlciIsIm9wZW4iLCJkYXRhIiwiZGV2aWNlIiwiaGVhZGVyIiwiVWludDMyQXJyYXkiLCJ3aWR0aCIsImhlaWdodCIsIm1pcHMiLCJNYXRoIiwibWF4IiwiaXNGb3VyQ2MiLCJmY2MiLCJicHAiLCJpc0N1YmVtYXAiLCJGQ0NfRFhUMSIsIkZDQ19EWFQ1IiwiRkNDX0ZQMTYiLCJGQ0NfRlAzMiIsIkZDQ19FVEMxIiwiRkNDX1BWUlRDXzJCUFBfUkdCXzEiLCJGQ0NfUFZSVENfMkJQUF9SR0JBXzEiLCJGQ0NfUFZSVENfNEJQUF9SR0JfMSIsIkZDQ19QVlJUQ180QlBQX1JHQkFfMSIsImNvbXByZXNzZWQiLCJldGMxIiwicHZydGMyIiwicHZydGM0IiwiZm9ybWF0IiwiY29tcG9uZW50U2l6ZSIsInRleHR1cmUiLCJQSVhFTEZPUk1BVF9EWFQxIiwiUElYRUxGT1JNQVRfRFhUNSIsIlBJWEVMRk9STUFUX1JHQkExNkYiLCJQSVhFTEZPUk1BVF9SR0JBMzJGIiwiUElYRUxGT1JNQVRfRVRDMSIsIlBJWEVMRk9STUFUX1BWUlRDXzJCUFBfUkdCXzEiLCJQSVhFTEZPUk1BVF9QVlJUQ18yQlBQX1JHQkFfMSIsIlBJWEVMRk9STUFUX1BWUlRDXzRCUFBfUkdCXzEiLCJQSVhFTEZPUk1BVF9QVlJUQ180QlBQX1JHQkFfMSIsIlBJWEVMRk9STUFUX1I4X0c4X0I4X0E4IiwiRGVidWciLCJlcnJvciIsIlRleHR1cmUiLCJQSVhFTEZPUk1BVF9SOF9HOF9COCIsIm5hbWUiLCJwcm9maWxlckhpbnQiLCJURVhISU5UX0FTU0VUIiwiYWRkcmVzc1UiLCJBRERSRVNTX0NMQU1QX1RPX0VER0UiLCJBRERSRVNTX1JFUEVBVCIsImFkZHJlc3NWIiwiY3ViZW1hcCIsIm1pcG1hcHMiLCJvZmZzZXQiLCJmYWNlcyIsIm1pcFNpemUiLCJEWFRfQkxPQ0tfV0lEVEgiLCJEWFRfQkxPQ0tfSEVJR0hUIiwiYmxvY2tTaXplIiwibnVtQmxvY2tzQWNyb3NzIiwibnVtQmxvY2tzRG93biIsIm51bUJsb2NrcyIsImZhY2UiLCJtaXBXaWR0aCIsIm1pcEhlaWdodCIsImkiLCJmbG9vciIsIm1pcEJ1ZmYiLCJGbG9hdDMyQXJyYXkiLCJVaW50MTZBcnJheSIsIlVpbnQ4QXJyYXkiLCJfbGV2ZWxzIiwidXBsb2FkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBcUJBLE1BQU1BLFNBQVMsQ0FBQztFQUNaQyxXQUFXLENBQUNDLFFBQVEsRUFBRTtJQUNsQixJQUFJLENBQUNDLFVBQVUsR0FBRyxDQUFDLENBQUE7QUFDdkIsR0FBQTtBQUVBQyxFQUFBQSxJQUFJLENBQUNDLEdBQUcsRUFBRUMsUUFBUSxFQUFFQyxLQUFLLEVBQUU7QUFDdkJDLElBQUFBLEtBQUssQ0FBQ0MsZ0JBQWdCLENBQUNKLEdBQUcsQ0FBQ0QsSUFBSSxFQUFFRSxRQUFRLEVBQUVDLEtBQUssRUFBRSxJQUFJLENBQUNKLFVBQVUsQ0FBQyxDQUFBO0FBQ3RFLEdBQUE7QUFFQU8sRUFBQUEsSUFBSSxDQUFDTCxHQUFHLEVBQUVNLElBQUksRUFBRUMsTUFBTSxFQUFFO0FBQ3BCLElBQUEsTUFBTUMsTUFBTSxHQUFHLElBQUlDLFdBQVcsQ0FBQ0gsSUFBSSxFQUFFLENBQUMsRUFBRSxHQUFH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

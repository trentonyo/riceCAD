import"../../core/tracing.js";import{Vec3 as e}from"../../core/math/vec3.js";import{PIXELFORMAT_R8_G8_B8_A8 as t,TEXTURETYPE_DEFAULT as r,TEXTURETYPE_RGBM as l}from"../../platform/graphics/constants.js";import{createShaderFromCode as o}from"../shader-lib/utils.js";import{drawQuadWithShader as s}from"../../platform/graphics/simple-post-effect.js";import{shaderChunks as n}from"../shader-lib/chunks/chunks.js";import{RenderTarget as a}from"../../platform/graphics/render-target.js";import{Texture as f}from"../../platform/graphics/texture.js";function i(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}function m(e,t,r){let l=2*(e+.5)/r-1,o=2*(t+.5)/r-1;l*=1-1/r,o*=1-1/r;const s=1/r,n=l-s,a=o-s,f=l+s,m=o+s;let c=i(n,a)-i(n,m)-i(f,a)+i(f,m);return 0===e&&0===t||e===r-1&&0===t||0===e&&t===r-1||e===r-1&&t===r-1?c/=3:0!==e&&0!==t&&e!==r-1&&t!==r-1||(c*=.5),c}function c(i,c,p){if(c.format!==t)return null;if(!c._levels[0]||!c._levels[0][0])return null;const u=c.width;if(!c._levels[0][0].length){if(!(c._levels[0][0]instanceof HTMLImageElement))return null;{const e=o(i,n.fullscreenQuadVS,n.fullscreenQuadPS,"fsQuadSimple"),t=i.scope.resolve("source");for(let l=0;l<6;l++){const o=c._levels[0][l],n=new f(i,{name:"prefiltered-cube",cubemap:!1,type:r,format:c.format,width:u,height:u,mipmaps:!1});n._levels[0]=o,n.upload();const m=new f(i,{name:"prefiltered-cube",cubemap:!1,type:r,format:c.format,width:u,height:u,mipmaps:!1}),p=new a({colorBuffer:m,depth:!1});t.setValue(n),s(i,p,e);const h=i.gl;h.bindFramebuffer(h.FRAMEBUFFER,p.impl._glFrameBuffer);const d=new Uint8Array(u*u*4);h.readPixels(0,0,n.width,n.height,h.RGBA,h.UNSIGNED_BYTE,d),c._levels[0][l]=d}}}const h=[];for(let t=0;t<u;t++)for(let r=0;r<u;r++){const l=r/(u-1)*2-1,o=t/(u-1)*2-1;h[t*u+r]=new e(l,o,1).normalize()}const d=new Float32Array(27);let g=0;for(let e=0;e<6;e++)for(let t=0;t<u;t++)for(let r=0;r<u;r++){const o=t*u+r,s=m(r,t,u),n=4*s/17,a=8*s/17,f=15*s/17,i=5*s/68,v=15*s/68,w=h[o];let y,_,x;0===e?(y=w.z,_=-w.y,x=-w.x):1===e?(y=-w.z,_=-w.y,x=w.x):2===e?(y=w.x,_=w.z,x=w.y):3===e?(y=w.x,_=-w.z,x=-w.y):4===e?(y=w.x,_=-w.y,x=w.z):5===e&&(y=-w.x,_=-w.y,x=-w.z),p||(y=-y);const b=c._levels[0][e][4*o+3]/255;for(let t=0;t<3;t++){let r=c._levels[0][e][4*o+t]/255;c.type===l?(r*=8*b,r*=r):r=Math.pow(r,2.2),d[0+t]+=r*n,d[3+t]+=r*a*y,d[6+t]+=r*a*_,d[9+t]+=r*a*x,d[12+t]+=r*f*y*x,d[15+t]+=r*f*x*_,d[18+t]+=r*f*_*y,d[21+t]+=r*i*(3*x*x-1),d[24+t]+=r*v*(y*y-_*_),g+=s}}for(let e=0;e<d.length;e++)d[e]*=4*Math.PI/g;return d}export{c as shFromCubemap};

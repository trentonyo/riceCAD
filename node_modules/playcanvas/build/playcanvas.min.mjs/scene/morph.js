import"../core/tracing.js";import{RefCountedObject as t}from"../core/ref-counted-object.js";import{Vec3 as e}from"../core/math/vec3.js";import{FloatPacking as r}from"../core/math/float-packing.js";import{BoundingBox as s}from"../core/shape/bounding-box.js";import{Texture as i}from"../platform/graphics/texture.js";import{VertexBuffer as o}from"../platform/graphics/vertex-buffer.js";import{VertexFormat as h}from"../platform/graphics/vertex-format.js";import{PIXELFORMAT_RGB32F as a,PIXELFORMAT_RGBA16F as n,BUFFER_STATIC as l,FILTER_NEAREST as m,ADDRESS_CLAMP_TO_EDGE as u,SEMANTIC_ATTR15 as p,TYPE_FLOAT32 as c}from"../platform/graphics/constants.js";import{GraphicsDeviceAccess as _}from"../platform/graphics/graphics-device-access.js";class g extends t{constructor(t,e){super(),this.device=e||_.get(),t.forEach((t=>{})),this._targets=t.slice(),this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=g.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=g.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=g.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=g.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_initTextureBased(){const t=[],e=[];for(let r=0;r<this._targets.length;r++){const s=this._targets[r];s.options.deltaPositions&&(t.push(s.options.deltaPositions),e.push({target:s,name:"texturePositions"})),s.options.deltaNormals&&(t.push(s.options.deltaNormals),e.push({target:s,name:"textureNormals"}))}const s=[],i=[];let m=1;const u=t[0].length;for(let e=0;e<u;e+=3){let r=!1;for(let s=0;s<t.length;s++){const i=t[s];if(0!==i[e]||0!==i[e+1]||0!==i[e+2]){r=!0;break}}r?(s.push(m+.2),i.push(e/3),m++):s.push(.2)}const _=Math.min(this.device.maxTextureSize,4096);let x=Math.ceil(Math.sqrt(m));x=Math.min(x,_);const d=Math.ceil(m/x);if(d>_)return!1;this.morphTextureWidth=x,this.morphTextureHeight=d;let f=!1,T=3;const F=r.float2Half;this._textureFormat===g.FORMAT_HALF_FLOAT&&(f=!0,T=4);const M=this.morphTextureWidth*this.morphTextureHeight*T,A=f?new Uint16Array(M):new Float32Array(M);for(let r=0;r<t.length;r++){const s=t[r];for(let t=0;t<i.length;t++){const e=i[t];f?(A[t*T+T]=F(s[3*e]),A[t*T+T+1]=F(s[3*e+1]),A[t*T+T+2]=F(s[3*e+2])):(A[t*T+T]=s[3*e],A[t*T+T+1]=s[3*e+1],A[t*T+T+2]=s[3*e+2])}const o=e[r].target,h=this._textureFormat===g.FORMAT_FLOAT?a:n;o._setTexture(e[r].name,this._createTexture("MorphTarget",h,A))}const v=[{semantic:p,components:1,type:c}];return this.vertexBufferIds=new o(this.device,new h(this.device,v),s.length,l,new Float32Array(s)),!0}destroy(){var t;null==(t=this.vertexBufferIds)||t.destroy(),this.vertexBufferIds=null;for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_calculateAabb(){const t=new e,r=new e;for(let e=0;e<this._targets.length;e++){const s=this._targets[e].aabb;t.min(s.getMin()),r.max(s.getMax())}this.aabb=new s,this.aabb.setMinMax(t,r)}_createTexture(t,e,r){const s=new i(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:m,magFilter:m,addressU:u,addressV:u,name:t});return r&&(s.lock().set(r),s.unlock()),s}}g.FORMAT_FLOAT=0,g.FORMAT_HALF_FLOAT=1;export{g as Morph};

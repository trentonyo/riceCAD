import"../core/tracing.js";import{hashCode as t}from"../core/hash.js";import{SORTMODE_MATERIALMESH as e,SORTMODE_BACK2FRONT as s,SHADER_FORWARD as i,BLEND_NONE as r,LIGHTTYPE_DIRECTIONAL as h,LAYER_FX as a,SORTMODE_NONE as n,SORTMODE_CUSTOM as l,SORTMODE_FRONT2BACK as o,SORTKEY_FORWARD as c}from"./constants.js";import{Material as d}from"./materials/material.js";let u,g,_,p;const f=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){return u=t._key[c],g=e._key[c],u===g&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:g-u},function(t,e){return e.zdist-t.zdist},function(t,e){return t.zdist-e.zdist}];function m(t,e){return e.key-t.key}let C=0;class b{constructor(){this.list=[],this.length=0,this.done=!1}}class S{constructor(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}prepare(t){this.visibleOpaque[t]||(this.visibleOpaque[t]=new b),this.visibleTransparent[t]||(this.visibleTransparent[t]=new b),this.visibleOpaque[t].done=!1,this.visibleTransparent[t].done=!1}delete(t){t<this.visibleOpaque.length&&this.visibleOpaque.splice(t,1),t<this.visibleTransparent.length&&this.visibleTransparent.splice(t,1)}}class y{constructor(t={}){void 0!==t.id?(this.id=t.id,C=Math.max(this.id+1,C)):this.id=C++,this.name=t.name,this._enabled=void 0===t.enabled||t.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=void 0===t.opaqueSortMode?e:t.opaqueSortMode,this.transparentSortMode=void 0===t.transparentSortMode?s:t.transparentSortMode,t.renderTarget&&(this.renderTarget=t.renderTarget),this.shaderPass=void 0===t.shaderPass?i:t.shaderPass,this.passThrough=void 0!==t.passThrough&&t.passThrough,this._clearColorBuffer=!!t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer,this.onPreCull=t.onPreCull,this.onPreRender=t.onPreRender,this.onPreRenderOpaque=t.onPreRenderOpaque,this.onPreRenderTransparent=t.onPreRenderTransparent,this.onPostCull=t.onPostCull,this.onPostRender=t.onPostRender,this.onPostRenderOpaque=t.onPostRenderOpaque,this.onPostRenderTransparent=t.onPostRenderTransparent,this.onDrawCall=t.onDrawCall,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=t.layerReference,this.instances=t.layerReference?t.layerReference.instances:new S,this.cullingMask=t.cullingMask?t.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}get hasClusteredLights(){return this._clusteredLightsSet.size>0}set renderTarget(t){this._renderTarget=t,this._dirtyCameras=!0}get renderTarget(){return this._renderTarget}set enabled(t){t!==this._enabled&&(this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyCameras=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyCameras=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyCameras=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(t,e){const s=this._shaderVersion,i=this.shadowCasters;for(let h=0;h<t.length;h++){const a=t[h],n=a.material,l=n.blendType===r?this.opaqueMeshInstances:this.transparentMeshInstances;this.opaqueMeshInstances.indexOf(a)<0&&this.transparentMeshInstances.indexOf(a)<0&&l.push(a),!e&&a.castShadow&&i.indexOf(a)<0&&i.push(a),!this.passThrough&&s>=0&&n._shaderVersion!==s&&(n.getShaderVariant!==d.prototype.getShaderVariant&&n.clearVariants(),n._shaderVersion=s)}this.passThrough||(this._dirty=!0)}removeMeshInstanceFromArray(t,e){let s=-1,i=0;const r=e.length;for(let h=0;h<r;h++){const r=e[h];if(r===t){s=h,i=1;break}if(r._staticSource===t)s<0&&(s=h),i++;else if(s>=0)break}s>=0&&e.splice(s,i)}removeMeshInstances(t,e){const s=this.opaqueMeshInstances,i=this.transparentMeshInstances,r=this.shadowCasters;for(let h=0;h<t.length;h++){const a=t[h];if(this.removeMeshInstanceFromArray(a,s),this.removeMeshInstanceFromArray(a,i),!e){const t=r.indexOf(a);t>=0&&r.splice(t,1)}}this._dirty=!0}clearMeshInstances(t){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!t&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,t||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),this._lights.push(e),this._dirtyLights=!0,this._generateLightHash()),e.type!==h&&this._clusteredLightsSet.add(e)}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this._dirtyLights=!0,this._generateLightHash()),e.type!==h&&this._clusteredLightsSet.delete(e)}clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0}addShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=t[s];i.castShadow&&(e.indexOf(i)<0&&e.push(i))}this._dirtyLights=!0}removeShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=e.indexOf(t[s]);i>=0&&e.splice(i,1)}this._dirtyLights=!0}_generateLightHash(){if(this._lights.length>0){this._lights.sort(m);let e="",s="";for(let t=0;t<this._lights.length;t++)this._lights[t].isStatic?s+=this._lights[t].key:e+=this._lights[t].key;0===e.length?this._lightHash=0:this._lightHash=t(e),0===s.length?this._staticLightHash=0:this._staticLightHash=t(s)}else this._lightHash=0,this._staticLightHash=0}addCamera(t){this.cameras.indexOf(t)>=0||(this.cameras.push(t),this._dirtyCameras=!0)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this._dirtyCameras=!0,this.instances.delete(e))}clearCameras(){this.cameras.length=0,this._dirtyCameras=!0}_calculateSortDistances(t,e,s,i){for(let r=0;r<e;r++){const e=t[r];if(e.command)continue;if(e.layer<=a)continue;if(e.calculateSortDistance){e.zdist=e.calculateSortDistance(e,s,i);continue}const h=e.aabb.center,n=h.x-s.x,l=h.y-s.y,o=h.z-s.z;e.zdist=n*i.x+l*i.y+o*i.z}}_sortVisible(t,e,i){const r=this.instances,h=t?this.transparentSortMode:this.opaqueSortMode;if(h===n)return;const a=t?r.visibleTransparent[i]:r.visibleOpaque[i];h===l?(_=e.getPosition(),p=e.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,a.length,_,p),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback)):(h!==s&&h!==o||(_=e.getPosition(),p=e.forward,this._calculateSortDistances(a.list,a.length,_,p)),a.list.length!==a.length&&(a.list.length=a.length),a.list.sort(f[h]))}}export{y as Layer};

import{_matTex2D as e}from"../shader-lib/programs/standard.js";import{PIXELFORMAT_DXT5 as t,TEXTURETYPE_SWIZZLEGGGR as n}from"../../platform/graphics/constants.js";import{SHADER_FORWARDHDR as i,GAMMA_SRGBHDR as a,TONEMAP_LINEAR as s,SHADERDEF_TANGENTS as o,SHADERDEF_SCREENSPACE as l,SHADERDEF_SKIN as r,SHADERDEF_INSTANCING as c,SHADERDEF_MORPH_POSITION as p,SHADERDEF_MORPH_NORMAL as u,SHADERDEF_MORPH_TEXTURE_BASED as d,BLEND_NONE as g,GAMMA_NONE as h,SPECULAR_PHONG as f,SHADERDEF_NOSHADOW as m,SHADERDEF_LM as M,SHADERDEF_DIRLM as b,SHADERDEF_LMAMBIENT as S,MASK_AFFECT_DYNAMIC as T,LIGHTTYPE_DIRECTIONAL as v,LIGHTTYPE_OMNI as y,LIGHTTYPE_SPOT as E,SHADERDEF_UV0 as C,SHADERDEF_UV1 as x,SHADERDEF_VCOLOR as _}from"../constants.js";import{Quat as L}from"../../core/math/quat.js";const A=(e,t)=>{if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0},k=e=>1!==e.r||1!==e.g||1!==e.b;class F{constructor(){this._mapXForms=null}updateMinRef(e,t,n,i,a,s,o){this._updateSharedOptions(e,t,n,i,s),this._updateMinOptions(e,n),this._updateUVOptions(e,n,i,!0)}updateRef(e,t,n,l,r,c,p){this._updateSharedOptions(e,t,n,l,c),this._updateEnvOptions(e,n,t),this._updateMaterialOptions(e,n),c===i&&(e.gamma&&(e.gamma=a),e.toneMap=s),e.hasTangents=l&&0!=(l&o),this._updateLightOptions(e,n,l,p,r),this._updateUVOptions(e,n,l,!1)}_updateSharedOptions(e,t,n,i,a){e.pass=a,e.alphaTest=n.alphaTest>0,e.forceFragmentPrecision=n.forceFragmentPrecision||"",e.chunks=n.chunks||"",e.blendType=n.blendType,e.forceUv1=n.forceUv1,e.separateAmbient=!1,e.screenSpace=i&&0!=(i&l),e.skin=i&&0!=(i&r),e.useInstancing=i&&0!=(i&c),e.useMorphPosition=i&&0!=(i&p),e.useMorphNormal=i&&0!=(i&u),e.useMorphTextureBased=i&&0!=(i&d),e.nineSlicedMode=n.nineSlicedMode||0,t.clusteredLightingEnabled&&n.useLighting?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.clusteredLightingShadowType=t.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(t,n,i,a){let s=!1,o=!1,l=!1;i&&(s=0!=(i&C),o=0!=(i&x),l=0!=(i&_)),t.vertexColors=!1,this._mapXForms=[];const r={};for(const i in e)this._updateTexOptions(t,n,i,s,o,l,a,r);this._mapXForms=null}_updateMinOptions(e,t){e.opacityTint=1!==t.opacity&&t.blendType!==g,e.lights=[]}_updateMaterialOptions(e,i){var a,s,o,l;const r=(i.diffuseTint||!i.diffuseMap&&!i.diffuseVertexColor)&&k(i.diffuse),c=!!(i.useMetalness||i.specularMap||i.sphereMap||i.cubeMap||(p=i.specular,0!==p.r||0!==p.g||0!==p.b)||i.specularityFactor>0&&i.useMetalness||i.enableGGXSpecular||i.clearCoat>0);var p;const u=!i.useMetalness||i.useMetalnessSpecularColor,d=c&&(i.specularTint||!i.specularMap&&!i.specularVertexColor)&&k(i.specular),h=c&&i.useMetalnessSpecularColor&&(i.specularityFactorTint||i.specularityFactor<1&&!i.specularityFactorMap),f=!i.emissiveMap||k(i.emissive)&&i.emissiveTint,m=1!==i.emissiveIntensity,M=!!i.normalMap&&(i.normalMap.format===t||i.normalMap.type===n);e.opacityTint=1!==i.opacity&&i.blendType!==g?1:0,e.blendMapsWithColors=!0,e.ambientTint=i.ambientTint,e.diffuseTint=r?2:0,e.specularTint=d?2:0,e.specularityFactorTint=h?1:0,e.useSpecularityFactor=(h||!!i.specularityFactorMap)&&i.useMetalnessSpecularColor,e.useSpecularColor=u,e.metalnessTint=i.useMetalness&&i.metalness<1?1:0,e.glossTint=1,e.emissiveTint=(f?2:0)+(m?1:0),e.alphaToCoverage=i.alphaToCoverage,e.normalizeNormalMap=i.normalizeNormalMap,e.ambientSH=!!i.ambientSH,e.useSpecular=c,e.diffuseEncoding=null==(a=i.diffuseMap)?void 0:a.encoding,e.diffuseDetailEncoding=null==(s=i.diffuseDetailMap)?void 0:s.encoding,e.emissiveEncoding=null==(o=i.emissiveMap)?void 0:o.encoding,e.lightMapEncoding=null==(l=i.lightMap)?void 0:l.encoding,e.conserveEnergy=i.conserveEnergy,e.opacityFadesSpecular=i.opacityFadesSpecular,e.alphaFade=i.alphaFade,e.occludeSpecular=i.occludeSpecular,e.occludeSpecularFloat=1!==i.occludeSpecularIntensity,e.occludeDirect=i.occludeDirect,e.shadingModel=i.shadingModel,e.fresnelModel=i.fresnelModel,e.packedNormal=M,e.fastTbn=i.fastTbn,e.cubeMapProjection=i.cubeMapProjection,e.customFragmentShader=i.customFragmentShader,e.refraction=(i.refraction||!!i.refractionMap)&&(i.useDynamicRefraction||!!e.reflectionSource),e.refractionTint=1!==i.refraction?1:0,e.useDynamicRefraction=i.useDynamicRefraction,e.refractionIndexTint=i.refractionIndex!==1/1.5?1:0,e.thicknessTint=i.useDynamicRefraction&&1!==i.thickness?1:0,e.useMetalness=i.useMetalness,e.specularEncoding=i.specularEncoding||"linear",e.sheenEncoding=i.sheenEncoding||"linear",e.enableGGXSpecular=i.enableGGXSpecular,e.msdf=!!i.msdfMap,e.msdfTextAttribute=!!i.msdfTextAttribute,e.twoSidedLighting=i.twoSidedLighting,e.pixelSnap=i.pixelSnap,e.aoMapUv=i.aoUvSet,e.diffuseDetail=!!i.diffuseMap,e.normalDetail=!!i.normalMap,e.diffuseDetailMode=i.diffuseDetailMode,e.detailModes=!!e.diffuseDetail,e.clearCoat=!!i.clearCoat,e.clearCoatTint=1!==i.clearCoat?1:0,e.clearCoatGlossiness=!!i.clearCoatGlossiness,e.clearCoatGlossTint=1!==i.clearCoatGlossiness?1:0,e.iridescence=i.useIridescence&&0!==i.iridescence,e.iridescenceTint=1!==i.iridescence?1:0,e.sheen=i.useSheen,e.sheenTint=i.useSheen&&k(i.sheen)?2:0,e.sheenGlossinessTint=1}_updateEnvOptions(e,t,n){e.fog=t.useFog?n.fog:"none",e.gamma=t.useGammaTonemap?n.gammaCorrection:h,e.toneMap=t.useGammaTonemap?n.toneMapping:-1,e.fixSeams=!!t.cubeMap&&t.cubeMap.fixCubemapSeams;const i=t.shadingModel===f;let a=!1;if(t.envAtlas&&t.cubeMap&&!i?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=t.envAtlas.encoding):t.envAtlas&&!i?(e.reflectionSource="envAtlas",e.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.reflectionSource="cubeMap",e.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.reflectionSource="sphereMap",e.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&n.envAtlas&&n.skybox&&!i?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=n.envAtlas.encoding,a=!0):t.useSkybox&&n.envAtlas&&!i?(e.reflectionSource="envAtlas",e.reflectionEncoding=n.envAtlas.encoding,a=!0):t.useSkybox&&n.skybox?(e.reflectionSource="cubeMap",e.reflectionEncoding=n.skybox.encoding,a=!0):(e.reflectionSource=null,e.reflectionEncoding=null),t.ambientSH&&!i)e.ambientSource="ambientSH",e.ambientEncoding=null;else{const a=t.envAtlas||(t.useSkybox&&n.envAtlas?n.envAtlas:null);a&&!i?(e.ambientSource="envAtlas",e.ambientEncoding=a.encoding):(e.ambientSource="constant",e.ambientEncoding=null)}e.skyboxIntensity=a&&(1!==n.skyboxIntensity||n.physicalUnits),e.useCubeMapRotation=a&&n.skyboxRotation&&!n.skyboxRotation.equals(L.IDENTITY)}_updateLightOptions(e,t,n,i,a){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.lightMapWithoutAmbient=!1,e.dirLightMap=!1,n&&(e.noShadow=0!=(n&m),0!=(n&M)&&(e.lightMapEncoding="rgbm",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.lightMapWithoutAmbient=!t.lightMap,0!=(n&b)&&(e.dirLightMap=!0),0!=(n&S)&&(e.lightMapWithoutAmbient=!1))),t.useLighting){const t=[],s=n?n>>16:T;e.lightMaskDynamic=!!(s&T),i&&(this._collectLights(v,i[v],t,s),this._collectLights(y,i[y],t,s,a),this._collectLights(E,i[E],t,s,a)),e.lights=t}else e.lights=[];0===e.lights.length&&(e.noShadow=!0)}_updateTexOptions(e,t,n,i,a,s,o,l){const r=n+"Map",c=n+"VertexColor",p=n+"VertexColorChannel",u=r+"Channel",d=r+"Transform",h=r+"Uv",f=r+"Identifier";"light"!==n&&(e[r]=!1,e[u]="",e[d]=0,e[h]=0,e[f]=void 0),e[c]=!1,e[p]="";const m="opacity"===n;if((!m||t.blendType!==g||0!==t.alphaTest||t.alphaToCoverage)&&(!o||m)&&("height"!==n&&t[c]&&s&&(e[c]=t[c],e[p]=t[p],e.vertexColors=!0),t[r])){let s=!0;if(0!==t[h]||i||(s=!1),1!==t[h]||a||(s=!1),s){const i=t[r].id;let a=l[i];void 0===a&&(l[i]=n,a=n),e[r]=!!t[r],e[f]=a,e[d]=this._getMapTransformID(t.getUniform(d),t[h]),e[u]=t[u],e[h]=t[h]}}}_collectLights(e,t,n,i,a){for(let a=0;a<t.length;a++){const s=t[a];if(s.enabled&&s.mask&i){if(e!==v&&s.isStatic)continue;n.push(s)}}if(a)for(let t=0;t<a.length;t++){const i=a[t];i._type===e&&n.push(i)}}_getMapTransformID(e,t){if(!e)return 0;let n=this._mapXForms[t];n||(n=[],this._mapXForms[t]=n);for(let t=0;t<n.length;t++)if(A(n[t][0].value,e[0].value)&&A(n[t][1].value,e[1].value))return t+1;return n.push(e)}}export{F as StandardMaterialOptionsBuilder};

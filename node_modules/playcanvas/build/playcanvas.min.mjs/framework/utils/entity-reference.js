import{Component as t}from"../components/component.js";import{Entity as e}from"../entity.js";import{EventHandler as n}from"../../core/event-handler.js";class s extends n{constructor(e,n,s){if(super(),!(e&&e instanceof t))throw new Error("The parentComponent argument is required and must be a Component");if(!n||"string"!=typeof n)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=n,this._entity=null,this._app=e.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(t,e){const n=this._parseEventListenerConfig(t,"external",this._parentComponent),s=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=n.concat(s),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(t,e,n){return Object.keys(t).map((function(s,i){const o=s.split("#"),r=o[0],a=o[1],h=t[s];if(2!==o.length||"string"!=typeof r||0===r.length||"string"!=typeof a||0===a.length)throw new Error("Invalid event listener description: `"+s+"`");if("function"!=typeof h)throw new Error("Invalid or missing callback for event listener `"+s+"`");return{id:e+"_"+i+"_"+s,sourceName:r,eventName:a,callback:h,scope:n}}),this)}_toggleLifecycleListeners(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),this._app.systems[t]("postPostInitialize",this._updateEntityReference,this),this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);const e=[];for(let t=0;t<this._eventListenerConfigs.length;++t){const n=this._eventListenerConfigs[t],s=this._app.systems[n.sourceName];s&&(-1===e.indexOf(s)&&e.push(s),s&&"gain"===n.eventName&&(this._gainListeners[n.sourceName]=n),s&&"lose"===n.eventName&&(this._loseListeners[n.sourceName]=n))}for(let n=0;n<e.length;++n)e[n][t]("add",this._onComponentAdd,this),e[n][t]("beforeremove",this._onComponentRemove,this)}_onSetEntity(t,n,s){if(s instanceof e)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");n!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let t,n=this._parentComponent.data[this._entityPropertyName];if(n instanceof e)t=n,n=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=n;else{const e=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(e)&&n?e.findByGuid(n):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(t,e){const n=e.system.id;t===this._entity&&(this._callGainOrLoseListener(n,this._gainListeners),this._toggleComponentListeners("on",n))}_onComponentRemove(t,e){const n=e.system.id;t===this._entity&&(this._callGainOrLoseListener(n,this._loseListeners),this._toggleComponentListeners("off",n,!0))}_callAllGainOrLoseListeners(t){for(const e in this._entity.c)this._callGainOrLoseListener(e,t)}_callGainOrLoseListener(t,e){if(this._entity.c.hasOwnProperty(t)&&e[t]){const n=e[t];n.callback.call(n.scope)}}_toggleEntityListeners(t,e){if(this._entity)for(let n=0;n<this._eventListenerConfigs.length;++n)this._safeToggleListener(t,this._eventListenerConfigs[n],e)}_toggleComponentListeners(t,e,n){for(let s=0;s<this._eventListenerConfigs.length;++s){const i=this._eventListenerConfigs[s];i.sourceName===e&&this._safeToggleListener(t,i,n)}}_safeToggleListener(t,e,n){const s="on"===t;if(s&&this._listenerStatusFlags[e.id])return;const i=this._getEventSource(e.sourceName,n);i&&(i[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=s)}_getEventSource(t,e){if("entity"===t)return this._entity;const n=this._entity[t];return n||(e||console.warn("Entity has no component with name "+t),null)}_onEntityDestroy(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(t){return!(!this._entity||!this._entity.c)&&!!this._entity.c[t]}get entity(){return this._entity}}export{s as EntityReference};

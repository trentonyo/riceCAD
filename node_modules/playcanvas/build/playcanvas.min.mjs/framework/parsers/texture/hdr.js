import{ReadStream as r}from"../../../core/read-stream.js";import"../../../core/tracing.js";import{Texture as e}from"../../../platform/graphics/texture.js";import{ADDRESS_REPEAT as t,ADDRESS_CLAMP_TO_EDGE as s,FILTER_NEAREST as n,PIXELFORMAT_R8_G8_B8_A8 as a,TEXTURETYPE_RGBE as i}from"../../../platform/graphics/constants.js";import{Asset as l}from"../../asset/asset.js";class o{constructor(r){this.maxRetries=0}load(r,e,t){l.fetchArrayBuffer(r.load,e,t,this.maxRetries)}open(r,l,o){const f=this.parse(l);if(!f)return null;const u=new e(o,{name:r,addressU:t,addressV:s,minFilter:n,magFilter:n,width:f.width,height:f.height,levels:f.levels,format:a,type:i,mipmaps:!1});return u.upload(),u}parse(e){const t=new r(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const r=t.readLine();if(0===r.length)break;{const e=r.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const n=t.readLine().split(" ");if(4!==n.length)return null;const a=parseInt(n[1],10),i=parseInt(n[3],10),l=this._readPixels(t,i,a,"-Y"===n[0]);return l?{width:i,height:a,levels:[l]}:null}_readPixels(r,e,t,s){if(e<8||e>32767)return this._readPixelsFlat(r,e,t);const n=[0,0,0,0];if(r.readArray(n),2!==n[0]||2!==n[1]||0!=(128&n[2]))return r.skip(-4),this._readPixelsFlat(r,e,t);const a=new ArrayBuffer(e*t*4),i=new Uint8Array(a);let l,o,f,u,d,h,p=s?0:4*e*(t-1);for(o=0;o<t;++o){if(o&&r.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(u=0;u<4;++u)for(l=0;l<e;)if(d=r.readU8(),d>128){if(d-=128,l+d>e)return null;for(h=r.readU8(),f=0;f<d;++f)i[p+u+4*l++]=h}else{if(0===d||l+d>e)return null;for(f=0;f<d;++f)i[p+u+4*l++]=r.readU8()}p+=4*e*(s?1:-1)}return i}_readPixelsFlat(r,e,t){return r.remainingBytes===e*t*4?new Uint8Array(r.arraybuffer,r.offset):null}}export{o as HdrParser};

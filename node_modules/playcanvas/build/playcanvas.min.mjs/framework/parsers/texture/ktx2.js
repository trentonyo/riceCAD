import"../../../core/tracing.js";import{Asset as e}from"../../asset/asset.js";import{Texture as t}from"../../../platform/graphics/texture.js";import{basisTranscode as r}from"../../handlers/basis.js";import{ReadStream as s}from"../../../core/read-stream.js";import{ADDRESS_CLAMP_TO_EDGE as a,ADDRESS_REPEAT as d}from"../../../platform/graphics/constants.js";const o=166;class i{constructor(e,t){this.maxRetries=0,this.device=t}load(t,r,s){e.fetchArrayBuffer(t.load,((e,a)=>{e?r(e,a):this.parse(a,t,r,s)}),s,this.maxRetries)}open(e,r,s){const o=new t(s,{name:e,addressU:r.cubemap?a:d,addressV:r.cubemap?a:d,width:r.width,height:r.height,format:r.format,cubemap:r.cubemap,levels:r.levels});return o.upload(),o}parse(e,t,a,d){const i=new s(e),n=[i.readU32be(),i.readU32be(),i.readU32be()];if(2873840728!==n[0]||540160187!==n[1]||218765834!==n[2])return null;const l={vkFormat:i.readU32(),typeSize:i.readU32(),pixelWidth:i.readU32(),pixelHeight:i.readU32(),pixelDepth:i.readU32(),layerCount:i.readU32(),faceCount:i.readU32(),levelCount:i.readU32(),supercompressionScheme:i.readU32()},p={dfdByteOffset:i.readU32(),dfdByteLength:i.readU32(),kvdByteOffset:i.readU32(),kvdByteLength:i.readU32(),sgdByteOffset:i.readU64(),sgdByteLength:i.readU64()},f=[];for(let e=0;e<Math.max(1,l.levelCount);++e)f.push({byteOffset:i.readU64(),byteLength:i.readU64(),uncompressedByteLength:i.readU64()});if(i.readU32()!==p.kvdByteOffset-p.dfdByteOffset)return null;i.skip(8);const m=i.readU8();if(i.skip(p.dfdByteLength-9),i.skip(p.kvdByteLength),1===l.supercompressionScheme||m===o){var u,h,c;r(this.device,t.load,e,a,{isGGGR:0!=(8&(null==d||null==(u=d.file)||null==(h=u.variants)||null==(c=h.basis)?void 0:c.opt)),isKTX2:!0})||a('Basis module not found. Asset "'+d.name+'" basis texture variant will not be loaded.')}else a("unsupported KTX2 pixel format")}}export{i as Ktx2Parser};

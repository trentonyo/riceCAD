import{path as t}from"../../core/path.js";import{string as e}from"../../core/string.js";import{http as a}from"../../platform/net/http.js";import{Font as o}from"../font/font.js";function r(t){return t.version<3&&(t.version<2&&(t.info.maps=t.info.maps||[{width:t.info.width,height:t.info.height}]),t.chars=Object.keys(t.chars||{}).reduce((function(a,o){const r=t.chars[o],n=void 0!==r.letter?r.letter:e.fromCodePoint(o);return t.version<2&&(r.map=r.map||0),a[n]=r,a}),{}),t.version=3),t}class n{constructor(t){this.handlerType="font",this._loader=t.loader,this.maxRetries=0}load(e,o,n){"string"==typeof e&&(e={load:e,original:e});const i=this;".json"===t.getExtension(e.original)?a.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(t,a){if(t)o(`Error loading font resource: ${e.original} [${t}]`);else{const t=r(a);i._loadTextures(e.load.replace(".json",".png"),t,(function(e,a){if(e)return o(e);o(null,{data:t,textures:a})}))}})):(n&&n.data&&(n.data=r(n.data)),this._loadTextures(e.load,n&&n.data,o))}_loadTextures(t,e,a){const o=e.info.maps.length;let r=0,n=null;const i=new Array(o),s=this._loader,d=function(e){const d=function(t,s){if(!n){if(t)return n=t,a(t);s.upload(),i[e]=s,r++,r===o&&a(null,i)}};0===e?s.load(t,"texture",d):s.load(t.replace(".png",e+".png"),"texture",d)};for(let t=0;t<o;t++)d(t)}open(t,e,a){let r;return r=e.textures?new o(e.textures,e.data):new o(e,null),r}patch(t,e){const a=t.resource;!a.data&&t.data?a.data=t.data:!t.data&&a.data&&(t.data=a.data),t.data&&(t.data=r(t.data))}}export{n as FontHandler};

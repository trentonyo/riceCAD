import"../../core/tracing.js";import{PIXELFORMAT_R5_G6_B5 as e,PIXELFORMAT_R4_G4_B4_A4 as t}from"../../platform/graphics/constants.js";import{BasisWorker as r}from"./basis-worker.js";import{http as s}from"../../platform/net/http.js";const l=e=>({astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC});class n{constructor(e,t,r){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",(e=>{const t=e.data;this.queue.handleResponse(t.url,t.err,t.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:t}),this.eager=r}run(e){const t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}}const i=["etc1","etc2","astc","dxt","pvr","atc"],a=["astc","dxt","etc2","pvr","atc"],o=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(e,t,r,s){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(r);else{this.callbacks[e]=[r];const l={url:e,data:t,options:s};this.clients.length>0?this.clients.shift().run(l):this.queue.push(l)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(r,s,l){const n=this.callbacks[r];if(s)for(let e=0;e<n.length;++e)n[e](s);else{l.format===e||l.format===t?l.levels=l.levels.map((function(e){return new Uint16Array(e)})):l.levels=l.levels.map((function(e){return new Uint8Array(e)}));for(let e=0;e<n.length;++e)n[e](null,l)}delete this.callbacks[r]}};let c=null,u=!1;function m(e){if(!u){if(e){if(e.lazyInit)return void(c=e)}else e=c||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){const t=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find((function(e){return"BASIS"===e.moduleName}));if(t){const r=window.ASSET_PREFIX||"";e.glueUrl||(e.glueUrl=r+t.glueUrl),e.wasmUrl||(e.wasmUrl=r+t.wasmUrl),e.fallbackUrl||(e.fallbackUrl=r+t.fallbackUrl)}}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){u=!0;const t=Math.max(1,Math.min(16,e.numWorkers||1)),l=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||i,e.rgbaPriority=e.rgbaPriority||a,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,((e,t)=>{const l=()=>{const e="("+r.toString()+")()\n\n";return new Blob([e],{type:"application/javascript"})},n=(r,s)=>{t(null,{workerUrl:URL.createObjectURL(l()),basisUrl:URL.createObjectURL(r),module:s,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority})},i={responseType:"blob",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})()){let r=null,l=null;s.get(e.glueUrl,i,((e,s)=>{e?t(e):l?n(s,l):r=s}));const a=fetch(e.wasmUrl),o=()=>{a.then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e))).then((e=>{r?n(r,e):l=e})).catch((e=>{t(e,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then((e=>{r?n(r,e):l=e})).catch((e=>{o()})):o()}else s.get(e.fallbackUrl,i,((e,r)=>{e?t(e,null):n(r,null)}))})(e,((e,r)=>{if(e)console.error(`failed to initialize basis worker: ${e}`);else for(let e=0;e<t;++e)o.enqueueClient(new n(o,r,l))}))}}}let f=null;function h(e,t,r,s,n){return m(),f||(f={webgl2:e.webgl2,formats:l(e)}),o.enqueueJob(t,r,s,{deviceDetails:f,isGGGR:!(null==n||!n.isGGGR),isKTX2:!(null==n||!n.isKTX2)}),u}export{m as basisInitialize,h as basisTranscode};

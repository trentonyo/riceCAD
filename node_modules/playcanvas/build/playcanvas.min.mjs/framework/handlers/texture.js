import{path as e}from"../../core/path.js";import{PIXELFORMAT_R8_G8_B8 as r,TEXTURETYPE_RGBM as t,TEXTURETYPE_SWIZZLEGGGR as s,ADDRESS_REPEAT as a,ADDRESS_CLAMP_TO_EDGE as i,ADDRESS_MIRRORED_REPEAT as o,FILTER_NEAREST as n,FILTER_LINEAR as l,FILTER_NEAREST_MIPMAP_NEAREST as p,FILTER_LINEAR_MIPMAP_NEAREST as m,FILTER_NEAREST_MIPMAP_LINEAR as h,FILTER_LINEAR_MIPMAP_LINEAR as f,TEXTURETYPE_DEFAULT as c,TEXTURETYPE_RGBE as g,TEXTURETYPE_RGBP as d,PIXELFORMAT_R8_G8_B8_A8 as _,PIXELFORMAT_RGBA32F as u}from"../../platform/graphics/constants.js";import{Texture as w}from"../../platform/graphics/texture.js";import{BasisParser as x}from"../parsers/texture/basis.js";import{ImgParser as P}from"../parsers/texture/img.js";import{KtxParser as v}from"../parsers/texture/ktx.js";import{Ktx2Parser as y}from"../parsers/texture/ktx2.js";import{DdsParser as O}from"../parsers/texture/dds.js";import{HdrParser as b}from"../parsers/texture/hdr.js";const M={repeat:a,clamp:i,mirror:o},j={nearest:n,linear:l,nearest_mip_nearest:p,linear_mip_nearest:m,nearest_mip_linear:h,linear_mip_linear:f},R={default:c,rgbm:t,rgbe:g,rgbp:d,swizzleGGGR:s};class E{load(e,r,t){throw new Error("not implemented")}open(e,r,t){throw new Error("not implemented")}}class G{constructor(e){this.handlerType="texture";const r=e.assets,t=e.graphicsDevice;this._device=t,this._assets=r,this._loader=e.loader,this.imgParser=new P(r,t),this.parsers={dds:new O(r),ktx:new v(r),ktx2:new y(r,t),basis:new x(r,t),hdr:new b(r)}}set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){this.imgParser.maxRetries=e;for(const r in this.parsers)this.parsers.hasOwnProperty(r)&&(this.parsers[r].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(r){const t=e.getExtension(this._getUrlWithoutParams(r)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}load(e,r,t){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,r,t)}open(e,t,s){if(!e)return;let a=this._getParser(e).open(e,t,this._device);return null===a?a=new w(this._device,{width:4,height:4,format:r}):(!function(e){const r=Math.log2(Math.max(e._width,e._height))+1;if(e._format!==_&&e._format!==u||e._volume||e._compressed||1===e._levels.length||e._levels.length===r||(t=e._cubemap?e._levels[0][0]:e._levels[0])instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement)return;var t;const s=function(e,r,t){const s=Math.max(1,e>>1),a=Math.max(1,r>>1),i=new t.constructor(s*a*4),o=Math.floor(e/s),n=Math.floor(r/a),l=o*n;for(let r=0;r<a;++r)for(let a=0;a<s;++a)for(let p=0;p<4;++p){let m=0;for(let s=0;s<n;++s)for(let i=0;i<o;++i)m+=t[4*(a*o+i+(r*n+s)*e)+p];i[4*(a+r*s)+p]=m/l}return i};for(let t=e._levels.length;t<r;++t){const r=Math.max(1,e._width>>t-1),a=Math.max(1,e._height>>t-1);if(e._cubemap){const i=[];for(let o=0;o<6;++o)i.push(s(r,a,e._levels[t-1][o]));e._levels.push(i)}else e._levels.push(s(r,a,e._levels[t-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(a),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),a}patch(e,r){const a=e.resource;if(!a)return;e.name&&e.name.length>0&&(a.name=e.name);const i=e.data;i.hasOwnProperty("minfilter")&&(a.minFilter=j[i.minfilter]),i.hasOwnProperty("magfilter")&&(a.magFilter=j[i.magfilter]),a.cubemap||(i.hasOwnProperty("addressu")&&(a.addressU=M[i.addressu]),i.hasOwnProperty("addressv")&&(a.addressV=M[i.addressv])),i.hasOwnProperty("mipmaps")&&(a.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(a.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(a.flipY=!!i.flipY),i.hasOwnProperty("type")?a.type=R[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?a.type=t:e.file&&0!=(8&e.file.opt)&&(a.type=s)}}export{G as TextureHandler,E as TextureParser};

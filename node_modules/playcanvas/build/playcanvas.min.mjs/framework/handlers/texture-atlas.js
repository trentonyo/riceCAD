import{path as e}from"../../core/path.js";import{http as r}from"../../platform/net/http.js";import{Vec2 as a}from"../../core/math/vec2.js";import{Vec4 as t}from"../../core/math/vec4.js";import{TEXTURETYPE_RGBM as s,TEXTURETYPE_DEFAULT as o,ADDRESS_REPEAT as d,ADDRESS_CLAMP_TO_EDGE as i,ADDRESS_MIRRORED_REPEAT as n,FILTER_NEAREST as m,FILTER_LINEAR as c,FILTER_NEAREST_MIPMAP_NEAREST as p,FILTER_LINEAR_MIPMAP_NEAREST as u,FILTER_NEAREST_MIPMAP_LINEAR as f,FILTER_LINEAR_MIPMAP_LINEAR as l}from"../../platform/graphics/constants.js";import{TextureAtlas as _}from"../../scene/texture-atlas.js";const h={repeat:d,clamp:i,mirror:n},g={nearest:m,linear:c,nearest_mip_nearest:p,linear_mip_nearest:u,nearest_mip_linear:f,linear_mip_linear:l},v=/^data\.frames\.(\d+)$/;class y{constructor(e){this.handlerType="textureatlas",this._loader=e.loader,this.maxRetries=0}load(a,t){"string"==typeof a&&(a={load:a,original:a});const s=this,o=this._loader.getHandler("texture");if(".json"!==e.getExtension(a.original))return o.load(a,t);r.get(a.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(e,r){if(e)t(e);else{const e=a.original.replace(".json",".png");s._loader.load(e,"texture",(function(e,a){e?t(e):t(null,{data:r,texture:a})}))}}))}open(e,r){const a=new _;if(r.texture&&r.data)a.texture=r.texture,a.__data=r.data;else{const t=this._loader.getHandler("texture").open(e,r);if(!t)return null;a.texture=t}return a}patch(e,r){if(!e.resource)return;e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);const d=e.resource.texture;if(d&&(d.name=e.name,e.data.hasOwnProperty("minfilter")&&d.minFilter!==g[e.data.minfilter]&&(d.minFilter=g[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&d.magFilter!==g[e.data.magfilter]&&(d.magFilter=g[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&d.addressU!==h[e.data.addressu]&&(d.addressU=h[e.data.addressu]),e.data.hasOwnProperty("addressv")&&d.addressV!==h[e.data.addressv]&&(d.addressV=h[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&d.mipmaps!==e.data.mipmaps&&(d.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&d.anisotropy!==e.data.anisotropy&&(d.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){const r=e.data.rgbm?s:o;d.type!==r&&(d.type=r)}e.resource.texture=d;const i={};for(const r in e.data.frames){const s=e.data.frames[r];i[r]={rect:new t(s.rect),pivot:new a(s.pivot),border:new t(s.border)}}e.resource.frames=i,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_onAssetChange(e,r,s){let o;if("data"===r||"data.frames"===r){const r={};for(const e in s.frames)o=s.frames[e],r[e]={rect:new t(o.rect),pivot:new a(o.pivot),border:new t(o.border)};e.resource.frames=r}else{const d=r.match(v);if(d){const r=d[1];s?(e.resource.frames[r]?(o=e.resource.frames[r],o.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),o.pivot.set(s.pivot[0],s.pivot[1]),o.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):e.resource.frames[r]={rect:new t(s.rect),pivot:new a(s.pivot),border:new t(s.border)},e.resource.fire("set:frame",r,e.resource.frames[r])):e.resource.frames[r]&&(delete e.resource.frames[r],e.resource.fire("remove:frame",r))}}}}export{y as TextureAtlasHandler};

import{path as t}from"../../core/path.js";import{Tags as e}from"../../core/tags.js";import{EventHandler as s}from"../../core/event-handler.js";import{findAvailableLocale as i}from"../i18n/utils.js";import{ABSOLUTE_URL as r}from"./constants.js";import{AssetFile as o}from"./asset-file.js";import{getApplication as l}from"../globals.js";import{http as a}from"../../platform/net/http.js";let h=-1;const n={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},d=["pvr","dxt","etc2","etc1","basis"];class c extends s{constructor(t,s,i,r,o){super(),this._id=h--,this.name=t||"",this.type=s,this.tags=new e(this),this._preload=!1,this._file=null,this._data=r||{},this.options=o||{},this._resources=[],this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,i&&(this.file=i)}set id(t){this._id=t}get id(){return this._id}set file(t){if(t&&t.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var e,s;const i=(null==(e=this.registry)||null==(s=e._loader)?void 0:s._app)||l(),r=null==i?void 0:i.graphicsDevice;if(r)for(let e=0,s=d.length;e<s;e++){const s=d[e];if(t.variants[s]&&r[n[s]]){t=t.variants[s];break}if(i.enableBundles){const t=i.bundles.listBundlesForAsset(this);if(t&&t.find((t=>{var e;return null==t||null==(e=t.file)?void 0:e.variants[s]})))break}}}const i=this._file,r=t?new o(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!r!=!!i||r&&!r.equals(i))&&(this._file=r,this.fire("change",this,"file",r,i),this.reload())}get file(){return this._file}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resource(){return this._resources[0]}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get resources(){return this._resources}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;if(this.registry&&this.registry.prefix&&!r.test(e)&&(e=this.registry.prefix+e),"script"!==this.type&&t.hash){const s=-1!==e.indexOf("?")?"&":"?";e+=s+"t="+t.hash}return e}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;const s=t.getDirectory(this.file.url);return t.join(s,e)}getLocalizedAssetId(t){return t=i(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.loaded?t.call(e,this):this.once("load",(function(s){t.call(e,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const t=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e){const s=t[e];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(t,e,s,i=0){var r;null!=s&&null!=(r=s.file)&&r.contents?setTimeout((()=>{e(null,s.file.contents)})):a.get(t,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},e)}}export{c as Asset};

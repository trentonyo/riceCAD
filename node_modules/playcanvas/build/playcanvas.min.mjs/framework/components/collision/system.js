import"../../../core/tracing.js";import{Mat4 as e}from"../../../core/math/mat4.js";import{Quat as t}from"../../../core/math/quat.js";import{Vec3 as o}from"../../../core/math/vec3.js";import{SEMANTIC_POSITION as a}from"../../../platform/graphics/constants.js";import{GraphNode as s}from"../../../scene/graph-node.js";import{Model as i}from"../../../scene/model.js";import{Component as n}from"../component.js";import{ComponentSystem as r}from"../system.js";import{CollisionComponent as d}from"./component.js";import{CollisionComponentData as m}from"./data.js";import{Trigger as l}from"./trigger.js";const h=new e,c=new o,p=new t,y=new s,u=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"];class f{constructor(e){this.system=e}beforeInitialize(e,t){t.shape=null,t.model=new i,t.model.graph=new s}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)}recreatePhysicalShapes(e){const t=e.entity,o=e.data;if("undefined"!=typeof Ammo){t.trigger&&(t.trigger.destroy(),delete t.trigger),o.shape&&(e._compoundParent&&(this.system._removeCompoundChild(e._compoundParent,o.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),Ammo.destroy(o.shape),o.shape=null),o.shape=this.createPhysicalShape(e.entity,o);const a=!e._compoundParent;if("compound"!==o.type||e._compoundParent&&e!==e._compoundParent){if("compound"!==o.type&&(e._compoundParent&&e===e._compoundParent&&t.forEach(this.system.implementations.compound._updateEachDescendant,e),!e.rigidbody)){e._compoundParent=null;let o=t.parent;for(;o;){if(o.collision&&"compound"===o.collision.type){e._compoundParent=o.collision;break}o=o.parent}}}else e._compoundParent=e,t.forEach(this._addEachDescendant,e);e._compoundParent&&e!==e._compoundParent&&(a&&0===e._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(o):t.trigger=new l(this.system.app,e,o))}}createPhysicalShape(e,t){}updateTransform(e,t,o,a){e.entity.trigger&&e.entity.trigger.updateTransform()}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,Ammo.destroy(t.data.shape),t.data.shape=null)}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger)}clone(e,t){const o=this.system.store[e.getGuid()],a={enabled:o.data.enabled,type:o.data.type,halfExtents:[o.data.halfExtents.x,o.data.halfExtents.y,o.data.halfExtents.z],radius:o.data.radius,axis:o.data.axis,height:o.data.height,asset:o.data.asset,renderAsset:o.data.renderAsset,model:o.data.model,render:o.data.render};return this.system.addComponent(t,a)}}class g extends f{createPhysicalShape(e,t){if("undefined"!=typeof Ammo){const e=t.halfExtents,o=new Ammo.btVector3(e?e.x:.5,e?e.y:.5,e?e.z:.5),a=new Ammo.btBoxShape(o);return Ammo.destroy(o),a}}}class b extends f{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)}}class A extends f{createPhysicalShape(e,t){const o=void 0!==t.axis?t.axis:1,a=t.radius||.5,s=Math.max((t.height||2)-2*a,0);let i=null;if("undefined"!=typeof Ammo)switch(o){case 0:i=new Ammo.btCapsuleShapeX(a,s);break;case 1:i=new Ammo.btCapsuleShape(a,s);break;case 2:i=new Ammo.btCapsuleShapeZ(a,s)}return i}}class S extends f{createPhysicalShape(e,t){const o=void 0!==t.axis?t.axis:1,a=void 0!==t.radius?t.radius:.5,s=void 0!==t.height?t.height:1;let i=null,n=null;if("undefined"!=typeof Ammo)switch(o){case 0:i=new Ammo.btVector3(.5*s,a,a),n=new Ammo.btCylinderShapeX(i);break;case 1:i=new Ammo.btVector3(a,.5*s,a),n=new Ammo.btCylinderShape(i);break;case 2:i=new Ammo.btVector3(a,a,.5*s),n=new Ammo.btCylinderShapeZ(i)}return i&&Ammo.destroy(i),n}}class _ extends f{createPhysicalShape(e,t){const o=void 0!==t.axis?t.axis:1,a=void 0!==t.radius?t.radius:.5,s=void 0!==t.height?t.height:1;let i=null;if("undefined"!=typeof Ammo)switch(o){case 0:i=new Ammo.btConeShapeX(a,s);break;case 1:i=new Ammo.btConeShape(a,s);break;case 2:i=new Ammo.btConeShapeZ(a,s)}return i}}class P extends f{beforeInitialize(e,t){}createAmmoMesh(e,t,o){let s;if(this.system._triMeshCache[e.id])s=this.system._triMeshCache[e.id];else{const t=e.vertexBuffer,o=t.getFormat();let i,n;for(let e=0;e<o.elements.length;e++){const s=o.elements[e];if(s.name===a){n=new Float32Array(t.lock(),s.offset),i=s.stride/4;break}}const r=[];e.getIndices(r);const d=e.primitive[0].count/3,m=new Ammo.btVector3,l=new Ammo.btVector3,h=new Ammo.btVector3;let c,p,y;const u=e.primitive[0].base;s=new Ammo.btTriangleMesh,this.system._triMeshCache[e.id]=s;for(let e=0;e<d;e++)c=r[u+3*e]*i,p=r[u+3*e+1]*i,y=r[u+3*e+2]*i,m.setValue(n[c],n[c+1],n[c+2]),l.setValue(n[p],n[p+1],n[p+2]),h.setValue(n[y],n[y+1],n[y+2]),s.addTriangle(m,l,h,!0);Ammo.destroy(m),Ammo.destroy(l),Ammo.destroy(h)}const i=new Ammo.btBvhTriangleMeshShape(s,!0),n=this.system._getNodeScaling(t);i.setLocalScaling(n),Ammo.destroy(n);const r=this.system._getNodeTransform(t);o.addChildShape(r,i),Ammo.destroy(r)}createPhysicalShape(e,t){if("undefined"!=typeof Ammo&&(t.model||t.render)){const o=new Ammo.btCompoundShape;if(t.model){const e=t.model.meshInstances;for(let t=0;t<e.length;t++)this.createAmmoMesh(e[t].mesh,e[t].node,o)}else if(t.render){const e=t.render.meshes;for(let t=0;t<e.length;t++)this.createAmmoMesh(e[t],y,o)}const a=e.getWorldTransform().getScale(),s=new Ammo.btVector3(a.x,a.y,a.z);return o.setLocalScaling(s),Ammo.destroy(s),o}}recreatePhysicalShapes(e){const t=e.data;(t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled?this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model"):this.doRecreatePhysicalShape(e)}loadAsset(e,t,o){const a=e.data,s=this.system.app.assets,i=s.get(t);i?(i.ready((t=>{a[o]=t.resource,this.doRecreatePhysicalShape(e)})),s.load(i)):s.once("add:"+t,(t=>{t.ready((t=>{a[o]=t.resource,this.doRecreatePhysicalShape(e)})),s.load(t)}))}doRecreatePhysicalShape(e){const t=e.entity,o=e.data;o.model||o.render?(this.destroyShape(o),o.shape=this.createPhysicalShape(t,o),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(o):t.trigger=new l(this.system.app,e,o)):(this.beforeRemove(t,e),this.remove(t,o))}updateTransform(e,t,o,a){if(e.shape){const t=e.entity.getWorldTransform().getScale(),o=e.shape.getLocalScaling();t.x===o.x()&&t.y===o.y()&&t.z===o.z()||this.doRecreatePhysicalShape(e)}super.updateTransform(e,t,o,a)}destroyShape(e){if(!e.shape)return;const t=e.shape.getNumChildShapes();for(let o=0;o<t;o++){const t=e.shape.getChildShape(o);Ammo.destroy(t)}Ammo.destroy(e.shape),e.shape=null}remove(e,t){this.destroyShape(t),super.remove(e,t)}}class w extends f{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape}_addEachDescendant(e){e.collision&&!e.rigidbody&&(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendant(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e===this.entity||e.rigidbody||e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendantTransform(e){e.collision&&e.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(e)}}class x extends r{constructor(e){super(e),this.id="collision",this.ComponentType=d,this.DataType=m,this.schema=u,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,a){const s={};for(let e=0,o=(a=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"]).length;e<o;e++){const o=a[e];s[o]=t[o]}let i;t.hasOwnProperty("asset")?(i=a.indexOf("model"),-1!==i&&a.splice(i,1),i=a.indexOf("render"),-1!==i&&a.splice(i,1)):t.hasOwnProperty("model")&&(i=a.indexOf("asset"),-1!==i&&a.splice(i,1)),s.type||(s.type=e.data.type),e.data.type=s.type,s.halfExtents&&Array.isArray(s.halfExtents)&&(s.halfExtents=new o(s.halfExtents[0],s.halfExtents[1],s.halfExtents[2]));const n=this._createImplementation(s.type);n.beforeInitialize(e,s),super.initializeComponentData(e,s,a),n.afterInitialize(e,s)}_createImplementation(e){if(void 0===this.implementations[e]){let t;switch(e){case"box":t=new g(this);break;case"sphere":t=new b(this);break;case"capsule":t=new A(this);break;case"cylinder":t=new S(this);break;case"cone":t=new _(this);break;case"mesh":t=new P(this);break;case"compound":t=new w(this)}this.implementations[e]=t}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()}onRemove(e,t){this.implementations[t.type].remove(e,t)}updateCompoundChildTransform(e){if(this._removeCompoundChild(e.collision._compoundParent,e.collision.data.shape),e.enabled&&e.collision.enabled){const t=this._getNodeTransform(e,e.collision._compoundParent.entity);e.collision._compoundParent.shape.addChildShape(t,e.collision.data.shape),Ammo.destroy(t)}}_removeCompoundChild(e,t){if(e.shape.removeChildShape)e.shape.removeChildShape(t);else{const o=e._getCompoundChildShapeIndex(t);null!==o&&e.shape.removeChildShapeByIndex(o)}}onTransformChanged(e,t,o,a){this.implementations[e.data.type].updateTransform(e,t,o,a)}changeType(e,t,o){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(o).reset(e,e.data)}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e)}_calculateNodeRelativeTransform(e,t){if(e===t){const t=e.getWorldTransform().getScale();h.setScale(t.x,t.y,t.z)}else this._calculateNodeRelativeTransform(e.parent,t),h.mul(e.getLocalTransform())}_getNodeScaling(e){const t=e.getWorldTransform().getScale();return new Ammo.btVector3(t.x,t.y,t.z)}_getNodeTransform(e,t){let o,a;t?(this._calculateNodeRelativeTransform(e,t),o=c,a=p,h.getTranslation(o),a.setFromMat4(h)):(o=e.getPosition(),a=e.getRotation());const s=new Ammo.btTransform;s.setIdentity();const i=s.getOrigin();i.setValue(o.x,o.y,o.z);const n=new Ammo.btQuaternion;return n.setValue(a.x,a.y,a.z,a.w),s.setRotation(n),Ammo.destroy(n),Ammo.destroy(i),s}destroy(){for(const e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy()}}n._buildAccessors(d.prototype,u);export{x as CollisionComponentSystem};

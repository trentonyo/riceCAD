import"../../../core/tracing.js";import{SortedLoopArray as t}from"../../../core/sorted-loop-array.js";import{ScriptAttributes as e}from"../../script/script-attributes.js";import{SCRIPT_POST_INITIALIZE as s,SCRIPT_INITIALIZE as i,SCRIPT_UPDATE as n,SCRIPT_POST_UPDATE as r,SCRIPT_SWAP as o}from"../../script/constants.js";import{Component as p}from"../component.js";import{Entity as h}from"../../entity.js";class c extends p{constructor(e,s){super(e,s),this._scripts=[],this._updateList=new t({sortBy:"__executionOrder"}),this._postUpdateList=new t({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(t){this._scriptsData=t;for(const s in t){if(!t.hasOwnProperty(s))continue;const i=this._scriptsIndex[s];if(i){if("boolean"==typeof t[s].enabled&&(i.enabled=!!t[s].enabled),"object"==typeof t[s].attributes)for(const n in t[s].attributes)if(!e.reservedNames.has(n)){if(!i.__attributes.hasOwnProperty(n)){const t=this.system.app.scripts.get(s);t&&t.attributes.add(n,{})}i[n]=t[s].attributes[n]}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,s))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e.enabled=e._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const e=this.scripts[t];e&&this.destroy(e.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(t){for(let e=0;e<t;e++){const t=this._destroyedScripts[e];this._removeScriptInstance(t)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++)this.scripts[t].__initializeAttributes()}_scriptMethod(t,e,s){t[e](s)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let e=0,s=t.length;e<s;e++){const s=t[e];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,i))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,n,t)}this._endLooping(s)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,r,t)}this._endLooping(s)}_insertScriptInstance(t,e,s){-1===e?(this._scripts.push(t),t.__executionOrder=s,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,s+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return-1===e||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let s=t;s<e;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(t,e,s,i,n,r){if(t.array){const t=s.length;if(!t)return;const o=s.slice();for(let e=0;e<t;e++){const t=o[e]instanceof h?o[e].getGuid():o[e];r[t]&&(o[e]=i?r[t].getGuid():r[t])}n[e]=o}else{if(s instanceof h)s=s.getGuid();else if("string"!=typeof s)return;r[s]&&(n[e]=r[s])}}has(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;const e=t,s=e.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof e}get(t){if("string"==typeof t){const e=this._scriptsIndex[t];return e?e.instance:null}if(!t)return null;const e=t,s=e.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof e?n:null}create(t,e={}){const n=this;let r=t,o=t;if("string"==typeof r?r=this.system.app.scripts.get(r):r&&(o=r.__name),r){if(!this._scriptsIndex[o]||!this._scriptsIndex[o].instance){const t=new r({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes}),p=this._scripts.length;let h=-1;return"number"==typeof e.ind&&-1!==e.ind&&p>e.ind&&(h=e.ind),this._insertScriptInstance(t,h,p),this._scriptsIndex[o]={instance:t,onSwap:function(){n.swap(o)}},this[o]=t,e.preloading||t.__initializeAttributes(),this.fire("create",o,t),this.fire("create:"+o,t),this.system.app.scripts.on("swap:"+o,this._scriptsIndex[o].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,i)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,s))),t}}else this._scriptsIndex[o]={awaiting:!0,ind:this._scripts.length};return null}destroy(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const t=this._removeScriptInstance(n);t>=0&&this._resetExecutionOrder(t,this._scripts.length)}return this.system.app.scripts.off("swap:"+e,i.onSwap),delete this[e],this.fire("destroy",e,n||null),this.fire("destroy:"+e,n||null),n&&n.fire("destroy"),!0}swap(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(!i||!i.instance)return!1;const n=i.instance,r=this._scripts.indexOf(n),p=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!p.swap&&(p.__initializeAttributes(),this._scripts[r]=p,this._scriptsIndex[e].instance=p,this[e]=p,p.__executionOrder=r,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),p.update&&this._updateList.insert(p),p.postUpdate&&this._postUpdateList.insert(p),this._scriptMethod(p,o,n),this.fire("swap",e,p),this.fire("swap:"+e,p),!0)}resolveDuplicatedEntityReferenceProperties(t,e){const s=this.entity.script;for(const i in t._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const r=t._scriptsIndex[i];if(!r||!r.instance)continue;const o=s[i].__attributesRaw,p=s[i].__attributes;if(!o&&!p)continue;const h=!!o,c=r.instance.__attributes;for(const t in c){if(!c[t])continue;const s=n.attributes.get(t);if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,t,c[t],h,o||p,e);else if("json"===s.type&&Array.isArray(s.schema)){const i=c[t],n=o?o[t]:p[t];for(let t=0;t<s.schema.length;t++){const r=s.schema[t];if("entity"===r.type)if(s.array)for(let t=0;t<i.length;t++)this._resolveEntityScriptAttribute(r,r.name,i[t][r.name],h,n[t],e);else this._resolveEntityScriptAttribute(r,r.name,i[r.name],h,n,e)}}}}}move(t,e){const s=this._scripts.length;if(e>=s||e<0)return!1;let i=t,n=t;"string"!=typeof n?n=t.__name:i=null;const r=this._scriptsIndex[n];if(!r||!r.instance)return!1;const o=r.instance;if(i&&!(o instanceof i))return!1;const p=this._scripts.indexOf(o);return-1!==p&&p!==e&&(this._scripts.splice(e,0,this._scripts.splice(p,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,o,e,p),this.fire("move:"+n,o,e,p),!0)}}export{c as ScriptComponent};

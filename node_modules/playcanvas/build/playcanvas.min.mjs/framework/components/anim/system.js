import{Component as a}from"../component.js";import{ComponentSystem as t}from"../system.js";import{AnimComponent as s}from"./component.js";import{AnimComponentData as e}from"./data.js";const n=["enabled"];class o extends t{constructor(a){super(a),this.id="anim",this.ComponentType=s,this.DataType=e,this.schema=n,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(a,t,s){super.initializeComponentData(a,t,n);const e=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach((s=>{e.includes(s)||(a[s]=t[s])})),t.stateGraph&&(a.stateGraph=t.stateGraph,a.loadStateGraph(a.stateGraph)),t.layers?t.layers.forEach(((t,s)=>{t._controller.states.forEach((e=>{t._controller._states[e]._animationList.forEach((t=>{a.layers[s].assignAnimation(t.name,t.animTrack)}))}))})):t.animationAssets&&(a.animationAssets=Object.assign(a.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach((s=>{if(a.layers[s]){const e=t.masks[s].mask,n={};Object.keys(e).forEach((a=>{n[decodeURI(a)]=e[a]})),a.layers[s].mask=n}}))}onAnimationUpdate(a){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const e=t[s].entity.anim;e.data.enabled&&e.entity.enabled&&e.playing&&e.update(a)}}cloneComponent(a,t){let s;a.anim.rootBone&&a.anim.rootBone!==a||(s={},a.anim.layers.forEach(((a,e)=>{if(a.mask){const n={};Object.keys(a.mask).forEach((s=>{const e=s.split("/");e.shift();const o=[t.name,...e].join("/");n[o]=a.mask[s]})),s[e]={mask:n}}})));const e={stateGraphAsset:a.anim.stateGraphAsset,animationAssets:a.anim.animationAssets,speed:a.anim.speed,activate:a.anim.activate,playing:a.anim.playing,rootBone:a.anim.rootBone,stateGraph:a.anim.stateGraph,layers:a.anim.layers,layerIndices:a.anim.layerIndices,parameters:a.anim.parameters,normalizeWeights:a.anim.normalizeWeights,masks:s};return this.addComponent(t,e)}onBeforeRemove(a,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}a._buildAccessors(s.prototype,n);export{o as AnimComponentSystem};

import{now as e}from"../../../core/time.js";import{math as t}from"../../../core/math/math.js";import{Color as i}from"../../../core/math/color.js";import{EntityReference as s}from"../../utils/entity-reference.js";import{Component as n}from"../component.js";import{BUTTON_TRANSITION_MODE_SPRITE_CHANGE as a,BUTTON_TRANSITION_MODE_TINT as o}from"./constants.js";import{ELEMENTTYPE_GROUP as h}from"../element/constants.js";const r="DEFAULT",l="HOVER",_="PRESSED",p="INACTIVE",c={};c[r]="_defaultTint",c[l]="hoverTint",c[_]="pressedTint",c[p]="inactiveTint";const m={};m[r]="_defaultSpriteAsset",m[l]="hoverSpriteAsset",m[_]="pressedSpriteAsset",m[p]="inactiveSpriteAsset";const u={};u[r]="_defaultSpriteFrame",u[l]="hoverSpriteFrame",u[_]="pressedSpriteFrame",u[p]="inactiveSpriteFrame";class f extends n{constructor(e,t){super(e,t),this._visualState=r,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new i(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new s(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",e)}_toggleLifecycleListeners(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(e,t,i){t!==i&&this._updateVisualState()}_onSetTransitionMode(e,t,i){t!==i&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())}_onSetTransitionValue(e,t,i){t!==i&&this._forceReapplyVisualState()}_onElementComponentRemove(e){this.entity===e&&this._toggleHitElementListeners("off")}_onElementComponentAdd(e){this.entity===e&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(e){if(this.entity.element){const t="on"===e;if(t&&this._hasHitElementListeners)return;this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const e=this._imageReference.entity.element;e.type!==h&&(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame))}}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b}_storeDefaultOpacity(e){this._defaultTint.a=e}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())}_onMouseEnter(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)}_onMouseLeave(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)}_onMouseDown(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)}_onMouseUp(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)}_onTouchStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)}_onTouchLeave(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)}_onTouchCancel(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)}_onSelectStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)}_onSelectEnd(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)}_onSelectEnter(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)}_onSelectLeave(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)}_onClick(e){this._fireIfActive("click",e)}_fireIfActive(e,t){this.data.active&&this.fire(e,t)}_updateVisualState(e){const t=this._visualState,i=this._determineVisualState();if((t!==i||e)&&this.enabled)switch(this._visualState=i,t===l&&this._fireIfActive("hoverend"),t===_&&this._fireIfActive("pressedend"),i===l&&this._fireIfActive("hoverstart"),i===_&&this._fireIfActive("pressedstart"),this.transitionMode){case o:{const e=this[c[this._visualState]];this._applyTint(e);break}case a:{const e=m[this._visualState],t=u[this._visualState],i=this[e],s=this[t];this._applySprite(i,s);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(e){if(this._imageReference.hasComponent("element"))switch(e){case o:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case a:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}}_determineVisualState(){return this.active?this._isPressed?_:this._isHovering?l:r:p}_applySprite(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==e&&(this._imageReference.entity.element.spriteAsset=e),this._imageReference.entity.element.spriteFrame!==t&&(this._imageReference.entity.element.spriteFrame=t),this._isApplyingSprite=!1)}_applyTint(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e)}_applyTintImmediately(e){if(!e||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===h)return;const t=S(e);this._isApplyingTint=!0,t.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=t),this._imageReference.entity.element.opacity!==e.a&&(this._imageReference.entity.element.opacity=e.a),this._isApplyingTint=!1}_applyTintWithTween(t){if(!t||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===h)return;const s=S(t),n=this._imageReference.entity.element.color,a=this._imageReference.entity.element.opacity;s.equals(n)&&t.a===a||(this._tweenInfo={startTime:e(),from:new i(n.r,n.g,n.b,a),to:t.clone(),lerpColor:new i})}_updateTintTween(){const s=e()-this._tweenInfo.startTime;let n=0===this.fadeDuration?1:s/this.fadeDuration;if(n=t.clamp(n,0,1),Math.abs(n-1)>1e-5){const e=this._tweenInfo.lerpColor;e.lerp(this._tweenInfo.from,this._tweenInfo.to,n),this._applyTintImmediately(new i(e.r,e.g,e.b,e.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}function S(e){return new i(e.r,e.g,e.b)}export{f as ButtonComponent};

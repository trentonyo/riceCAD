import"../core/tracing.js";import{guid as t}from"../core/guid.js";import{GraphNode as i}from"../scene/graph-node.js";import{getApplication as e}from"./globals.js";const n=[];class s extends i{constructor(t,i=e()){super(t),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,this._app=i}addComponent(t,i){const e=this._app.systems[t];return e?this.c[t]?null:e.addComponent(this,i):null}removeComponent(t){const i=this._app.systems[t];i&&this.c[t]&&i.removeComponent(this)}findComponent(t){const i=this.findOne((function(i){return i.c&&i.c[t]}));return i&&i.c[t]}findComponents(t){return this.find((function(i){return i.c&&i.c[t]})).map((function(i){return i.c[t]}))}getGuid(){return this._guid||this.setGuid(t.create()),this._guid}setGuid(t){const i=this._app._entityIndex;this._guid&&delete i[this._guid],this._guid=t,i[this._guid]=this}_notifyHierarchyStateChanged(t,i){let e=!1;t===this&&0===n.length&&(e=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(i),t._onHierarchyStatePostChanged&&n.push(t);const s=t._children;for(let t=0,e=s.length;t<e;t++)s[t]._enabled&&this._notifyHierarchyStateChanged(s[t],i);if(t._beingEnabled=!1,e){for(let t=0;t<n.length;t++)n[t]._onHierarchyStatePostChanged();n.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const i=this.c;for(const e in i)if(i.hasOwnProperty(e)){const n=i[e];n.enabled&&(t?n.onEnable():n.onDisable())}}_onHierarchyStatePostChanged(){const t=this.c;for(const i in t)t.hasOwnProperty(i)&&t[i].onPostStateChange()}findByGuid(t){if(this._guid===t)return this;const i=this._app._entityIndex[t];return i&&(i===this||i.isDescendantOf(this))?i:null}destroy(){this._destroying=!0;for(const t in this.c)this.c[t].enabled=!1;for(const t in this.c)this.c[t].system.removeComponent(this);this._parent&&this._parent.removeChild(this);const t=this._children;for(;t.length;){const i=t.pop();i._parent=null,i instanceof s&&i.destroy()}this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},i=this._cloneRecursively(t);return t[this.getGuid()]=i,o(this,this,i,t),i}_cloneRecursively(t){const i=new this.constructor(void 0,this._app);super._cloneInternal(i);for(const t in this.c){this.c[t].system.cloneComponent(this,i)}for(let e=0;e<this._children.length;e++){const n=this._children[e];if(n instanceof s){const e=n._cloneRecursively(t);i.addChild(e),t[n.getGuid()]=e}}return i}}function o(t,i,e,n){if(i instanceof s){const r=i.c;for(const i in r){const s=r[i],o=s.system.getPropertiesOfType("entity");for(let r=0,h=o.length;r<h;r++){const h=o[r].name,c=s[h];if(!!t.findByGuid(c)){const t=n[c].getGuid();t&&(e.c[i][h]=t)}}}r.script&&!e._app.useLegacyScriptAttributeCloning&&e.script.resolveDuplicatedEntityReferenceProperties(r.script,n),r.render&&e.render.resolveDuplicatedEntityReferenceProperties(r.render,n),r.anim&&e.anim.resolveDuplicatedEntityReferenceProperties(r.anim,n);const h=i.children.filter((function(t){return t instanceof s})),c=e.children.filter((function(t){return t instanceof s}));for(let i=0,e=h.length;i<e;i++)o(t,h[i],c[i],n)}}export{s as Entity};

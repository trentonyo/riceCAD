import"../../core/tracing.js";import{EventHandler as t}from"../../core/event-handler.js";import{math as e}from"../../core/math/math.js";import{Channel as s}from"../audio/channel.js";import{Channel3d as n}from"../audio/channel3d.js";import{Listener as o}from"./listener.js";const i=["click","touchstart"];class r extends t{constructor(){super(),this._context=null,this.AudioContext="undefined"!=typeof AudioContext&&AudioContext||"undefined"!=typeof webkitAudioContext&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=!1,this.listener=new o(this),this._volume=1}set volume(t){t=e.clamp(t,0,1),this._volume=t,this.fire("volumechange",t)}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return!this._context&&this.AudioContext&&(this._context=new this.AudioContext,"running"!==this._context.state&&this._registerUnlockListeners()),this._context}suspend(){this._userSuspended||(this._userSuspended=!0,this._context&&"running"===this._context.state&&this._suspend())}resume(){this._userSuspended&&(this._userSuspended=!1,this._context&&"running"!==this._context.state&&this._resume())}destroy(){var t;(this.fire("destroy"),this._context)&&(this._removeUnlockListeners(),null==(t=this._context)||t.close(),this._context=null)}playSound(t,e={}){let n=null;return s&&(n=new s(this,t,e),n.play()),n}playSound3d(t,e,s={}){let o=null;return n&&(o=new n(this,t,s),o.setPosition(e),s.volume&&o.setVolume(s.volume),s.loop&&o.setLoop(s.loop),s.maxDistance&&o.setMaxDistance(s.maxDistance),s.minDistance&&o.setMinDistance(s.minDistance),s.rollOffFactor&&o.setRollOffFactor(s.rollOffFactor),s.distanceModel&&o.setDistanceModel(s.distanceModel),o.play()),o}_resume(){this._context.resume().then((()=>{const t=this._context.createBufferSource();t.buffer=this._context.createBuffer(1,1,this._context.sampleRate),t.connect(this._context.destination),t.start(0),t.onended=e=>{t.disconnect(0),this.fire("resume")}}),(t=>{})).catch((t=>{}))}_suspend(){this._context.suspend().then((()=>{this.fire("suspend")}),(t=>{})).catch((t=>{}))}_unlockHandler(){this._removeUnlockListeners(),this._userSuspended||"running"===this._context.state||this._resume()}_registerUnlockListeners(){i.forEach((t=>{window.addEventListener(t,this._unlockHandlerFunc,!1)}))}_removeUnlockListeners(){i.forEach((t=>{window.removeEventListener(t,this._unlockHandlerFunc,!1)}))}}export{r as SoundManager};

import"../../core/tracing.js";import{DEVICETYPE_WEBGPU as e,DEVICETYPE_WEBGL as t,SEMANTIC_POSITION as r,SEMANTIC_NORMAL as n,SEMANTIC_TANGENT as o,SEMANTIC_TEXCOORD0 as s,SEMANTIC_TEXCOORD1 as i,SEMANTIC_TEXCOORD2 as a,SEMANTIC_TEXCOORD3 as d,SEMANTIC_TEXCOORD4 as x,SEMANTIC_TEXCOORD5 as m,SEMANTIC_TEXCOORD6 as c,SEMANTIC_TEXCOORD7 as v,SEMANTIC_COLOR as l,SEMANTIC_BLENDINDICES as u,SEMANTIC_BLENDWEIGHT as g}from"./constants.js";import f from"./shader-chunks/frag/gles2.js";import p from"./shader-chunks/frag/gles3.js";import h from"./shader-chunks/vert/gles3.js";import _ from"./shader-chunks/frag/webgpu.js";import C from"./shader-chunks/vert/webgpu.js";const b={vertex_position:r,vertex_normal:n,vertex_tangent:o,vertex_texCoord0:s,vertex_texCoord1:i,vertex_texCoord2:a,vertex_texCoord3:d,vertex_texCoord4:x,vertex_texCoord5:m,vertex_texCoord6:c,vertex_texCoord7:v,vertex_color:l,vertex_boneIndices:u,vertex_boneWeights:g};class E{static createDefinition(t,r){var n,o;const s=(n,o,s,i)=>t.deviceType===e?n:t.webgl2?o:E.gl1Extensions(t,r)+s,i=null!=(n=r.name)?n:"Untitled",a=r.vertexDefines||s(C,h,""),d=E.versionCode(t)+a+E.getShaderNameCode(i)+r.vertexCode,x=r.fragmentDefines||s(_,p,f),m=(r.fragmentPreamble||"")+E.versionCode(t)+E.precisionCode(t)+"\n"+x+E.getShaderNameCode(i)+(r.fragmentCode||E.dummyFragmentCode());return{name:i,attributes:null!=(o=r.attributes)?o:E.collectAttributes(r.vertexCode),vshader:d,fshader:m,useTransformFeedback:r.useTransformFeedback}}static getShaderNameCode(e){return`#define SHADER_NAME ${e}\n`}static gl1Extensions(e,t,r){let n;return r?n=t.vertexExtensions?`${t.vertexExtensions}\n`:"":(n=t.fragmentExtensions?`${t.fragmentExtensions}\n`:"",e.extStandardDerivatives&&(n+="#extension GL_OES_standard_derivatives : enable\n"),e.extTextureLod&&(n+="#extension GL_EXT_shader_texture_lod : enable\n",n+="#define SUPPORTS_TEXLOD\n")),n}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(t){return t.deviceType===e?"#version 450\n":t.webgl2?"#version 300 es\n":""}static precisionCode(e,r){let n="";if(e.deviceType===t){r&&"highp"!==r&&"mediump"!==r&&"lowp"!==r&&(r=null),r&&("highp"===r&&"highp"!==e.maxPrecision&&(r="mediump"),"mediump"===r&&"lowp"===e.maxPrecision&&(r="lowp"));const t=r||e.precision;n=`precision ${t} float;\n`,e.webgl2&&(n+=`precision ${t} sampler2DShadow;\n`)}return n}static collectAttributes(e){const t={};let r=0,n=e.indexOf("attribute");for(;n>=0&&!(n>0&&"/"===e[n-1]);){const o=e.indexOf(";",n),s=e.lastIndexOf(" ",o),i=e.substring(s+1,o),a=b[i];void 0!==a?t[i]=a:(t[i]="ATTR"+r,r++),n=e.indexOf("attribute",n+1)}return t}}export{E as ShaderUtils};

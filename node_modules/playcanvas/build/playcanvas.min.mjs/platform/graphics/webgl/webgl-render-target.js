import"../../../core/tracing.js";class e{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}destroy(e){const f=e.gl;this._glFrameBuffer&&(f.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(f.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(f.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(f.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(f.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}get initialized(){return null!==this._glFrameBuffer}init(e,f){const r=e.gl;this._glFrameBuffer=r.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const t=f._colorBuffer;t&&(t.impl._glTexture||(t._width=Math.min(t.width,e.maxRenderBufferSize),t._height=Math.min(t.height,e.maxRenderBufferSize),e.setTexture(t,0)),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t._cubemap?r.TEXTURE_CUBE_MAP_POSITIVE_X+f._face:r.TEXTURE_2D,t.impl._glTexture,0));const l=f._depthBuffer;if(l)l.impl._glTexture||(l._width=Math.min(l.width,e.maxRenderBufferSize),l._height=Math.min(l.height,e.maxRenderBufferSize),e.setTexture(l,0)),f._stencil?r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,l._cubemap?r.TEXTURE_CUBE_MAP_POSITIVE_X+f._face:r.TEXTURE_2D,f._depthBuffer.impl._glTexture,0):r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,l._cubemap?r.TEXTURE_CUBE_MAP_POSITIVE_X+f._face:r.TEXTURE_2D,f._depthBuffer.impl._glTexture,0);else if(f._depth){if(!(f._samples>1&&e.webgl2)){if(this._glDepthBuffer||(this._glDepthBuffer=r.createRenderbuffer()),r.bindRenderbuffer(r.RENDERBUFFER,this._glDepthBuffer),f._stencil)r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,f.width,f.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,this._glDepthBuffer);else{const t=e.webgl2?r.DEPTH_COMPONENT32F:r.DEPTH_COMPONENT16;r.renderbufferStorage(r.RENDERBUFFER,t,f.width,f.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this._glDepthBuffer)}r.bindRenderbuffer(r.RENDERBUFFER,null)}}e.webgl2&&f._samples>1&&(this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=r.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer),t&&(this._glMsaaColorBuffer||(this._glMsaaColorBuffer=r.createRenderbuffer()),r.bindRenderbuffer(r.RENDERBUFFER,this._glMsaaColorBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,f._samples,t.impl._glInternalFormat,f.width,f.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this._glMsaaColorBuffer)),f._depth&&(this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=r.createRenderbuffer()),r.bindRenderbuffer(r.RENDERBUFFER,this._glMsaaDepthBuffer),f._stencil?(r.renderbufferStorageMultisample(r.RENDERBUFFER,f._samples,r.DEPTH24_STENCIL8,f.width,f.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,this._glMsaaDepthBuffer)):(r.renderbufferStorageMultisample(r.RENDERBUFFER,f._samples,r.DEPTH_COMPONENT32F,f.width,f.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this._glMsaaDepthBuffer))))}_checkFbo(e,f,r=""){const t=e.gl;switch(t.checkFramebufferStatus(t.FRAMEBUFFER)){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:case t.FRAMEBUFFER_UNSUPPORTED:}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}resolve(e,f,r,t){if(e.webgl2){const l=e.gl;l.bindFramebuffer(l.READ_FRAMEBUFFER,this._glFrameBuffer),l.bindFramebuffer(l.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),l.blitFramebuffer(0,0,f.width,f.height,0,0,f.width,f.height,(r?l.COLOR_BUFFER_BIT:0)|(t?l.DEPTH_BUFFER_BIT:0),l.NEAREST),l.bindFramebuffer(l.FRAMEBUFFER,this._glFrameBuffer)}}}export{e as WebglRenderTarget};

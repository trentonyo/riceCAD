import"../../core/tracing.js";import{math as t}from"../../core/math/math.js";import{PIXELFORMAT_R8_G8_B8_A8 as e,TEXTURETYPE_DEFAULT as i,TEXTUREPROJECTION_NONE as s,FILTER_LINEAR_MIPMAP_LINEAR as h,FILTER_LINEAR as l,ADDRESS_REPEAT as r,FUNC_LESS as a,TEXTURETYPE_RGBM as _,TEXTURETYPE_SWIZZLEGGGR as p,TEXTUREPROJECTION_CUBE as o,PIXELFORMAT_DXT1 as d,PIXELFORMAT_DXT3 as m,PIXELFORMAT_DXT5 as n,PIXELFORMAT_ETC1 as c,PIXELFORMAT_RGB16F as u,PIXELFORMAT_RGB32F as v,PIXELFORMAT_RGBA16F as g,PIXELFORMAT_RGBA32F as f,TEXTURETYPE_RGBP as w,TEXTURETYPE_RGBE as y,PIXELFORMAT_A8 as b,PIXELFORMAT_L8 as F,PIXELFORMAT_L8_A8 as U,PIXELFORMAT_R5_G6_B5 as A,PIXELFORMAT_R5_G5_B5_A1 as M,PIXELFORMAT_R4_G4_B4_A4 as k,PIXELFORMAT_R8_G8_B8 as x,PIXELFORMAT_R32F as O,PIXELFORMAT_DEPTH as S,PIXELFORMAT_DEPTHSTENCIL as R,PIXELFORMAT_111110F as V,PIXELFORMAT_SRGB as j,PIXELFORMAT_SRGBA as z,PIXELFORMAT_ETC2_RGB as W,PIXELFORMAT_PVRTC_2BPP_RGB_1 as Y,PIXELFORMAT_PVRTC_2BPP_RGBA_1 as G,PIXELFORMAT_PVRTC_4BPP_RGB_1 as C,PIXELFORMAT_PVRTC_4BPP_RGBA_1 as T,PIXELFORMAT_ATC_RGB as P,PIXELFORMAT_ETC2_RGBA as L,PIXELFORMAT_ASTC_4x4 as B,PIXELFORMAT_ATC_RGBA as I,TEXTURELOCK_WRITE as D}from"./constants.js";let q=null,E=null,H=0;class J{constructor(t,u){this.id=H++,this.device=t,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=e,this.type=i,this.projection=s,this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!1,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=h,this._magFilter=l,this._anisotropy=1,this._addressU=r,this._addressV=r,this._addressW=r,this._compareOnRead=!1,this._compareFunc=a,void 0!==u&&(void 0!==u.name&&(this.name=u.name),this._width=void 0!==u.width?u.width:this._width,this._height=void 0!==u.height?u.height:this._height,this._format=void 0!==u.format?u.format:this._format,u.hasOwnProperty("type")?this.type=u.type:u.hasOwnProperty("rgbm")?this.type=u.rgbm?_:i:u.hasOwnProperty("swizzleGGGR")&&(this.type=u.swizzleGGGR?p:i),void 0!==u.mipmaps?this._mipmaps=u.mipmaps:this._mipmaps=void 0!==u.autoMipmap?u.autoMipmap:this._mipmaps,this._levels=u.levels,this._cubemap=void 0!==u.cubemap?u.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==u.fixCubemapSeams?u.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection=o:u.projection&&u.projection!==o&&(this.projection=u.projection),this._minFilter=void 0!==u.minFilter?u.minFilter:this._minFilter,this._magFilter=void 0!==u.magFilter?u.magFilter:this._magFilter,this._anisotropy=void 0!==u.anisotropy?u.anisotropy:this._anisotropy,this._addressU=void 0!==u.addressU?u.addressU:this._addressU,this._addressV=void 0!==u.addressV?u.addressV:this._addressV,this._compareOnRead=void 0!==u.compareOnRead?u.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==u._compareFunc?u._compareFunc:this._compareFunc,this._flipY=void 0!==u.flipY?u.flipY:this._flipY,this._premultiplyAlpha=void 0!==u.premultiplyAlpha?u.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=void 0!==u.depth?u.depth:this._depth,this._volume=void 0!==u.volume?u.volume:this._volume,this._addressW=void 0!==u.addressW?u.addressW:this._addressW)),this._compressed=this._format===d||this._format===m||this._format===n||this._format>=c,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0,this.impl=t.createTextureImpl(this),t.textures.push(this)}destroy(){if(this.device){const t=this.device,e=t.textures.indexOf(this);-1!==e&&t.textures.splice(e,1),t.scope.removeValue(this),this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this._gpuSize),this._levels=null,this.device=null}}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(t,e){t.tex+=e}set minFilter(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}get minFilter(){return this._minFilter}set magFilter(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}get magFilter(){return this._magFilter}set addressU(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}get addressU(){return this._addressU}set addressV(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}get addressV(){return this._addressV}set addressW(t){this.device.webgl2&&this._volume&&t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16)}get addressW(){return this._addressW}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}get compareOnRead(){return this._compareOnRead}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}get compareFunc(){return this._compareFunc}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}get anisotropy(){return this._anisotropy}set autoMipmap(t){this._mipmaps=t}get autoMipmap(){return this._mipmaps}set mipmaps(t){this._mipmaps!==t&&(this._mipmaps=t,t&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return J.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get volume(){return this._volume}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return t.powerOfTwo(this._width)&&t.powerOfTwo(this._height)}get encoding(){switch(this.type){case _:return"rgbm";case y:return"rgbe";case w:return"rgbp";default:return this.format===u||this.format===v||this.format===g||this.format===f?"linear":"srgb"}}static calcGpuSize(t,i,s,h,l,r){q||(q=[],q[b]=1,q[F]=1,q[U]=2,q[A]=2,q[M]=2,q[k]=2,q[x]=4,q[e]=4,q[u]=8,q[g]=8,q[v]=16,q[f]=16,q[O]=4,q[S]=4,q[R]=4,q[V]=4,q[j]=4,q[z]=4),E||(E=[],E[c]=8,E[W]=8,E[Y]=8,E[G]=8,E[C]=8,E[T]=8,E[d]=8,E[P]=8,E[L]=16,E[m]=16,E[n]=16,E[B]=16,E[I]=16);const a=q.hasOwnProperty(h)?q[h]:0,_=E.hasOwnProperty(h)?E[h]:0;let p=0;for(;;){if(a>0)p+=t*i*s*a;else{let e=Math.floor((t+3)/4);const l=Math.floor((i+3)/4),r=Math.floor((s+3)/4);h!==Y&&h!==G||(e=Math.max(Math.floor(e/2),1)),p+=e*l*r*_}if(!l||1===t&&1===i&&1===s)break;t=Math.max(Math.floor(t/2),1),i=Math.max(Math.floor(i/2),1),s=Math.max(Math.floor(s/2),1)}return p*(r?6:1)}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255}lock(t={}){if(void 0===t.level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=D),this._lockedLevel=t.level,null===this._levels[t.level])switch(this._format){case b:case F:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case U:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case A:case M:case k:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case x:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case e:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case d:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case m:case n:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case u:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case v:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case g:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case f:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[t.level]}setSource(t,e=0){let i,s,h=!1;if(this._cubemap){if(t[0]){i=t[0].width||0,s=t[0].height||0;for(let e=0;e<6;e++){const l=t[e];if(!l||l.width!==i||l.height!==s||!this.device._isBrowserInterface(l)){h=!0;break}}}else h=!0;if(!h)for(let i=0;i<6;i++)this._levels[e][i]!==t[i]&&(this._levelsUpdated[e][i]=!0)}else this.device._isBrowserInterface(t)||(h=!0),h||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),i=t.width,s=t.height);if(h)if(this._width=4,this._height=4,this._cubemap)for(let t=0;t<6;t++)this._levels[e][t]=null,this._levelsUpdated[e][t]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=i,this._height=s),this._levels[e]=t;this._invalid===h&&h||(this._invalid=h,this.upload())}getSource(t=0){return this._levels[t]}unlock(){this._lockedLevel,this.upload(),this._lockedLevel=-1}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps}getDds(){let t=128,e=0;for(;this._levels[e];){if(this.cubemap)for(let i=0;i<6;i++){if(!this._levels[e][i])return;const s=this._levels[e][i].length;if(!s)return;t+=s}else{const i=this._levels[e].length;if(!i)return;t+=i}t+=this._levels[e].length,e++}const i=new ArrayBuffer(t),s=new Uint32Array(i,0,32);let h=528391;this._levels.length>1&&(h|=131072);let l=4096;this._levels.length>1&&(l|=4194304),(this._levels.length>1||this.cubemap)&&(l|=8);const r=this.cubemap?65024:0;s[0]=542327876,s[1]=124,s[2]=h,s[3]=this.height,s[4]=this.width,s[5]=this.width*this.height*4,s[6]=0,s[7]=this._levels.length;for(let t=0;t<11;t++)s[8+t]=0;s[19]=32,s[20]=65,s[21]=0,s[22]=32,s[23]=16711680,s[24]=65280,s[25]=255,s[26]=4278190080,s[27]=l,s[28]=r,s[29]=0,s[30]=0,s[31]=0;let a=128;if(this.cubemap)for(let t=0;t<6;t++)for(let e=0;e<this._levels.length;e++){const s=this._levels[e][t],h=new Uint8Array(i,a,s.length);for(let t=0;t<s.length;t++)h[t]=s[t];a+=s.length}else for(let t=0;t<this._levels.length;t++){const e=this._levels[t],s=new Uint8Array(i,a,e.length);for(let t=0;t<e.length;t++)s[t]=e[t];a+=e.length}return i}}export{J as Texture};

<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>riceCAD</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <link rel="stylesheet" href="main.css">
        <script src="../playcanvas-latest.js"></script>
        <script src="../FileSaver.js"></script>
    </head>
    <body>
        <script src="materials.js"></script>
        <table>
            <tr>
                <td id="editor_title" colspan="3">
                    <h1>riceCAD <span id="versionNumber">v0.0.0</span></h1>
                </td>
            </tr>
            <tr>
                <td class="panel" id="editor_lpanel">
                    <h2>Viewport Settings</h2>
                    <form id="viewportSettings">
                        Lock viewport <input id="viewportLock" type="checkbox"><br>
                        <br>Rotate speed <input id="viewportRotateSpeed" type="range"   min="0.01" max="0.25" value="0.1" step="0.05">
                        <br>Move speed <input   id="viewportMoveSpeed" type="range"     min="0.01" max="0.5" value="0.05" step="0.01">
                        <br>Zoom speed <input   id="viewportZoomSpeed" type="range"     min="1" max="30" value="5" step="0.5">
                        <br>Backdrop <input     id="viewportBackdrop"   list="colors">
                        <br>Plane <input        id="workingPlaneColor"   list="colors">
                        <datalist id="colors">
                            <option value="Black">
                            <option value="Red">
                            <option value="Green">
                            <option value="Brown">
                            <option value="Blue">
                            <option value="Purple">
                            <option value="Cyan">
                            <option value="Light Gray">
                            <option value="Gray">
                            <option value="Pink">
                            <option value="Lime">
                            <option value="Yellow">
                            <option value="Light Blue">
                            <option value="Magenta">
                            <option value="Orange">
                            <option value="White">

                        </datalist>
                    </form><br>
                    <h2>Color Settings</h2>
                    <form id="colorSettings">
                        Override palette <input id="colorOverride" type="checkbox"><br>
                        <table id="overrideMap" style="visibility:hidden">
                            <tr>
                                <td>Black</td>
                                <td>
                                    <select id="color1"><option>-</option></select>
                                    <input id="blend1" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Red</td>
                                <td>
                                    <select id="color2"><option>-</option></select>
                                    <input id="blend2" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Green</td>
                                <td>
                                    <select id="color3"><option>-</option></select>
                                    <input id="blend3" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Brown</td>
                                <td>
                                    <select id="color4"><option>-</option></select>
                                    <input id="blend4" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Blue</td>
                                <td>
                                    <select id="color5"><option>-</option></select>
                                    <input id="blend5" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Purple</td>
                                <td>
                                    <select id="color6"><option>-</option></select>
                                    <input id="blend6" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Cyan</td>
                                <td>
                                    <select id="color7"><option>-</option></select>
                                    <input id="blend7" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Light Gray</td>
                                <td>
                                    <select id="color8"><option>-</option></select>
                                    <input id="blend8" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Gray</td>
                                <td>
                                    <select id="color9"><option>-</option></select>
                                    <input id="blend9" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Pink</td>
                                <td>
                                    <select id="color10"><option>-</option></select>
                                    <input id="blend10" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Lime</td>
                                <td>
                                    <select id="color11"><option>-</option></select>
                                    <input id="blend11" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Yellow</td>
                                <td>
                                    <select id="color12"><option>-</option></select>
                                    <input id="blend12" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Light Blue</td>
                                <td>
                                    <select id="color13"><option>-</option></select>
                                    <input id="blend13" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Magenta</td>
                                <td>
                                    <select id="color14"><option>-</option></select>
                                    <input id="blend14" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>Orange</td>
                                <td>
                                    <select id="color15"><option>-</option></select>
                                    <input id="blend15" type="checkbox"> Glass
                                </td>
                            </tr>
                            <tr>
                                <td>White</td>
                                <td>
                                    <select id="color16"><option>-</option></select>
                                    <input id="blend16" type="checkbox"> Glass
                                </td>
                            </tr>
                            
                        </table>
                    </form><br>
                </td>
                <td class="panel" id="editor">        
                    <canvas id="application-canvas" width="800" height="600"></canvas>
                </td>
                <td class="panel" id="editor_rpanel">
                    <h2>Text Editor: <span id="projectTitle">Unnamed</span></h2>
                    <button onclick="renameProject()">rename</button>
                    <br>
                    <textarea id="editor_text" wrap="off" cols="32" rows="32" onchange="loadFromTextArea()">1</textarea><br>
                    <button onclick="downloadChanges()">Download Changes</button>
                </td>
            </tr>
            <tr>
                <td class="panel" id="edit_bpanel" colspan="3">
                    <h2>Bottom panel</h2>
                    <input type="file" id="file-selector" accept=".plan">
                </td>
            </tr>
        </table>
        
        <script>
            const fileSelector = document.getElementById('file-selector');
            fileSelector.addEventListener('change', (event) => 
            {
                const fileList = event.target.files;
                
                const content = document.getElementById('editor_text');
                const [file] = fileList;
                const reader = new FileReader();

                reader.addEventListener("load", () => 
                {
                    content.value = reader.result.replace(/\r/g, "\n");
                    loadFromTextArea();
                    unsavedChanges = false;
                    
                }, false);

                if (file) {
                  reader.readAsText(file);
                  projectNameField.innerHTML = file.name.split(".")[0];
                  unsavedChanges = false;
                }
                
            });
            
            function downloadChanges()
            {
                const content = document.getElementById('editor_text');

                var planName = projectNameField.innerHTML + ".plan";
                var file = new File([content.value], planName, {type: "text/plain;charset=utf-8"});
                saveAs(file);
                
                unsavedChanges = false;
            }
            
            function renameProject()
            {
                projectNameField.innerHTML = prompt("Rename project", "newName");
                unsavedChanges = true;
            }
            
            var projectNameField = document.getElementById("projectTitle");
            var unsavedChanges = false;
            var canvas = document.getElementById("application-canvas");
            var app = new pc.Application(canvas);
            app.start();
            document.getElementById("versionNumber").innerHTML = "v0.1.0";
                        
            app.setCanvasFillMode(pc.FILLMODE_NONE);
            app.setCanvasResolution(pc.RESOLUTION_AUTO);

            var camera = new pc.Entity();
            camera.addComponent("camera", {
                clearColor: new pc.Color(0.0, 1.0, 1.0)
            });

            app.root.addChild(camera);

            var camerasRX = [-0.26, 0.06,-0.12,-0.77,-0.26];
            var camerasRY = [ 0.37, 0.92,-0.7 , 0.0 , 0.0 ];
            var camerasRZ = [ 0.10, 0.17,-0.12, 0.0 , 0.0 ];
            var camerasRW = [ 0.88,-0.35, 0.7 , 0.63, 0.97];
            
            var camerasPX = [ 45.0,-13.0,-23.0, 9.0 , 0.0 ];
            var camerasPY = [ 32.0, 14.0, 17.0,35.0 ,10.0 ];
            var camerasPZ = [ 45.0,-13.0, 12.0,-2.0 ,10.0 ];

            var eulerAnglesSet = false

            function setCamera(cam)
            {
                camera.setRotation( camerasRX[cam], 
                                    camerasRY[cam], 
                                    camerasRZ[cam], 
                                    camerasRW[cam], 
                                    );
                                    
                camera.setPosition( camerasPX[cam], 
                                    camerasPY[cam], 
                                    camerasPZ[cam]);
                                    
                eulerAnglesSet = false;
            }
            /*function setBackgroundColor(r, g, b)
            {
                camera.camera.clearColor = new pc.Color(r, g, b, 1.0);
            }*/
            function setBackgroundColor(color)
            {
                camera.camera.clearColor = color;
            }

            setCamera(0);

            app.scene.ambientLight = new pc.Color(0.5, 0.5, 0.5);
            var light = new pc.Entity();
            light.addComponent('light');
            app.root.addChild(light);
            light.rotate(45, 0, 0);
            
            var workingPlane = new pc.Entity();
            workingPlane.addComponent("model", { type: "plane" });
            workingPlane.rotate(0, 0, 0);
            workingPlane.setPosition(5, 0, 5);
            workingPlane.setLocalScale(10, 0, 10);
            app.root.addChild(workingPlane);

            function updateWorkingPlane(width, depth)
            {
                var margin = 1;
                workingPlane.setPosition((width + margin) / 2, 0, (depth + margin) / 2);
                workingPlane.setLocalScale((width + margin), 0, (depth + margin));
            }

            function setWorkingPlaneColor(planeMaterial)
            {
                workingPlane.model.model.meshInstances[0].material = planeMaterial;
            }
            
            const viewportSettingsForm = document.getElementById('viewportSettings');
            viewportSettingsForm.addEventListener('change', (event) => 
            {
                const viewportLock              = document.getElementById('viewportLock');
                const viewportRotateSpeed       = document.getElementById('viewportRotateSpeed');
                const viewportMoveSpeed         = document.getElementById('viewportMoveSpeed');
                const viewportZoomSpeed         = document.getElementById('viewportZoomSpeed');
       
                viewportLocked = viewportLock.checked;
                rotateSpeed    = viewportRotateSpeed.value;
                moveSpeed      = viewportMoveSpeed.value;
                zoomModifier   = viewportZoomSpeed.value;

                const viewportBackdrop              = document.getElementById('viewportBackdrop');
                const workingPlaneColor              = document.getElementById('workingPlaneColor');

                switch (viewportBackdrop.value)
                {
                    case "Black":
                        setBackgroundColor(blackMaterial.diffuse);
                        break;
                    case "Red":
                        setBackgroundColor(redMaterial.diffuse);
                        break;
                    case "Green":
                        setBackgroundColor(greenMaterial.diffuse);
                        break;
                    case "Brown":
                        setBackgroundColor(brownMaterial.diffuse);
                        break;
                    case "Blue":
                        setBackgroundColor(blueMaterial.diffuse);
                        break;
                    case "Purple":
                        setBackgroundColor(purpleMaterial.diffuse);
                        break;
                    case "Cyan":
                        setBackgroundColor(cyanMaterial.diffuse);
                        break;
                    case "Light Gray":
                        setBackgroundColor(lightGrayMaterial.diffuse);
                        break;
                    case "Gray":
                        setBackgroundColor(grayMaterial.diffuse);
                        break;
                    case "Pink":
                        setBackgroundColor(pinkMaterial.diffuse);
                        break;
                    case "Lime":
                        setBackgroundColor(limeMaterial.diffuse);
                        break;
                    case "Yellow":
                        setBackgroundColor(yellowMaterial.diffuse);
                        break;
                    case "Light Blue":
                        setBackgroundColor(lightBlueCode.diffuse);
                        break;
                    case "Magenta":
                        setBackgroundColor(magentaMaterial.diffuse);
                        break;
                    case "Orange":
                        setBackgroundColor(orangeMaterial.diffuse);
                        break;
                    case "White":
                        setBackgroundColor(whiteMaterial.diffuse);
                        break;
                }

                switch (workingPlaneColor.value)
                {
                    case "Black":
                        setWorkingPlaneColor(blackMaterial);
                        break;
                    case "Red":
                        setWorkingPlaneColor(redMaterial);
                        break;
                    case "Green":
                        setWorkingPlaneColor(greenMaterial);
                        break;
                    case "Brown":
                        setWorkingPlaneColor(brownMaterial);
                        break;
                    case "Blue":
                        setWorkingPlaneColor(blueMaterial);
                        break;
                    case "Purple":
                        setWorkingPlaneColor(purpleMaterial);
                        break;
                    case "Cyan":
                        setWorkingPlaneColor(cyanMaterial);
                        break;
                    case "Light Gray":
                        setWorkingPlaneColor(lightGrayMaterial);
                        break;
                    case "Gray":
                        setWorkingPlaneColor(grayMaterial);
                        break;
                    case "Pink":
                        setWorkingPlaneColor(pinkMaterial);
                        break;
                    case "Lime":
                        setWorkingPlaneColor(limeMaterial);
                        break;
                    case "Yellow":
                        setWorkingPlaneColor(yellowMaterial);
                        break;
                    case "Light Blue":
                        setWorkingPlaneColor(lightBlueCode);
                        break;
                    case "Magenta":
                        setWorkingPlaneColor(magentaMaterial);
                        break;
                    case "Orange":
                        setWorkingPlaneColor(orangeMaterial);
                        break;
                    case "White":
                        setWorkingPlaneColor(whiteMaterial);
                        break;
                }
            });
            
            const colorSettingsForm = document.getElementById('colorSettings');
            colorSettingsForm.addEventListener('change', (event) => 
            {
                const overridePalette  = document.getElementById('colorOverride');
                const colorPicker      = document.getElementById('overrideMap'); 
                
                if(overridePalette.checked)
                {
                    colorPicker.style.visibility = "visible";
                    
                    const settingBlack          = document.getElementById("color1");
                    const settingRed            = document.getElementById("color2");
                    const settingGreen          = document.getElementById("color3");
                    const settingBrown          = document.getElementById("color4");
                    const settingBlue           = document.getElementById("color5");
                    const settingPurple         = document.getElementById("color6");
                    const settingCyan           = document.getElementById("color7");
                    const settingLightGray      = document.getElementById("color8");
                    const settingGray           = document.getElementById("color9");
                    const settingPink           = document.getElementById("color10"); 
                    const settingLime           = document.getElementById("color11"); 
                    const settingYellow         = document.getElementById("color12"); 
                    const settingLightBlue      = document.getElementById("color13"); 
                    const settingMagenta        = document.getElementById("color14"); 
                    const settingOrange         = document.getElementById("color15");
                    const settingWhite          = document.getElementById("color16");
                    
                    const settingGlassBlack          = document.getElementById("blend1");
                    const settingGlassRed            = document.getElementById("blend2");
                    const settingGlassGreen          = document.getElementById("blend3");
                    const settingGlassBrown          = document.getElementById("blend4");
                    const settingGlassBlue           = document.getElementById("blend5");
                    const settingGlassPurple         = document.getElementById("blend6");
                    const settingGlassCyan           = document.getElementById("blend7");
                    const settingGlassLightGray      = document.getElementById("blend8");
                    const settingGlassGray           = document.getElementById("blend9");
                    const settingGlassPink           = document.getElementById("blend10"); 
                    const settingGlassLime           = document.getElementById("blend11"); 
                    const settingGlassYellow         = document.getElementById("blend12"); 
                    const settingGlassLightBlue      = document.getElementById("blend13"); 
                    const settingGlassMagenta        = document.getElementById("blend14"); 
                    const settingGlassOrange         = document.getElementById("blend15");
                    const settingGlassWhite          = document.getElementById("blend16");
                    
                    //var digitsUsed = [];
                    var uses = [];
                    for(var i = 1; i <= 9; i++)
                    {
                        //digitsUsed[i] = false;
                        uses[i] = 0;
                    }
                    
                    for(var code = 1; code <= 16; code++)
                    {
                        const currentSetting = document.getElementById("color" + code);
                        var value = parseInt(currentSetting.options[currentSetting.selectedIndex].value);
                        
                        if(value >= 1 && value <= 9)
                        {
                            //digitsUsed[value] = true;
                            uses[value]++;
                        }
                    }
                    
                    //TODO add none option to all preselected colors
                    //Check over codes again
                    //  add each digit with uses === 0 as an option
                    //  if uses > 1, remove as an option, decrement
                    for(var code = 1; code <= 16; code++)
                    {
                        var currentSetting = document.getElementById("color" + code);
                        
                        for(var digit = 1; digit <= 9; digit++)
                        {
                            if(uses[digit] === 0)
                            {
                                //add as an option
                                //console.log("Adding " + digit + " as an option to color" + code);
                                var alreadyAdded = false;
                                
                                for(var option of currentSetting.options)
                                {
                                    if(parseInt(option.value) === digit)
                                    {
                                        alreadyAdded = true;
                                    }
                                }
                                
                                if(!alreadyAdded)
                                {
                                    var opt = document.createElement('option');
                                    opt.value = digit;
                                    opt.innerHTML = digit;
                                    currentSetting.appendChild(opt);   //TODO insertBefore over append to keep numbers in order
                                }
                            } 
                            else if(uses[digit] > 1)
                            {
                                //try to remove as an option
                                //set to -
                                for(var option of currentSetting.options)
                                {
                                    if(parseInt(option.value) === digit)
                                    {
                                        //decrement uses
                                        uses[digit]--;
                                        
                                        option.remove();
                                    }
                                }
                        
                            }
                        }
                    }
                      
                    //Assign color codes
                    var unusableCodes = 20;
                    
                    const forBlack = parseInt(settingBlack.options[settingBlack.selectedIndex].value);
                    blackCode = Number.isNaN(forBlack) ? unusableCodes++ : forBlack;
                    blackMaterial.blendType = settingGlassBlack.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forRed = parseInt(settingRed.options[settingRed.selectedIndex].value);
                    redCode = Number.isNaN(forRed) ? unusableCodes++ : forRed;
                    redMaterial.blendType = settingGlassRed.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forGreen = parseInt(settingGreen.options[settingGreen.selectedIndex].value);
                    greenCode = Number.isNaN(forGreen) ? unusableCodes++ : forGreen;
                    greenMaterial.blendType = settingGlassGreen.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forBrown = parseInt(settingBrown.options[settingBrown.selectedIndex].value);
                    brownCode = Number.isNaN(forBrown) ? unusableCodes++ : forBrown;
                    brownMaterial.blendType = settingGlassBrown.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forBlue = parseInt(settingBlue.options[settingBlue.selectedIndex].value);
                    blueCode = Number.isNaN(forBlue) ? unusableCodes++ : forBlue;
                    blueMaterial.blendType = settingGlassBlue.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forPurple = parseInt(settingPurple.options[settingPurple.selectedIndex].value);
                    purpleCode = Number.isNaN(forPurple) ? unusableCodes++ : forPurple;
                    purpleMaterial.blendType = settingGlassPurple.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forCyan = parseInt(settingCyan.options[settingCyan.selectedIndex].value);
                    cyanCode = Number.isNaN(forCyan) ? unusableCodes++ : forCyan;
                    cyanMaterial.blendType = settingGlassCyan.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forLightGray = parseInt(settingLightGray.options[settingLightGray.selectedIndex].value);
                    lightGrayCode = Number.isNaN(forLightGray) ? unusableCodes++ : forLightGray;
                    lightGrayMaterial.blendType = settingGlassLightGray.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forGray = parseInt(settingGray.options[settingGray.selectedIndex].value);
                    grayCode = Number.isNaN(forGray) ? unusableCodes++ : forGray;
                    grayMaterial.blendType = settingGlassGray.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forPink = parseInt(settingPink.options[settingPink.selectedIndex].value);
                    pinkCode = Number.isNaN(forPink) ? unusableCodes++ : forPink;
                    pinkMaterial.blendType = settingGlassPink.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forLime = parseInt(settingLime.options[settingLime.selectedIndex].value);
                    limeCode = Number.isNaN(forLime) ? unusableCodes++ : forLime;
                    limeMaterial.blendType = settingGlassLime.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forYellow = parseInt(settingYellow.options[settingYellow.selectedIndex].value);
                    yellowCode = Number.isNaN(forYellow) ? unusableCodes++ : forYellow;
                    yellowMaterial.blendType = settingGlassYellow.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forLightBlue = parseInt(settingLightBlue.options[settingLightBlue.selectedIndex].value);
                    lightBlueCode = Number.isNaN(forLightBlue) ? unusableCodes++ : forLightBlue;
                    lightBlueMaterial.blendType = settingGlassLightBlue.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forMagenta = parseInt(settingMagenta.options[settingMagenta.selectedIndex].value);
                    magentaCode = Number.isNaN(forMagenta) ? unusableCodes++ : forMagenta;
                    magentaMaterial.blendType = settingGlassMagenta.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forOrange = parseInt(settingOrange.options[settingOrange.selectedIndex].value);
                    orangeCode = Number.isNaN(forOrange) ? unusableCodes++ : forOrange;
                    orangeMaterial.blendType = settingGlassOrange.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                    const forWhite = parseInt(settingWhite.options[settingWhite.selectedIndex].value);
                    whiteCode = Number.isNaN(forWhite) ? unusableCodes++ : forWhite;
                    whiteMaterial.blendType = settingGlassWhite.checked ? pc.BLEND_NORMAL : pc.BLEND_NONE; 
                    
                }
                else
                {
                    colorPicker.style.visibility = "hidden";
                    
                    blackCode = 20; //oops
                    redCode = 1;
                    greenCode = 2;
                    brownCode = 3;
                    blueCode = 4;
                    purpleCode = 5;
                    cyanCode = 6;
                    lightGrayCode = 7;
                    grayCode = 8;
                    pinkCode = 9;
                    limeCode = 10;
                    yellowCode = 11;
                    lightBlueCode = 12;
                    magentaCode = 13;
                    orangeCode = 14;
                    whiteCode = 15;
                    
                }
                
                loadFromTextArea(); //Rebuild once color codes are changed
            });
            //Camera and scene initialized
    
            //Returns a matrix of the given size, initialized to 0
            function generateMatrix(width, height, depth)
            {
                var output = [];

                for (var i = 0; i < depth; i++)
                {
                    output.push([]);
                    for (var j = 0; j < height; j++)
                    {
                        output[i].push([]);
                        for (var k = 0; k < width; k++)
                        {
                            output[i][j].push(0);
                        }
                    }
                }

                return output;
            }

            //Copies all values from first into second
            function transferMatrices(first, fWidth, fHeight, fDepth, second)
            {
                for (var i = 0; i < fWidth; i++)
                {
                    for (var j = 0; j < fHeight; j++)
                    {
                        for (var k = 0; k < fDepth; k++)
                        {
                            //console.log("setting [" + second[i][j][k] + "] at " + i + ", " +  j + ", " +  k + ", " + 
                            //        "to [" + first[i][j][k] + "] at " + i + ", " +  j + ", " +  k + ", ");
                            second[i][j][k] = first[i][j][k];
                        }
                    }
                }
            }

            function resize(fwidth, fheight, fdepth)
            {
                console.log("Matrix BEFORE reassignment:");
                console.log(matrix);

                matrixBuffer = generateMatrix(width, height, depth);
                transferMatrices(matrix, fwidth, fheight, fdepth, matrixBuffer);

                matrix = generateMatrix(width, height, depth);
                console.log("Matrix has been reassigned:");
                console.log(matrix);
                matrix = Array.from(matrixBuffer);

                updateWorkingPlane(width, depth);
            }
            
            function clearMatrix(matrix)
            {
                for(var x = 0; x < depth; x++)
                {
                    for(var y = 0; y < height; y++)
                    {
                        for(var z = 0; z < width; z++)
                        {
                            matrix[x][y][z] = 0;
                        }
                    }
                }
            }
            
            //Initialize matrix
            let width = 64;
            let height = 100; 
            let depth = 64; 

            let matrix = generateMatrix(width, height, depth);
            let matrixBuffer = generateMatrix(width, height, depth);
            
            function loadFromTextArea()
            {
                for(var x = 0; x < depth; x++)
                {
                    for(var y = 0; y < height; y++)
                    {
                        for(var z = 0; z < width; z++)
                        {
                            
                            if(typeof(matrix[z][y][x]) !== "number")
                            {
                                if(matrix[z][y][x].b !== 0)
                                {
                                    try
                                    {
                                        matrix[z][y][x].e.destroy();
                                    }
                                    catch (error)
                                    {
                                        console.error(error);
                                    }
                                }
                            }
                        }
                    }
                }
                
                const content = document.getElementById('editor_text');
                
                var lx = 0; //Width
                var ly = 0; //Height
                var lz = 0; //Depth
                
                var layers = [];
                layers = content.value.split("#");
                
                for(const layer of layers)
                {
                    var rows = [];
                    rows = layer.split("\n");
                    
                    for(const row of rows)
                    {
                        if(row !== "") //Checking for excess whitespace
                        {
                            var blocks = [];
                            blocks = row.split("");
                            
                            for(const block of blocks)
                            {
                                if(block !== "") //Checking for excess whitespace
                                {
                                    addBlock(lx, ly, lz, parseInt(block));
                                    
                                    lx++;
                                }
                            }
                            lx = 0;
                            lz++;
                        }
                        
                    }
                    lx = 0;
                    ly++;
                    lz = 0;
                }
                unsavedChanges = true;
            }

            
            updateWorkingPlane(width, depth);

            class Block 
            {
                constructor(x, y, z, b)
                {
                    this.x = x;
                    this.y = y;
                    this.z = z;
                    this.b = b;
                    
                    if(b > 0)
                    {
                        var e = new pc.Entity();
                        e.addComponent("model", { type: "box", isStatic: true });
                        
                        switch (b) {
                            case blackCode:
                                e.model.model.meshInstances[0].material = blackMaterial;
                                break;
                            case redCode:
                                e.model.model.meshInstances[0].material = redMaterial;
                                break;
                            case greenCode:
                                e.model.model.meshInstances[0].material = greenMaterial;
                                break;
                            case brownCode:
                                e.model.model.meshInstances[0].material = brownMaterial;
                                break;
                            case blueCode:
                                e.model.model.meshInstances[0].material = blueMaterial;
                                break;
                            case purpleCode:
                                e.model.model.meshInstances[0].material = purpleMaterial;
                                break;
                            case cyanCode:
                                e.model.model.meshInstances[0].material = cyanMaterial;
                                break;
                            case lightGrayCode:
                                e.model.model.meshInstances[0].material = lightGrayMaterial;
                                break;
                            case grayCode:
                                e.model.model.meshInstances[0].material = grayMaterial;
                                break;
                            case pinkCode:
                                e.model.model.meshInstances[0].material = pinkMaterial;
                                break;
                            case limeCode:
                                e.model.model.meshInstances[0].material = limeMaterial;
                                break;
                            case yellowCode:
                                e.model.model.meshInstances[0].material = yellowMaterial;
                                break;
                            case lightBlueCode:
                                e.model.model.meshInstances[0].material = lightBlueMaterial;
                                break;
                            case magentaCode:
                                e.model.model.meshInstances[0].material = magentaMaterial;
                                break;
                            case orangeCode:
                                e.model.model.meshInstances[0].material = orangeMaterial;
                                break;
                            case whiteCode:
                                e.model.model.meshInstances[0].material = whiteMaterial;
                                break;
                            default:
                                e.model.model.meshInstances[0].material = whiteMaterial;
                        }

                        app.root.addChild(e);
                        e.setPosition(x + 0.5, y + 0.5, z + 0.5);
                        e.setLocalScale(0.99, 0.99, 0.99);

                        this.e = e;
                    }
                }
            }

            function addBlock(x, y, z, b)
            {   
                var toAdd = new Block(x, y, z, b);

                var resize = false;
                var fwidth = width;
                var fheight = height;
                var fdepth = depth;
                if(x > width)
                {
                    resize = true;
                    //width = x;
                }
                if(y > height)
                {
                    resize = true;
                    //height = y;
                }
                if(z > depth)
                {
                    resize = true;
                    //depth = z;
                }

                if (resize) 
                {    
                    //resize(fwidth, fheight, fdepth);
                    console.log("Resizing is still broken. Sorry.");
                }
                else
                {
                    if(typeof(matrix[z][y][x]) !== "number")
                    {
                        if(matrix[z][y][x].b !== 0)
                        {
                            matrix[z][y][x].e.destroy();
                        }
                    }

                    matrix[z][y][x] = toAdd;   
                }
            }
    
            loadFromTextArea();
            
            for (var z = 0; z < matrix.length; z++)
            {
                for (var y = 0; y < matrix[z].length; y++)
                {
                    for (var x = 0; x < matrix[z][y].length; x++)
                    {
                        //Check if there is a block in the first place
                        if (matrix[z][y][x] === 0)
                        {
                            //There is NOT A block here
                        }
                        else
                        {
                            //There is a block here
                        }
                    }
                }
            }

            var viewportLocked;
            var rotateSpeed = 0.1;
            var moveSpeed = 0.05;
            var zoomModifier = 5;

            //Viewport Controls
            
            {
                const mouse = new pc.Mouse(document.body);
                mouse.disableContextMenu();

                const keyboard = new pc.Keyboard(document.body);

                var x = 0;
                var y = 0;

                mouse.on("mousemove", function (event) {
                    if (event.buttons[pc.MOUSEBUTTON_LEFT] && !viewportLocked)
                    {
                        x += event.dx;
                        y += event.dy;

                        camera.setLocalEulerAngles(rotateSpeed * y, rotateSpeed * x, 0);
                        
                        if(!eulerAnglesSet && false) //Shelved this, was going to just spin the camera until the right angle was found
                        {
                            var startRotation = camera.rotation;
                            var margin = 10;
                            var steps = 0;
                                
                            while   (
                                    Math.abs(camera.rotation.x - startRotation.x <= margin &&
                                    steps < 20)
                                    )
                            {
                                x += 1;
                                y += 1;
                                steps++;
                                camera.setLocalEulerAngles(rotateSpeed * y, rotateSpeed * x, 0);
                                
                                console.log("x is " + x + " and y is " + y);
                                console.log("after set new rotation:");
                                console.log(camera.rotation.x);
                                
                            }
                            
                            eulerAnglesSet = true;
                        }
                        
                        
                        /*
                        x += event.dx;
                        y += event.dy;

                        var ex = rotateSpeed * y;
                        var ey = rotateSpeed * x;
                        var ez = 0;
                        
                        var sx, cx, sy, cy, sz, cz, halfToRad;

                        halfToRad = 0.5 * pc.math.DEG_TO_RAD;
                        ex *= halfToRad;
                        ey *= halfToRad;
                        ez *= halfToRad;

                        sx = Math.sin(ex);
                        cx = Math.cos(ex);
                        sy = Math.sin(ey);
                        cy = Math.cos(ey);
                        sz = Math.sin(ez);
                        cz = Math.cos(ez);

                        camera.rotation.x = sx * cy * cz - cx * sy * sz;
                        camera.rotation.y = cx * sy * cz + sx * cy * sz;
                        camera.rotation.z = cx * cy * sz - sx * sy * cz;
                        camera.rotation.w = cx * cy * cz + sx * sy * sz;
            */
                    }
                });
                mouse.on("mousewheel", function (event) {

                    if(!viewportLocked)
                    {                    
                        camera.translateLocal(0, 0, moveSpeed * event.wheelDelta * zoomModifier);
                    }
                });

                var onKeyDown = function (e) 
                {   
                    var digit = e.key - pc.KEY_0;
                    if(0 <= digit && digit < 10 && !viewportLocked)
                    { 
                        if (keyboard.isPressed(pc.KEY_SHIFT)) 
                        {
                            //Set a camera angle
                            console.log("Setting camera angle " + digit + " to:");

                            var rX = camera.rotation.x;
                            var rY = camera.rotation.y;
                            var rZ = camera.rotation.z;
                            var rW = camera.rotation.w;

                            console.log([rX, rY, rZ, rW]);

                            var pX = camera.position.x;
                            var pY = camera.position.y;
                            var pZ = camera.position.z;

                            console.log([pX, pY, pZ]);

                            camerasRX[digit] = camera.rotation.x;
                            camerasRY[digit] = camera.rotation.y;
                            camerasRZ[digit] = camera.rotation.z;
                            camerasRW[digit] = camera.rotation.w;

                            camerasPX[digit] = camera.position.x;
                            camerasPY[digit] = camera.position.y;
                            camerasPZ[digit] = camera.position.z;

                        }
                        else
                        {   
                            //Pick a camera angle
                            setCamera(digit);
                            
                            //TODO update x and y to some euler angles?
                        }
                    }


                    //e.event.preventDefault(); // Use original browser event to prevent browser action.
                };
                keyboard.on("keydown", onKeyDown, this);

                app.on("update", function () 
                {
                
                    if(unsavedChanges && !projectNameField.classList.contains("unsaved"))
                    {
                        projectNameField.classList.remove("saved");
                        projectNameField.classList.add("unsaved");
                    }

                    if(!unsavedChanges && projectNameField.classList.contains("unsaved"))
                    {
                        projectNameField.classList.remove("unsaved");
                        projectNameField.classList.add("saved");
                    }

                    if (keyboard.isPressed(pc.KEY_SHIFT))   //Shift held
                    {
                        //Move camera up/down global
                        if (keyboard.isPressed(pc.KEY_W) && !viewportLocked) {
                            camera.translate(0, 0.05, 0); //TODO no idea why this breaks when setting by slider
                        }
                        if (keyboard.isPressed(pc.KEY_S) && !viewportLocked) {
                            camera.translate(0, -moveSpeed, 0);
                        }
                    }
                    else                                    //Shift up
                    {
                        //Move camera up/down local
                        if (keyboard.isPressed(pc.KEY_W) && !viewportLocked) {
                            camera.translateLocal(0, 0, -moveSpeed);
                        }
                        if (keyboard.isPressed(pc.KEY_S) && !viewportLocked) {
                            camera.translateLocal(0, 0, moveSpeed);
                        }
                    }
                    if (keyboard.isPressed(pc.KEY_UP) && !viewportLocked) {
                        camera.rotate(rotateSpeed, 0, 0);
                    }
                    if (keyboard.isPressed(pc.KEY_DOWN) && !viewportLocked) {
                        camera.rotate(-rotateSpeed, 0, 0);
                    }
                    if (keyboard.isPressed(pc.KEY_LEFT) && !viewportLocked) {
                        camera.rotate(0, rotateSpeed, 0);
                    }
                    if (keyboard.isPressed(pc.KEY_RIGHT) && !viewportLocked) {
                        camera.rotate(0, -rotateSpeed, 0);
                    }
                    if (keyboard.isPressed(pc.KEY_A) && !viewportLocked) {
                        camera.translateLocal(-moveSpeed, 0, 0);
                    }
                    if (keyboard.isPressed(pc.KEY_D) && !viewportLocked) {
                        camera.translateLocal(moveSpeed, 0, 0);
                    }
                });
            }

            /* Used playcanvas example update function
            let time = 0;
            let step = 0;
            
            app.on("update", function (dt) 
            {
                time += dt; 
                step += 1;
                
                if(dt >= 0.25)
                {
                    time = 0;
                }
                
                /* Show active bodies in red and frozen bodies in gray
                app.root.findComponents("rigidbody").forEach(function (body) 
                {
                    body.entity.findComponents("render").forEach(function (render) {
                        render.material = body.isActive() ? red : gray;
                    });
                }); /
            });*/

        </script>
    </body>
</html>
